<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"levertsui.github.io","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="要有狮子的力量， 菩萨的心肠">
<meta property="og:type" content="website">
<meta property="og:title" content="leverTsui">
<meta property="og:url" content="https://levertsui.github.io/index.html">
<meta property="og:site_name" content="leverTsui">
<meta property="og:description" content="要有狮子的力量， 菩萨的心肠">
<meta property="og:locale">
<meta property="article:author" content="leverTsui">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://levertsui.github.io/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-Hans'
  };
</script>

  <title>leverTsui</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">leverTsui</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">要有狮子的力量， 菩萨的心肠</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-schedule">

    <a href="/schedule/" rel="section"><i class="fa fa-calendar fa-fw"></i>日程表</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://levertsui.github.io/2018/12/03/autoreleasepool%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="leverTsui">
      <meta itemprop="description" content="要有狮子的力量， 菩萨的心肠">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="leverTsui">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/12/03/autoreleasepool%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/" class="post-title-link" itemprop="url">autoreleasepool实现原理</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-12-03 20:46:28" itemprop="dateCreated datePublished" datetime="2018-12-03T20:46:28+08:00">2018-12-03</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-02-08 09:46:16" itemprop="dateModified" datetime="2022-02-08T09:46:16+08:00">2022-02-08</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/iOS-%E6%8A%80%E5%B7%A7/" itemprop="url" rel="index"><span itemprop="name">iOS 技巧</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>main.m中包含的代码如下所示,使用 clang -rewrite-objc 命令将下面的 Objective-C 代码重写成 C++ 代码：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</span><br><span class="line">    <span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;Hello, World!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>将会得到以下输出结果：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> __declspec(dllimport) <span class="keyword">void</span> * objc_autoreleasePoolPush(<span class="keyword">void</span>);</span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> __declspec(dllimport) <span class="keyword">void</span> objc_autoreleasePoolPop(<span class="keyword">void</span> *);</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> __AtAutoreleasePool &#123;</span><br><span class="line">    __AtAutoreleasePool() &#123;atautoreleasepoolobj = objc_autoreleasePoolPush();&#125;</span><br><span class="line">    ~__AtAutoreleasePool() &#123;objc_autoreleasePoolPop(atautoreleasepoolobj);&#125;</span><br><span class="line">    <span class="keyword">void</span> * atautoreleasepoolobj;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</span><br><span class="line">    <span class="comment">/* @autoreleasepool */</span> &#123; __AtAutoreleasePool __autoreleasepool; </span><br><span class="line"></span><br><span class="line">        <span class="built_in">NSLog</span>((<span class="built_in">NSString</span> *)&amp;__NSConstantStringImpl__var_folders_x__wh4dgr654mx__qc0b9bqyg5w0000gn_T_main_826771_mi_0);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过声明一个 <code>__AtAutoreleasePool</code> 类型的局部变量 <code>__autoreleasepool</code> 来实现 <code>@autoreleasepool &#123;&#125;</code> 。当声明 <code>__autoreleasepool</code> 变量时，构造函数 <code>__AtAutoreleasePool()</code> 被调用，即执行 <code>atautoreleasepoolobj = objc_autoreleasePoolPush()</code>; ；当出了当前作用域时，析构函数 <code>~__AtAutoreleasePool()</code> 被调用，即执行 <code>objc_autoreleasePoolPop(atautoreleasepoolobj)</code>; 。也就是说 <code>@autoreleasepool &#123;&#125;</code> 的实现代码可以进一步简化如下：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* @autoreleasepool */</span> &#123;</span><br><span class="line">    <span class="keyword">void</span> *atautoreleasepoolobj = objc_autoreleasePoolPush();</span><br><span class="line">    <span class="comment">// 用户代码，所有接收到 autorelease 消息的对象会被添加到这个 autoreleasepool 中</span></span><br><span class="line">    objc_autoreleasePoolPop(atautoreleasepoolobj);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://levertsui.github.io/2018/07/13/%E8%AF%BB%E3%80%8A%E5%A4%A7%E8%AF%9D%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E3%80%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="leverTsui">
      <meta itemprop="description" content="要有狮子的力量， 菩萨的心肠">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="leverTsui">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/07/13/%E8%AF%BB%E3%80%8A%E5%A4%A7%E8%AF%9D%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E3%80%8B/" class="post-title-link" itemprop="url">读《大话设计模式》</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-07-13 20:42:00" itemprop="dateCreated datePublished" datetime="2018-07-13T20:42:00+08:00">2018-07-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-02-08 09:46:16" itemprop="dateModified" datetime="2022-02-08T09:46:16+08:00">2022-02-08</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">设计模式 开发</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>对设计模式的理解，不够透彻，有时去找资料，总是零零散散，不成系统，故将《大话设计模式》中的干货整理下，方便需要使用时可以参考使用。</p>
<h2 id="设计模式六大原则"><a href="#设计模式六大原则" class="headerlink" title="设计模式六大原则"></a>设计模式六大原则</h2><h3 id="单一职责原则"><a href="#单一职责原则" class="headerlink" title="单一职责原则"></a>单一职责原则</h3><ul>
<li>定义：就一个类而言，应该仅有一个引起它变化的原因。通俗的说，即一个类只负责一项职责。<br>问题由来：类T负责两个不同的职责：职责P1，职责P2。当由于职责P1需求发生改变而需要修改类T时，有可能会导致原本运行正常的职责P2功能发生故障。</li>
<li>解决方案：遵循单一职责原则。分别建立两个类T1、T2，使T1完成职责P1功能，T2完成职责P2功能。这样，当修改类T1时，不会使职责P2发生故障风险；同理，当修改T2时，也不会使职责P1发生故障风险。</li>
<li>最佳实践：<ul>
<li>可以降低类的复杂度，一个类只负责一项职责，其逻辑肯定要比负责多项职责简单的多；</li>
<li>提高类的可读性，提高系统的可维护性；</li>
<li>降低需求变更引起的风险。</li>
</ul>
</li>
</ul>
<h3 id="里氏替换原则"><a href="#里氏替换原则" class="headerlink" title="里氏替换原则"></a>里氏替换原则</h3><ul>
<li>定义：子类型必须能够替换掉它们的父类型。</li>
<li>问题由来：有一功能P1，由类A完成。现需要将功能P1进行扩展，扩展后的功能为P，其中P由原有功能P1与新功能P2组成。新功能P由类A的子类B来完成，则子类B在完成新功能P2的同时，有可能会导致原有功能P1发生故障。</li>
<li>解决方案：当使用继承时，遵循里氏替换原则。类B继承类A时，除添加新的方法完成新增功能P2外，尽量不要重写父类A的方法，也尽量不要重载父类A的方法。</li>
</ul>
<h3 id="依赖倒转原则"><a href="#依赖倒转原则" class="headerlink" title="依赖倒转原则"></a>依赖倒转原则</h3><ul>
<li>定义：A.高层模块不应该依赖底层模块。两者都应该依赖抽象。B.抽象不应该依赖细节。细节应该依赖抽象。通俗理解：针对接口编程，不要针对实现编程。</li>
<li>问题由来：类A直接依赖类B，假如要将类A改为依赖类C，则必须通过修改类A的代码来达成。这种场景下，类A一般是高层模块，负责复杂的业务逻辑；类B和类C是低层模块，负责基本的原子操作；假如修改类A，会给程序带来不必要的风险。</li>
<li>解决方案：将类A修改为依赖接口I，类B和类C各自实现接口I，类A通过接口I间接与类B或者类C发生联系，则会大大降低修改类A的几率。</li>
<li>最佳实践：<ul>
<li>低层模块尽量都要有抽象类或接口，或者抽象类或接口两者都具备。</li>
<li>变量的声明类型尽量是抽象类或接口。</li>
<li>使用继承时遵循里氏替换原则。</li>
</ul>
</li>
</ul>
<h3 id="接口隔离原则"><a href="#接口隔离原则" class="headerlink" title="接口隔离原则"></a>接口隔离原则</h3><ul>
<li>定义：一个类对另一个类的依赖，应该建立在最小的接口上。</li>
<li>问题由来：类A通过接口I依赖类B，类C通过接口I依赖类D，如果接口I对于类A和类B来说不是最小接口，则类B和类D必须去实现他们不需要的方法。</li>
<li>解决方案：将臃肿的接口I拆分为独立的几个接口，类A和类C分别与他们需要的接口建立依赖关系。也就是采用接口隔离原则。<br><img src="/images/design_pattern_un_isolate_port.png" alt="未遵循接口隔离原则的设计"><br><img src="/images/design_pattern_solate_port.png" alt="遵循接口隔离原则的设计"></li>
<li>最佳实践：<ul>
<li>接口尽量小，但是要有限度。对接口进行细化可以提高程序设计灵活性是不挣的事实，但是如果过小，则会造成接口数量过多，使设计复杂化。所以一定要适度；</li>
<li>为依赖接口的类定制服务，只暴露给调用的类它需要的方法，它不需要的方法则隐藏起来。只有专注地为一个模块提供定制服务，才能建立最小的依赖关系；</li>
<li>提高内聚，减少对外交互。使接口用最少的方法去完成最多的事情；</li>
<li>适度使用，接口设计的过大或过小都不好。</li>
</ul>
</li>
</ul>
<h3 id="迪米特法则"><a href="#迪米特法则" class="headerlink" title="迪米特法则"></a>迪米特法则</h3><ul>
<li>定义：又叫最少知道原则，如果两个类不必彼此直接通信，那么这两个类就不应当发生直接的相互作用。如果其中一个类需要调用另一个类的某一个方法的话，可以通过第三者转发这个调用。<br>   一个对象应该对其他对象保持最少的了解。</li>
<li>问题由来：类与类之间的关系越密切，耦合度越大，当一个类发生改变时，对另一个类的影响也越大。</li>
<li>最佳实践：尽量降低类与类之间的耦合。可以通过第三者来进行通信。</li>
</ul>
<h3 id="开放-封闭原则"><a href="#开放-封闭原则" class="headerlink" title="开放-封闭原则"></a>开放-封闭原则</h3><ul>
<li>定义：软件实体（类、模块、函数等等）应该可以扩展，但是不可修改。</li>
<li>问题由来：在软件的生命周期内，因为变化、升级和维护等原因需要对软件原有代码进行修改时，可能会给旧代码中引入错误，也可能会使我们不得不对整个功能进行重构，并且需要原有代码经过重新测试。</li>
<li>解决方案：当软件需要变化时，尽量通过扩展软件实体的行为来实现变化，而不是通过修改已有的代码来实现变化。</li>
</ul>
<h3 id="六大原则总结"><a href="#六大原则总结" class="headerlink" title="六大原则总结"></a>六大原则总结</h3><p>用抽象构建框架，用实现扩展细节。</p>
<ul>
<li>单一职责原则告诉我们实现类要职责单一；</li>
<li>里氏替换原则告诉我们不要破坏继承体系；</li>
<li>依赖倒置原则告诉我们要面向接口编程；</li>
<li>接口隔离原则告诉我们在设计接口的时候要精简单一；</li>
<li>迪米特法则告诉我们要降低耦合。</li>
<li>而开闭原则是总纲，它告诉我们要对扩展开放，对修改关闭。</li>
</ul>
<p><a target="_blank" rel="noopener" href="http://www.uml.org.cn/sjms/201211023.asp#4">设计模式六大原则</a>  </p>
<h2 id="UML基础知识"><a href="#UML基础知识" class="headerlink" title="UML基础知识"></a>UML基础知识</h2><p><img src="/images/design_pattern_uml.png" alt="UML类图图示"></p>
<h3 id="类与类之间的关系"><a href="#类与类之间的关系" class="headerlink" title="类与类之间的关系"></a>类与类之间的关系</h3><ul>
<li>泛化：是一种继承关系，表示一般与特殊的关系，存在于父类与子类、父接口与子接口之间，表示子类如何特<br> 化父类的所有特征和行为，比如动物和鸟之间的关系；</li>
<li>实现：一种类与接口的关系，表示类对接口所有特征和行为的实现，比如大雁与接口飞翔的关系；</li>
<li>组合：是一种强的‘拥有’关系，体现了严格的整体和部分的关系，部分和整体的生命周期一样，比如鸟与翅膀的关系；</li>
<li>聚合：是一种弱的‘拥有’关系，体现的是A对象可以包含B对象，但B对象不是A对象的一部分，比如雁群和大雁的关系；</li>
<li>关联：描述了类与类之间的结构化关系，具有方向、名字、角色和多重性等信息，是一种拥有的关<br>系，它使一个类知道另一个类的属性和方法，比如企鹅与气候的关系，人与住址的关系；</li>
<li>依赖：是一种使用关系，特定事物的改变有可能会影响到使用该事物的其他事物，表示一个事<br>物使用另一个事物时使用依赖关系。大多数情况下，依赖关系体现在某个类的方法使用另一个类的对象作为参数。<br>1、将一个类的对象作为另一个类中方法的参数<br>2、在一个类的方法中将另一个类的对象作为其局部变量<br>3、在一个类的方法中调用另一个类的静态方法。</li>
</ul>
<p>各种关系的强弱顺序：<br>泛化 &#x3D; 实现 &gt; 组合 &gt; 聚合 &gt; 关联 &gt; 依赖</p>
<h2 id="常用的23中设计模式"><a href="#常用的23中设计模式" class="headerlink" title="常用的23中设计模式"></a>常用的23中设计模式</h2><h3 id="创建型模式"><a href="#创建型模式" class="headerlink" title="创建型模式"></a>创建型模式</h3><h4 id="简单工厂模式"><a href="#简单工厂模式" class="headerlink" title="简单工厂模式"></a>简单工厂模式</h4><h5 id="模式动机"><a href="#模式动机" class="headerlink" title="模式动机"></a>模式动机</h5><p>考虑一个简单的软件应用场景，一个计算器有不同的按钮（如+、-、*、÷）， 这些按钮都源自同一个基类，不过在继承基类后不同的子类修改了部分属性从而使得它们可以完成不同的功能，如果我们希望在使用这些按钮时，不需要知道这些具体按钮类的名字，只需要知道表示该按钮类的一个参数，并提供一个调用方便的方法，把该参数传入方法即可返回一个相应的按钮对象，此时，就可以使用简单工厂模式。</p>
<h5 id="模式定义"><a href="#模式定义" class="headerlink" title="模式定义"></a>模式定义</h5><p>简单工厂模式(Simple Factory Pattern)：它属于类创建型模式。在简单工厂模式中，可以根据参数的不同返回不同类的实例。简单工厂模式专门定义一个类来负责创建其他类的实例，被创建的实例通常都具有共同的父类。</p>
<h5 id="模式结构"><a href="#模式结构" class="headerlink" title="模式结构"></a>模式结构</h5><p>简单工厂模式包含如下角色：</p>
<ul>
<li>HCDCalcuteFactory：工厂角色<br>工厂角色负责实现创建所有实例的内部逻辑</li>
<li>HCDCalculate：抽象产品角色<br>抽象产品角色是所创建的所有对象的父类，负责描述所有实例所共有的公共接口</li>
<li>HCDCalculateAdd：具体产品角色<br>具体产品角色是创建目标，所有创建的对象都充当这个角色的某个具体类的实例。</li>
</ul>
<p><img src="/images/design_simple-factory-class.png" alt="简单工厂模式类图"></p>
<h5 id="时序图"><a href="#时序图" class="headerlink" title="时序图"></a>时序图</h5><p><img src="/images/design_simple-factory-class-sequence.png" alt="简单工厂模式时序图"></p>
<h5 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h5><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//HCDCalculateProtocol.h</span></span><br><span class="line"><span class="meta">#import <span class="string">&lt;Foundation/Foundation.h&gt;</span></span></span><br><span class="line"><span class="meta">#import <span class="string">&lt;UIKit/UIKit.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="built_in">NS_ENUM</span>(<span class="built_in">NSInteger</span>, HCDCalculateType) &#123;</span><br><span class="line">    HCDCalculateTypeAdd = <span class="number">0</span>,   <span class="comment">//加</span></span><br><span class="line">    HCDCalculateTypeMinus,     <span class="comment">//减</span></span><br><span class="line">    HCDCalculateTypeMultipy,   <span class="comment">//乘</span></span><br><span class="line">    HCDCalculateTypeDivide     <span class="comment">//除</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@protocol</span> <span class="title">HCDCalculateProtocol</span> &lt;<span class="title">NSObject</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@optional</span></span><br><span class="line">-(<span class="built_in">CGFloat</span>)calculate;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//HCDCalculate.h</span></span><br><span class="line"><span class="meta">#import <span class="string">&lt;Foundation/Foundation.h&gt;</span></span></span><br><span class="line"><span class="meta">#import <span class="string">&lt;UIKit/UIKit.h&gt;</span></span></span><br><span class="line"><span class="meta">#import <span class="string">&quot;HCDCalculateProtocol.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">HCDCalculate</span> : <span class="title">NSObject</span> &lt;<span class="title">HCDCalculateProtocol</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">CGFloat</span> numberA;</span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">CGFloat</span> numberB;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//HCDCalcuteFactory.h</span></span><br><span class="line"><span class="meta">#import <span class="string">&lt;Foundation/Foundation.h&gt;</span></span></span><br><span class="line"><span class="meta">#import <span class="string">&quot;HCDCalculate.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">HCDCalcuteFactory</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line">+(HCDCalculate *)createCalcute:(<span class="built_in">NSString</span> *)calculatetype;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//HCDCalcuteFactory.m</span></span><br><span class="line"><span class="meta">#import <span class="string">&quot;HCDCalcuteFactory.h&quot;</span></span></span><br><span class="line"><span class="meta">#import <span class="string">&quot;HCDCalculateAdd.h&quot;</span></span></span><br><span class="line"><span class="meta">#import <span class="string">&quot;HCDCalculateDivide.h&quot;</span></span></span><br><span class="line"><span class="meta">#import <span class="string">&quot;HCDCalculateMinus.h&quot;</span></span></span><br><span class="line"><span class="meta">#import <span class="string">&quot;HCDCalcuteMultiply.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">HCDCalcuteFactory</span></span></span><br><span class="line"></span><br><span class="line">+(HCDCalculate *)createCalcute:(<span class="built_in">NSString</span> *)calculatetype &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSArray</span> *calculateArray = @[<span class="string">@&quot;+&quot;</span>,<span class="string">@&quot;-&quot;</span>,<span class="string">@&quot;*&quot;</span>,<span class="string">@&quot;/&quot;</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (![calculateArray containsObject:calculatetype]) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    HCDCalculateType calType = [calculateArray indexOfObject:calculatetype];</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">switch</span> (calType) &#123;</span><br><span class="line">        <span class="keyword">case</span> HCDCalculateTypeAdd:</span><br><span class="line">            <span class="keyword">return</span> [[HCDCalculateAdd alloc]init];</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> HCDCalculateTypeMinus:</span><br><span class="line">            <span class="keyword">return</span> [[HCDCalculateMinus alloc]init];</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> HCDCalculateTypeMultipy:</span><br><span class="line">            <span class="keyword">return</span> [[HCDCalcuteMultiply alloc]init];</span><br><span class="line">        <span class="keyword">case</span> HCDCalculateTypeDivide:</span><br><span class="line">            <span class="keyword">return</span> [[HCDCalculateDivide alloc]init];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//HCDCalculateAdd.m</span></span><br><span class="line"><span class="meta">#import <span class="string">&quot;HCDCalculateAdd.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">HCDCalculateAdd</span></span></span><br><span class="line"></span><br><span class="line">-(<span class="built_in">CGFloat</span>)calculate&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>.numberA + <span class="keyword">self</span>.numberB;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//HCDCalculateMinus.m</span></span><br><span class="line"><span class="meta">#import <span class="string">&quot;HCDCalculateMinus.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">HCDCalculateMinus</span></span></span><br><span class="line"></span><br><span class="line">-(<span class="built_in">CGFloat</span>)calculate&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>.numberA - <span class="keyword">self</span>.numberB;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//HCDCalcuteMultiply</span></span><br><span class="line"><span class="meta">#import <span class="string">&quot;HCDCalcuteMultiply.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">HCDCalcuteMultiply</span></span></span><br><span class="line"></span><br><span class="line">-(<span class="built_in">CGFloat</span>)calculate&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>.numberA * <span class="keyword">self</span>.numberB;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//HCDCalculateDivide.m</span></span><br><span class="line"><span class="meta">#import <span class="string">&quot;HCDCalculateDivide.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">HCDCalculateDivide</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="built_in">CGFloat</span>)calculate&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.numberB == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;dividend is can not be zero!&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>.numberA/<span class="keyword">self</span>.numberB;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<h4 id="工厂方法模式"><a href="#工厂方法模式" class="headerlink" title="工厂方法模式"></a>工厂方法模式</h4><h5 id="模式动机-1"><a href="#模式动机-1" class="headerlink" title="模式动机"></a>模式动机</h5><p>现在对该系统进行修改，不再设计一个运算工厂类来统一负责所有产品的创建，而是将具体运算的创建过程交给专门的工厂子类去完成，我们先定义一个抽象的运算工厂类，再定义具体的工厂类来生成加法运算、减法运算、乘法运算等，它们实现在抽象按钮工厂类中定义的方法。这种抽象化的结果使这种结构可以在不修改具体工厂类的情况下引进新的产品，如果出现新的按钮类型，只需要为这种新类型的按钮创建一个具体的工厂类就可以获得该新运算的实例，这一特点无疑使得工厂方法模式具有超越简单工厂模式的优越性，更加符合“开闭原则”。</p>
<h5 id="模式定义-1"><a href="#模式定义-1" class="headerlink" title="模式定义"></a>模式定义</h5><p>工厂方法模式，它属于类创建型模式。在工厂方法模式中，工厂父类负责定义创建产品对象的公共接口，而工厂子类则负责生成具体的产品对象，这样做的目的是将产品类的实例化操作延迟到工厂子类中完成，即通过工厂子类来确定究竟应该实例化哪一个具体产品类。</p>
<h5 id="模式结构-1"><a href="#模式结构-1" class="headerlink" title="模式结构"></a>模式结构</h5><p>工厂方法模式包含如下角色：</p>
<ul>
<li>HCDCalculate：抽象产品</li>
<li>HCDCalculateAdd：具体产品</li>
<li>HCDfactory：抽象工厂</li>
<li>HCDfactoryAdd：具体工厂</li>
</ul>
<p><img src="/images/design-factory-method-class.png" alt="工厂方法模式类图"></p>
<h5 id="时序图-1"><a href="#时序图-1" class="headerlink" title="时序图"></a>时序图</h5><p><img src="/images/design-factory-method-sequence.png" alt="工厂方法模式时序图"></p>
<h5 id="源码-1"><a href="#源码-1" class="headerlink" title="源码"></a>源码</h5><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//HCDfactory.h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#import <span class="string">&lt;Foundation/Foundation.h&gt;</span></span></span><br><span class="line"><span class="meta">#import <span class="string">&quot;HCDCalculate.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">HCDfactory</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line">-(HCDCalculate *)createFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//HCDfactory.m</span></span><br><span class="line"><span class="meta">#import <span class="string">&quot;HCDfactory.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">HCDfactory</span></span></span><br><span class="line"></span><br><span class="line">-(HCDCalculate *)createFactory &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//HCDfactoryAdd.m</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">HCDfactoryAdd</span></span></span><br><span class="line"></span><br><span class="line">-(HCDCalculate *)createFactory &#123;</span><br><span class="line">    <span class="keyword">return</span> [[HCDCalculateAdd alloc]init];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//HCDfactoryMinus.m</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">HCDfactoryMinus</span></span></span><br><span class="line"></span><br><span class="line">-(HCDCalculate *)createFactory &#123;</span><br><span class="line">    <span class="keyword">return</span> [[HCDCalculateMinus alloc]init];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//HCDfactoryMultiply.m</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">HCDfactoryMultiply</span></span></span><br><span class="line"></span><br><span class="line">-(HCDCalculate *)createFactory &#123;</span><br><span class="line">    <span class="keyword">return</span> [[HCDCalcuteMultiply alloc]init];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//HCDfactoryDivide.m</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">HCDfactoryDivide</span></span></span><br><span class="line"></span><br><span class="line">-(HCDCalculate *)createFactory &#123;</span><br><span class="line">    <span class="keyword">return</span> [[HCDCalculateDivide alloc]init];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//HCDCalculate.h</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">HCDCalculate</span> : <span class="title">NSObject</span> &lt;<span class="title">HCDCalculateProtocol</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">CGFloat</span> numberA;</span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">CGFloat</span> numberB;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//HCDCalculateAdd.m</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">HCDCalculateAdd</span></span></span><br><span class="line"></span><br><span class="line">-(<span class="built_in">CGFloat</span>)calculate&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>.numberA + <span class="keyword">self</span>.numberB;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//HCDCalculateMinus.m</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">HCDCalculateMinus</span></span></span><br><span class="line"></span><br><span class="line">-(<span class="built_in">CGFloat</span>)calculate&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>.numberA - <span class="keyword">self</span>.numberB;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//HCDCalcuteMultiply.m</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">HCDCalcuteMultiply</span></span></span><br><span class="line"></span><br><span class="line">-(<span class="built_in">CGFloat</span>)calculate&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>.numberA * <span class="keyword">self</span>.numberB;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//HCDCalculateDivide.m</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">HCDCalculateDivide</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="built_in">CGFloat</span>)calculate&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.numberB == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;dividend is can not be zero!&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>.numberA/<span class="keyword">self</span>.numberB;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//HCDCalculateProtocol.h</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="built_in">NS_ENUM</span>(<span class="built_in">NSInteger</span>, HCDCalculateType) &#123;</span><br><span class="line">    HCDCalculateTypeAdd = <span class="number">0</span>,   <span class="comment">//加</span></span><br><span class="line">    HCDCalculateTypeMinus,     <span class="comment">//减</span></span><br><span class="line">    HCDCalculateTypeMultipy,   <span class="comment">//乘</span></span><br><span class="line">    HCDCalculateTypeDivide     <span class="comment">//除</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@protocol</span> <span class="title">HCDCalculateProtocol</span> &lt;<span class="title">NSObject</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@optional</span></span><br><span class="line">-(<span class="built_in">CGFloat</span>)calculate;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//使用示例</span></span><br><span class="line">    HCDfactory *addFactory = [[HCDfactoryAdd alloc]init];</span><br><span class="line">    HCDCalculate *addCalculate = [addFactory createFactory];</span><br><span class="line">    addCalculate.numberA = <span class="number">10</span>;</span><br><span class="line">    addCalculate.numberB = <span class="number">15</span>;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;结果是%f\n&quot;</span>,[addCalculate calculate]);</span><br><span class="line">    </span><br><span class="line">    HCDfactory *minusFactory = [[HCDfactoryMinus alloc]init];</span><br><span class="line">    HCDCalculate *minusCalculate = [minusFactory createFactory];</span><br><span class="line">    minusCalculate.numberA = <span class="number">10</span>;</span><br><span class="line">    minusCalculate.numberB = <span class="number">15</span>;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;结果是%f\n&quot;</span>,[minusCalculate calculate]);</span><br><span class="line">    </span><br><span class="line">    HCDfactory *multiplyFactory = [[HCDfactoryMultiply alloc]init];</span><br><span class="line">    HCDCalculate *multiplyCalculate = [multiplyFactory createFactory];</span><br><span class="line">    multiplyCalculate.numberA = <span class="number">10</span>;</span><br><span class="line">    multiplyCalculate.numberB = <span class="number">15</span>;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;结果是%f\n&quot;</span>,[multiplyCalculate calculate]);</span><br><span class="line">    </span><br><span class="line">    HCDfactory *divideFactory = [[HCDfactoryDivide alloc]init];</span><br><span class="line">    HCDCalculate *divideCalculate = [divideFactory createFactory];</span><br><span class="line">    divideCalculate.numberA = <span class="number">10</span>;</span><br><span class="line">    divideCalculate.numberB = <span class="number">15</span>;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;结果是%f\n&quot;</span>,[divideCalculate calculate]);</span><br><span class="line">    </span><br></pre></td></tr></table></figure>

<h4 id="抽象工厂模式"><a href="#抽象工厂模式" class="headerlink" title="抽象工厂模式"></a>抽象工厂模式</h4><h5 id="模式动机-2"><a href="#模式动机-2" class="headerlink" title="模式动机"></a>模式动机</h5><ul>
<li>在工厂方法模式中具体工厂负责生产具体的产品，每一个具体工厂对应一种具体产品，工厂方法也具有唯一性，一般情况下，一个具体工厂中只有一个工厂-方法或者一组重载的工厂方法。但是有时候我们需要一个工厂可以提供多个产品对象，而不是单一的产品对象。</li>
<li>当系统所提供的工厂所需生产的具体产品并不是一个简单的对象，而是多个位于不同产品等级结构中属于不同类型的具体产品时需要使用抽象工厂模式。</li>
</ul>
<h5 id="模式定义-2"><a href="#模式定义-2" class="headerlink" title="模式定义"></a>模式定义</h5><p>抽象工厂模式：提供一个创建一系列相关或相互依赖对象的接口，而无须指定它们具体的类。属于对象创建型模式。</p>
<h5 id="模式结构-2"><a href="#模式结构-2" class="headerlink" title="模式结构"></a>模式结构</h5><p>抽象工厂模式包含如下角色：</p>
<ul>
<li>HCDFactory：抽象工厂</li>
<li>HCDSqlserverFactory：具体工厂</li>
<li>HCDDepartment：抽象产品</li>
<li>HCDSqlserverDepartment：具体产品</li>
</ul>
<p><img src="/images/design-abstract-factory-class.png" alt="抽象工厂模式类图"></p>
<h5 id="时序图-2"><a href="#时序图-2" class="headerlink" title="时序图"></a>时序图</h5><p><img src="/images/design-abstract-factory-sequence.png" alt="抽象工厂模式时序图"></p>
<h5 id="源码-2"><a href="#源码-2" class="headerlink" title="源码"></a>源码</h5><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//HCDFactory.h</span></span><br><span class="line"><span class="class"><span class="keyword">@protocol</span> <span class="title">HCDFactory</span> &lt;<span class="title">NSObject</span>&gt;</span></span><br><span class="line"></span><br><span class="line">-(<span class="keyword">id</span>&lt;HCDUser&gt;)createUser;</span><br><span class="line">-(<span class="keyword">id</span>&lt;HCDDepartment&gt;)createDepartment;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//HCDSqlserverFactory.m</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">HCDSqlserverFactory</span></span></span><br><span class="line"></span><br><span class="line">-(<span class="keyword">id</span>&lt;HCDUser&gt;)createUser&#123;</span><br><span class="line">    <span class="keyword">return</span> [[HCDSqlserverUser alloc]init];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-(<span class="keyword">id</span>&lt;HCDDepartment&gt;)createDepartment&#123;</span><br><span class="line">    <span class="keyword">return</span> [[HCDSqlserverDepartment alloc]init];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//HCDAccessFactory.m</span></span><br><span class="line">-(<span class="keyword">id</span>&lt;HCDUser&gt;)createUser&#123;</span><br><span class="line">    <span class="keyword">return</span> [[HCDAccessUser alloc]init];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-(<span class="keyword">id</span>&lt;HCDDepartment&gt;)createDepartment&#123;</span><br><span class="line">    <span class="keyword">return</span> [[HCDAccessDepartment alloc]init];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span> </span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//HCDDepartment.h</span></span><br><span class="line"><span class="class"><span class="keyword">@protocol</span> <span class="title">HCDDepartment</span> &lt;<span class="title">NSObject</span>&gt;</span></span><br><span class="line"></span><br><span class="line">-(<span class="keyword">void</span>)insertDepartment:(SQLDepartment *)department;</span><br><span class="line"></span><br><span class="line">-(SQLDepartment *)getDepartment;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//HCDSqlserverDepartment.m</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">HCDSqlserverDepartment</span></span></span><br><span class="line"></span><br><span class="line">-(SQLDepartment *)getDepartment&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;新建一个Sqlserver的SQLDepartment对象&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> [[SQLDepartment alloc]init];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-(<span class="keyword">void</span>)insertDepartment:(SQLDepartment *)department&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;插入一个Sqlserver的SQLDepartment对象&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//HCDAccessDepartment.m</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">HCDAccessDepartment</span></span></span><br><span class="line"></span><br><span class="line">-(SQLDepartment *)getDepartment&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;新建一个Access的SQLDepartment对象&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> [[SQLDepartment alloc]init];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-(<span class="keyword">void</span>)insertDepartment:(SQLDepartment *)department&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;插入一个Access的SQLDepartment对象&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//HCDUser.h</span></span><br><span class="line"><span class="class"><span class="keyword">@protocol</span> <span class="title">HCDUser</span> &lt;<span class="title">NSObject</span>&gt;</span></span><br><span class="line"></span><br><span class="line">-(<span class="keyword">void</span>)insertUser:(SQLUser *)user;</span><br><span class="line"></span><br><span class="line">-(SQLUser *)getUser;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//HCDSqlserverUser.m</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">HCDSqlserverUser</span></span></span><br><span class="line"></span><br><span class="line">-(SQLUser *)getUser&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;新建一个Sqlserver的SQLUser对象&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> [[SQLUser alloc]init];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-(<span class="keyword">void</span>)insertUser:(SQLUser *)user&#123;</span><br><span class="line">     <span class="built_in">NSLog</span>(<span class="string">@&quot;插入一个Sqlserver的SQLUser对象&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//HCDAccessUser.m</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">HCDAccessUser</span></span></span><br><span class="line"></span><br><span class="line">-(SQLUser *)getUser&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;新建一个Access的SQLUser对象&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> [[SQLUser alloc]init];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-(<span class="keyword">void</span>)insertUser:(SQLUser *)user&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;插入一个Access的SQLUser对象&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//使用示例</span></span><br><span class="line">    <span class="keyword">id</span>&lt;HCDFactory&gt; factory0 = [[HCDSqlserverFactory alloc]init];</span><br><span class="line">    <span class="keyword">id</span>&lt;HCDDepartment&gt; department0 = [factory0 createDepartment];</span><br><span class="line">    [department0 insertDepartment:[[SQLDepartment alloc]init]];</span><br><span class="line">    [department0 getDepartment];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">id</span>&lt;HCDUser&gt; user0 = [factory0 createUser];</span><br><span class="line">    [user0 insertUser:[[SQLUser alloc] init]];</span><br><span class="line">    [user0 getUser];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">id</span>&lt;HCDFactory&gt; factory1 = [[HCDAccessFactory alloc]init];</span><br><span class="line">    <span class="keyword">id</span>&lt;HCDDepartment&gt; department1 = [factory1 createDepartment];</span><br><span class="line">    [department1 insertDepartment:[[SQLDepartment alloc]init]];</span><br><span class="line">    [department1 getDepartment];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">id</span>&lt;HCDUser&gt; user1 = [factory1 createUser];</span><br><span class="line">    [user1 insertUser:[[SQLUser alloc] init]];</span><br><span class="line">    [user1 getUser];</span><br></pre></td></tr></table></figure>

<h4 id="建造者模式"><a href="#建造者模式" class="headerlink" title="建造者模式"></a>建造者模式</h4><h5 id="模式动机-3"><a href="#模式动机-3" class="headerlink" title="模式动机"></a>模式动机</h5><p>无论是在现实世界中还是在软件系统中，都存在一些复杂的对象，它们拥有多个组成部分，如汽车，它包括车轮、方向盘、发送机等各种部件。而对于大多数用户而言，无须知道这些部件的装配细节，也几乎不会使用单独某个部件，而是使用一辆完整的汽车，可以通过建造者模式对其进行设计与描述，建造者模式可以将部件和其组装过程分开，一步一步创建一个复杂的对象。用户只需要指定复杂对象的类型就可以得到该对象，而无须知道其内部的具体构造细节。</p>
<h5 id="模式定义-3"><a href="#模式定义-3" class="headerlink" title="模式定义"></a>模式定义</h5><p>造者模式：将一个复杂对象的构建与它的表示分离，使得同样的构建过程可以创建不同的表示。</p>
<h5 id="模式结构-3"><a href="#模式结构-3" class="headerlink" title="模式结构"></a>模式结构</h5><p>建造者模式包含如下角色：</p>
<ul>
<li>HCDPresionBuilder：抽象建造者</li>
<li>HCDPersonFatBuilder：具体建造者</li>
<li>HCDPersonBuilderDirector：指挥者</li>
<li>HCDProduct：产品角色</li>
</ul>
<p><img src="/images/design-Builder-Pattern-Class.png" alt="建造者模式类图"></p>
<h5 id="时序图-3"><a href="#时序图-3" class="headerlink" title="时序图"></a>时序图</h5><p><img src="/images/design-Builder-Pattern-Sequence.png" alt="建造者模式时序图"></p>
<h5 id="源码-3"><a href="#源码-3" class="headerlink" title="源码"></a>源码</h5><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//HCDPersonBuilderDirector.h</span></span><br><span class="line"><span class="class"><span class="keyword">@class</span> <span class="title">HCDPresionBuilder</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">HCDPersonBuilderDirector</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithBuilder:(HCDPresionBuilder *)builder;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)buildPerson; </span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//HCDPersonBuilderDirector.m</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">HCDPersonBuilderDirector</span> ()</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) HCDPresionBuilder *builder;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">HCDPersonBuilderDirector</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithBuilder:(HCDPresionBuilder *)builder &#123;</span><br><span class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> init];</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.builder = builder;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)buildPerson &#123;</span><br><span class="line">    [<span class="keyword">self</span>.builder buildHead];</span><br><span class="line">    [<span class="keyword">self</span>.builder buildBody];</span><br><span class="line">    [<span class="keyword">self</span>.builder buildArmLeft];</span><br><span class="line">    [<span class="keyword">self</span>.builder buildArmRight];</span><br><span class="line">    [<span class="keyword">self</span>.builder buildLegLeft];</span><br><span class="line">    [<span class="keyword">self</span>.builder buildLegRight];</span><br><span class="line">    [<span class="keyword">self</span>.builder getResult];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//HCDPresionBuilderProtocol.h</span></span><br><span class="line">ypedef  <span class="built_in">NS_ENUM</span>(<span class="built_in">NSUInteger</span>,HCDBuildOption)&#123;</span><br><span class="line">    HCDBuildOptionFat = <span class="number">0</span>,  <span class="comment">//胖的人</span></span><br><span class="line">    HCDBuildOptionThin      <span class="comment">//瘦的人</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@protocol</span> <span class="title">HCDPresionBuilderProtocol</span> &lt;<span class="title">NSObject</span>&gt;</span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)buildHead;</span><br><span class="line">- (<span class="keyword">void</span>)buildBody;</span><br><span class="line">- (<span class="keyword">void</span>)buildArmLeft;</span><br><span class="line">- (<span class="keyword">void</span>)buildArmRight;</span><br><span class="line">- (<span class="keyword">void</span>)buildLegLeft;</span><br><span class="line">- (<span class="keyword">void</span>)buildLegRight;</span><br><span class="line"></span><br><span class="line">- (HCDProduct *)getResult;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span> </span><br><span class="line"></span><br><span class="line"><span class="comment">//HCDPresionBuilder.h</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">HCDPresionBuilder</span> : <span class="title">NSObject</span>&lt;<span class="title">HCDPresionBuilderProtocol</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//HCDPersonFatBuilder.m</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">HCDPersonFatBuilder</span>()</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) HCDProduct *product;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">HCDPersonFatBuilder</span></span></span><br><span class="line"></span><br><span class="line">-(<span class="keyword">instancetype</span>)init&#123;</span><br><span class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> init];</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>) &#123;</span><br><span class="line">        _product = [[HCDProduct alloc] init];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)buildHead &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;建造胖子的头部&quot;</span>);</span><br><span class="line">    [<span class="keyword">self</span>.product.header work];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)buildBody &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;建造胖子的身体&quot;</span>);</span><br><span class="line">    [<span class="keyword">self</span>.product.body work];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)buildArmLeft &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;建造胖子的左手&quot;</span>);</span><br><span class="line">    [<span class="keyword">self</span>.product.arm work];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)buildArmRight &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;建造胖子的右手&quot;</span>);</span><br><span class="line">    [<span class="keyword">self</span>.product.arm work];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)buildLegLeft &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;建造胖子的左脚&quot;</span>);</span><br><span class="line">    [<span class="keyword">self</span>.product.leg work];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)buildLegRight &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;建造胖子的右脚&quot;</span>);</span><br><span class="line">    [<span class="keyword">self</span>.product.leg work];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (HCDProduct *)getResult &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>.product;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//HCDPersonThinBuilder.m</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">HCDPersonThinBuilder</span> ()</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) HCDProduct *product;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">HCDPersonThinBuilder</span></span></span><br><span class="line"></span><br><span class="line">-(<span class="keyword">instancetype</span>)init&#123;</span><br><span class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> init];</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>) &#123;</span><br><span class="line">        _product = [[HCDProduct alloc] init];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">- (<span class="keyword">void</span>)buildHead &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;建造瘦子的头部&quot;</span>);</span><br><span class="line">    [<span class="keyword">self</span>.product.header work];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)buildBody &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;建造瘦子的身体&quot;</span>);</span><br><span class="line">    [<span class="keyword">self</span>.product.body work];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)buildArmLeft &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;建造瘦子的左手&quot;</span>);</span><br><span class="line">    [<span class="keyword">self</span>.product.arm work];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)buildArmRight &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;建造瘦子的右手&quot;</span>);</span><br><span class="line">    [<span class="keyword">self</span>.product.arm work];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)buildLegLeft &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;建造瘦子的左脚&quot;</span>);</span><br><span class="line">    [<span class="keyword">self</span>.product.leg work];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)buildLegRight &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;建造瘦子的右脚&quot;</span>);</span><br><span class="line">    [<span class="keyword">self</span>.product.leg work];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (HCDProduct *)getResult &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>.product;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//使用示例</span></span><br><span class="line">- (<span class="keyword">IBAction</span>)buildFat:(<span class="keyword">id</span>)sender &#123;</span><br><span class="line">    HCDPersonFatBuilder *builder = [[HCDPersonFatBuilder alloc]init];</span><br><span class="line">    HCDPersonBuilderDirector *director = [[HCDPersonBuilderDirector alloc] initWithBuilder:builder];</span><br><span class="line">    [director buildPerson];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">IBAction</span>)buildThin:(<span class="keyword">id</span>)sender &#123;</span><br><span class="line">    HCDPersonThinBuilder *builder = [[HCDPersonThinBuilder alloc]init];</span><br><span class="line">    HCDPersonBuilderDirector *director = [[HCDPersonBuilderDirector alloc] initWithBuilder:builder];</span><br><span class="line">    [director buildPerson];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="单例模式"><a href="#单例模式" class="headerlink" title="单例模式"></a>单例模式</h4><h5 id="模式动机-4"><a href="#模式动机-4" class="headerlink" title="模式动机"></a>模式动机</h5><p>对于系统中的某些类来说，只有一个实例很重要，例如，一个系统中可以存在多个打印任务，但是只能有一个正在工作的任务；一个系统只能有一个窗口管理器或文件系统；一个系统只能有一个计时工具或ID（序号）生成器。<br>如何保证一个类只有一个实例并且这个实例易于被访问呢？定义一个全局变量可以确保对象随时都可以被访问，但不能防止我们实例化多个对象。<br>一个更好的解决办法是让类自身负责保存它的唯一实例。这个类可以保证没有其他实例被创建，并且它可以提供一个访问该实例的方法。这就是单例模式的模式动机</p>
<h5 id="模式定义-4"><a href="#模式定义-4" class="headerlink" title="模式定义"></a>模式定义</h5><p>单例模式：单例模式确保某一个类只有一个实例，而且自行实例化并向整个系统提供这个实例，这个类称为单例类，它提供全局访问的方法。</p>
<h5 id="模式结构-4"><a href="#模式结构-4" class="headerlink" title="模式结构"></a>模式结构</h5><p><img src="/images/design-singleton-class.png" alt="抽象工厂模式类图"></p>
<h5 id="时序图-4"><a href="#时序图-4" class="headerlink" title="时序图"></a>时序图</h5><p><img src="/images/design-singleton-sequence.png" alt="抽象工厂模式时序图"></p>
<h5 id="源码-4"><a href="#源码-4" class="headerlink" title="源码"></a>源码</h5><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">+(<span class="keyword">instancetype</span>)sharedInstance&#123;</span><br><span class="line">    <span class="keyword">static</span> HCDSingleton *singleton = <span class="literal">nil</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken;</span><br><span class="line">    <span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123;</span><br><span class="line">        singleton = [[HCDSingleton alloc]init];</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> singleton;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="原型模式"><a href="#原型模式" class="headerlink" title="原型模式"></a>原型模式</h4><h5 id="模式动机-5"><a href="#模式动机-5" class="headerlink" title="模式动机"></a>模式动机</h5><ul>
<li>将一个原型对象传给那个要发动创建的对象，这个要发动创建的对象通过请求原型对象拷贝自己来实现创建过程。</li>
<li>通过克隆方法所创建的对象是全新的对象，它们在内存中拥有新的地址，通常对克隆所产生的对象进行修改对原型对象不会造成任何影响，每一个克隆对象都是相互独立的。通过不同的方式修改可以得到一系列相似但不完全相同的对象。</li>
</ul>
<h5 id="模式定义-5"><a href="#模式定义-5" class="headerlink" title="模式定义"></a>模式定义</h5><p>使用原型实例指定创建对象的种类，并且通过拷贝这些原型创建新的对象。原型模式是一种对象创建型模式。<br>备注：复制分浅复制和深复制</p>
<ul>
<li>浅复制：被复制对象的所有变量都含有与原来的对象相同的值，而所有的对其他对象的引用都仍然指向原来的对象；</li>
<li>深复制：把引用对象的变量指向复制过的新对象，而不是原有的被引用的对象。</li>
</ul>
<p><a target="_blank" rel="noopener" href="http://levertsui.com/2017/12/14/iOS%E6%B7%B1%E6%8B%B7%E8%B4%9D%E5%92%8C%E6%B5%85%E6%8B%B7%E8%B4%9D/">iOS深拷贝和浅拷贝</a> </p>
<h3 id="结构式模式"><a href="#结构式模式" class="headerlink" title="结构式模式"></a>结构式模式</h3><h4 id="组合模式"><a href="#组合模式" class="headerlink" title="组合模式"></a>组合模式</h4><h5 id="模式动机-6"><a href="#模式动机-6" class="headerlink" title="模式动机"></a>模式动机</h5><ul>
<li>对于树形结构，当容器对象的某一个方法被调用时，将遍历整个树形结构，寻找也包含这个方法的成员对象（可以是容器对象，也可以是叶子对象，如子文件夹和文件）并调用执行。（递归调用）</li>
<li>由于容器对象和叶子对象在功能上的区别，在使用这些对象的客户端代码中必须有区别地对待容器对象和叶子对象，而实际上大多数情况下客户端希望一致地处理它们，因为对于这些对象的区别对待将会使得程序非常复杂。<br>组合模式描述了如何将容器对象和叶子对象进行递归组合，使得用户在使用时无须对它们进行区分，可以一致地对待容器对象和叶子对象，这就是组合模式的模式动机。</li>
</ul>
<h5 id="模式定义-6"><a href="#模式定义-6" class="headerlink" title="模式定义"></a>模式定义</h5><p>将对象组合成树形结构以表示‘部分-整体’的层次结构。组合模式使得用户对单个对象和组合对象的使用具有一致性。</p>
<h5 id="模式结构-5"><a href="#模式结构-5" class="headerlink" title="模式结构"></a>模式结构</h5><p>模板方法模式包含如下角色：</p>
<ul>
<li>Component: 对象声明接口 </li>
<li>Leaf: 叶节点对象</li>
<li>Composite: 枝节点行为</li>
</ul>
<p><img src="/images/design-composite-pattern-class.png" alt="组合模式类图"></p>
<h5 id="时序图-5"><a href="#时序图-5" class="headerlink" title="时序图"></a>时序图</h5><p>略</p>
<h5 id="源码-5"><a href="#源码-5" class="headerlink" title="源码"></a>源码</h5><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//使用示例</span></span><br><span class="line">HCDConcreteCompany *root = [[HCDConcreteCompany alloc] initWithName:<span class="string">@&quot;总公司&quot;</span>];</span><br><span class="line">[root add:[[HCDHRDepartment alloc] initWithName:<span class="string">@&quot;总公司人力资源部&quot;</span>]];</span><br><span class="line">[root add:[[HCDFinanceDepartment alloc] initWithName:<span class="string">@&quot;总公司财务部&quot;</span>]];</span><br><span class="line"></span><br><span class="line">HCDConcreteCompany *comp = [[HCDConcreteCompany alloc] initWithName:<span class="string">@&quot;上海华东分公司&quot;</span>];</span><br><span class="line">[comp add:[[HCDHRDepartment alloc] initWithName:<span class="string">@&quot;上海华东分公司人力资源部&quot;</span>]];</span><br><span class="line">[comp add:[[HCDFinanceDepartment alloc] initWithName:<span class="string">@&quot;上海华东分公司财务部&quot;</span>]];</span><br><span class="line">[root add:comp];</span><br><span class="line"></span><br><span class="line">HCDConcreteCompany *office = [[HCDConcreteCompany alloc] initWithName:<span class="string">@&quot;杭州办事处&quot;</span>];</span><br><span class="line">[office add:[[HCDHRDepartment alloc] initWithName:<span class="string">@&quot;杭州办事处人力资源部&quot;</span>]];</span><br><span class="line">[office add:[[HCDFinanceDepartment alloc] initWithName:<span class="string">@&quot;杭州办事处财务部&quot;</span>]];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@&quot;\n&quot;</span>);</span><br><span class="line">[comp add:office];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@&quot;结构图:--------------------------&quot;</span>);</span><br><span class="line">[root display:<span class="number">1</span>];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@&quot;\n&quot;</span>);</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@&quot;职责:---------------------------&quot;</span>);</span><br><span class="line">[root lineofDuty];</span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//HCDCompany.h</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">HCDCompany</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>,<span class="keyword">copy</span>) <span class="built_in">NSString</span> *name;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithName:(<span class="built_in">NSString</span> *)name;</span><br><span class="line"></span><br><span class="line">-(<span class="keyword">void</span>)add:(HCDCompany *)company;</span><br><span class="line"></span><br><span class="line">-(<span class="keyword">void</span>)remove:(HCDCompany *)company;</span><br><span class="line"></span><br><span class="line">-(<span class="keyword">void</span>)display:(<span class="built_in">NSInteger</span>)depth;</span><br><span class="line"></span><br><span class="line">-(<span class="keyword">void</span>)lineofDuty;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//HCDConcreteCompany.h</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">HCDConcreteCompany</span> : <span class="title">HCDCompany</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//HCDConcreteCompany.m</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">HCDConcreteCompany</span> ()</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSMutableArray</span> *childList;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">HCDConcreteCompany</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithName:(<span class="built_in">NSString</span> *)name&#123;</span><br><span class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> initWithName:name];</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>) &#123; </span><br><span class="line">        _childList = [<span class="built_in">NSMutableArray</span> array];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)add:(HCDCompany *)company&#123;</span><br><span class="line">    [<span class="keyword">self</span>.childList addObject:company];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)remove:(HCDCompany *)company&#123;</span><br><span class="line">    [<span class="keyword">self</span>.childList removeObject:company];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)display:(<span class="built_in">NSInteger</span>)depth &#123;</span><br><span class="line">    <span class="built_in">NSString</span> *seperate = <span class="string">@&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">NSInteger</span> i = <span class="number">0</span>; i &lt; depth; i++) &#123;</span><br><span class="line">        seperate = [seperate stringByAppendingString:<span class="string">@&quot;-&quot;</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@%@的子公司&quot;</span>,seperate,<span class="keyword">self</span>.name);</span><br><span class="line">    <span class="keyword">for</span> (HCDCompany * company <span class="keyword">in</span> <span class="keyword">self</span>.childList) &#123;</span><br><span class="line">        [company display:depth + <span class="number">2</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)lineofDuty&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@的子公司的职责&quot;</span>,<span class="keyword">self</span>.name);</span><br><span class="line">    <span class="keyword">for</span> (HCDCompany * company <span class="keyword">in</span> <span class="keyword">self</span>.childList) &#123;</span><br><span class="line">        [company lineofDuty];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//HCDHRDepartment.h</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">HCDHRDepartment</span> : <span class="title">HCDCompany</span> </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//HCDHRDepartment.m</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">HCDHRDepartment</span></span></span><br><span class="line"></span><br><span class="line">-(<span class="keyword">void</span>)add:(HCDCompany *)company&#123;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)display:(<span class="built_in">NSInteger</span>)depth &#123;</span><br><span class="line">    <span class="built_in">NSString</span> *seperate = <span class="string">@&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">NSInteger</span> i = <span class="number">0</span>; i &lt; depth; i++) &#123;</span><br><span class="line">        seperate = [seperate stringByAppendingString:<span class="string">@&quot;-&quot;</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@%@的HR部门&quot;</span>,seperate,<span class="keyword">self</span>.name);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-(<span class="keyword">void</span>)remove:(HCDCompany *)company&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-(<span class="keyword">void</span>)lineofDuty&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@,培训员工&quot;</span>,<span class="keyword">self</span>.name);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//HCDFinanceDepartment.h</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">HCDFinanceDepartment</span> : <span class="title">HCDCompany</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//HCDFinanceDepartment.m</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">HCDFinanceDepartment</span></span></span><br><span class="line"></span><br><span class="line">-(<span class="keyword">void</span>)add:(HCDCompany *)company&#123;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-(<span class="keyword">void</span>)remove:(HCDCompany *)company&#123;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)display:(<span class="built_in">NSInteger</span>)depth &#123;</span><br><span class="line">    <span class="built_in">NSString</span> *seperate = <span class="string">@&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">NSInteger</span> i = <span class="number">0</span>; i &lt; depth; i++) &#123;</span><br><span class="line">        seperate = [seperate stringByAppendingString:<span class="string">@&quot;-&quot;</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@%@的财务部门&quot;</span>,seperate,<span class="keyword">self</span>.name);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-(<span class="keyword">void</span>)lineofDuty&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@,给员工发钱&quot;</span>,<span class="keyword">self</span>.name);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<h4 id="适配器模式"><a href="#适配器模式" class="headerlink" title="适配器模式"></a>适配器模式</h4><h5 id="模式动机-7"><a href="#模式动机-7" class="headerlink" title="模式动机"></a>模式动机</h5><p>适配器提供客户类需要的接口，适配器的实现就是把客户类的请求转化为对适配者的相应接口的调用。也就是说：当客户类调用适配器的方法时，在适配器类的内部将调用适配者类的方法，而这个过程对客户类是透明的，客户类并不直接访问适配者类。因此，适配器可以使由于接口不兼容而不能交互的类可以一起工作。这就是适配器模式的模式动机。</p>
<h5 id="模式定义-7"><a href="#模式定义-7" class="headerlink" title="模式定义"></a>模式定义</h5><p>适配器模式：将一个接口转换成客户希望的另一个接口，适配器模式使接口不兼容的那些类可以一起工作，其别名为包装器。适配器模式既可以作为类结构型模式，也可以作为对象结构型模式。</p>
<h5 id="模式结构-6"><a href="#模式结构-6" class="headerlink" title="模式结构"></a>模式结构</h5><p>适配器模式包含如下角色：</p>
<ul>
<li>HCDPlayer：目标抽象类</li>
<li>HCDTranslator：适配器类</li>
<li>HCDForeignCenter：适配者类</li>
</ul>
<p><img src="/images/design-adapter-pattern-class.png" alt="适配器模式类图"></p>
<h5 id="时序图-6"><a href="#时序图-6" class="headerlink" title="时序图"></a>时序图</h5><p><img src="/images/design-adapter-pattern-equence.png" alt="适配器模式时序图"></p>
<h5 id="源码-6"><a href="#源码-6" class="headerlink" title="源码"></a>源码</h5><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//调用方式</span></span><br><span class="line">    HCDPlayer *forward = [[HCDForwards alloc] initWithName:<span class="string">@&quot;maidi&quot;</span>];</span><br><span class="line">    [forward attack];</span><br><span class="line">    [forward defense];</span><br><span class="line">    </span><br><span class="line">    HCDForeignCenter *foreignCenter = [[HCDForeignCenter alloc] initWithName:<span class="string">@&quot;姚明&quot;</span>];</span><br><span class="line">    HCDPlayer *translator = [[HCDTranslator alloc] initWithForeigncenter:foreignCenter];</span><br><span class="line">    [translator attack];</span><br><span class="line">    [translator defense];</span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//HCDPlayer.h</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">HCDPlayer</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>,<span class="keyword">copy</span>) <span class="built_in">NSString</span> *name;</span><br><span class="line"></span><br><span class="line">-(<span class="keyword">void</span>)attack;</span><br><span class="line"></span><br><span class="line">-(<span class="keyword">void</span>)defense;</span><br><span class="line"></span><br><span class="line">-(<span class="keyword">instancetype</span>)initWithName:(<span class="built_in">NSString</span> *)name;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//HCDForwards.m</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">HCDForwards</span></span></span><br><span class="line"></span><br><span class="line">-(<span class="keyword">void</span>)attack&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;前锋%@进攻&quot;</span>,<span class="keyword">self</span>.name);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-(<span class="keyword">void</span>)defense&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;前锋%@防守&quot;</span>,<span class="keyword">self</span>.name);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//HCDTranslator.m</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">HCDTranslator</span> ()</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) HCDForeignCenter *foreigncenter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">HCDTranslator</span></span></span><br><span class="line"></span><br><span class="line">-(<span class="keyword">instancetype</span>)initWithForeigncenter:(HCDForeignCenter *)foreigncenter &#123;</span><br><span class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> init];</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>) &#123;</span><br><span class="line">        _foreigncenter = foreigncenter;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">-(<span class="keyword">void</span>)defense&#123;</span><br><span class="line">    [<span class="keyword">self</span>.foreigncenter foreignDefent];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-(<span class="keyword">void</span>)attack&#123;</span><br><span class="line">    [<span class="keyword">self</span>.foreigncenter foreignAttact];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//HCDForeignCenter.m</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">HCDForeignCenter</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithName:(<span class="built_in">NSString</span> *)name&#123;</span><br><span class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> init];</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>) &#123;</span><br><span class="line">        _name = name;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)foreignAttact&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;外籍中锋%@进攻&quot;</span>,<span class="keyword">self</span>.name);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)foreignDefent&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;外籍中锋%@防守&quot;</span>,<span class="keyword">self</span>.name);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<h4 id="桥接模式"><a href="#桥接模式" class="headerlink" title="桥接模式"></a>桥接模式</h4><h5 id="模式动机-8"><a href="#模式动机-8" class="headerlink" title="模式动机"></a>模式动机</h5><p>如果需要开发一个跨平台视频播放器，可以在不同操作系统平台（如Windows、Linux、Unix等）上播放多种格式的视频文件，常见的视频格式包括MPEG、RMVB、AVI、WMV等。现使用桥接模式设计该播放器。此时至少有如下两种设计方案：</p>
<ul>
<li>第一种设计方案是为每一种操作系统都提供一套支持各种视频格式的版本；</li>
<li>第二种设计方案是根据实际需要对操作系统和支持的视频格式进行组合。</li>
</ul>
<p>对于有两个变化维度（即两个变化的原因）的系统，采用方案二来进行设计系统中类的个数更少，且系统扩展更为方便。设计方案二即是桥接模式的应用。桥接模式将继承关系转换为关联关系，从而降低了类与类之间的耦合，减少了代码编写量。<br>尽量使用组合，而不要使用继承。</p>
<h5 id="模式定义-8"><a href="#模式定义-8" class="headerlink" title="模式定义"></a>模式定义</h5><p>桥接模式：将抽象部分与它的实现部分分离，使它们都可以独立地变化。它是一种对象结构型模式。</p>
<h5 id="模式结构-7"><a href="#模式结构-7" class="headerlink" title="模式结构"></a>模式结构</h5><p>桥接模式包含如下角色：</p>
<ul>
<li>Abstraction：抽象类</li>
<li>RefinedAbstraction：扩充抽象类</li>
<li>Implementor：实现类接口</li>
<li>ConcreteImplementor：具体实现类</li>
</ul>
<p><img src="/images/design-bridge-pattern-class.png" alt="桥接模式类图"></p>
<h5 id="时序图-7"><a href="#时序图-7" class="headerlink" title="时序图"></a>时序图</h5><p><img src="/images/design-bridge-pattern-class.png" alt="桥接模式时序图"></p>
<h5 id="源码-7"><a href="#源码-7" class="headerlink" title="源码"></a>源码</h5><p>略</p>
<h4 id="装饰模式"><a href="#装饰模式" class="headerlink" title="装饰模式"></a>装饰模式</h4><h5 id="模式动机-9"><a href="#模式动机-9" class="headerlink" title="模式动机"></a>模式动机</h5><p>一般有两种方式可以实现给一个类或对象增加行为：</p>
<ul>
<li>继承机制，使用继承机制是给现有类添加功能的一种有效途径，通过继承一个现有类可以使得子类在拥有自身方法的同时还拥有父类的方法。但是这种方法是静态的，用户不能控制增加行为的方式和时机；</li>
<li>关联机制，即将一个类的对象嵌入另一个对象中，由另一个对象来决定是否调用嵌入对象的行为以便扩展自己的行为，我们称这个嵌入的对象为装饰器(Decorator)。</li>
</ul>
<p>装饰模式以对客户透明的方式动态地给一个对象附加上更多的责任。装饰模式可以在不需要创造更多子类的情况下，将对象的功能加以扩展。这就是装饰模式的模式动机。</p>
<h5 id="模式定义-9"><a href="#模式定义-9" class="headerlink" title="模式定义"></a>模式定义</h5><p>装饰模式(Decorator Pattern) ：动态地给一个对象增加一些额外的职责，就增加对象功能来说，装饰模式比生成子类实现更为灵活。它是一种对象结构型模式。</p>
<h5 id="模式结构-8"><a href="#模式结构-8" class="headerlink" title="模式结构"></a>模式结构</h5><p>装饰模式包含如下角色：</p>
<ul>
<li>Component: 抽象构件</li>
<li>ConcreteComponent: 具体构件</li>
<li>Decorator: 抽象装饰类</li>
<li>ConcreteDecorator: 具体装饰类</li>
</ul>
<p><img src="/images/design-decoretor-pattern-class.png" alt="装饰模式类图"></p>
<h5 id="时序图-8"><a href="#时序图-8" class="headerlink" title="时序图"></a>时序图</h5><p><img src="/images/design-decoretor-pattern-sequence.png" alt="装饰模式时序图"> </p>
<h5 id="源码-8"><a href="#源码-8" class="headerlink" title="源码"></a>源码</h5><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//使用示例</span></span><br><span class="line">    LTPerson *xc = [[LTPerson alloc] initWithName:<span class="string">@&quot;小菜&quot;</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;\n第一种装扮&quot;</span>);</span><br><span class="line">    LTSneakers *sneaker = [[LTSneakers alloc] init];</span><br><span class="line">    LTBigTrouser *bigTrouser = [[LTBigTrouser alloc] init];</span><br><span class="line">    LTTshirts *tshirts = [[LTTshirts alloc] init];</span><br><span class="line">    </span><br><span class="line">    [sneaker decorate:xc];</span><br><span class="line">    [bigTrouser decorate:sneaker];</span><br><span class="line">    [tshirts decorate:bigTrouser];</span><br><span class="line">    [tshirts show];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;\n第二种装扮&quot;</span>);</span><br><span class="line">    LTLeatherShoes *leatherShoes = [[LTLeatherShoes alloc] init];</span><br><span class="line">    LTTie *tie = [[LTTie alloc] init];</span><br><span class="line">    LTSuit *suit = [[LTSuit alloc] init];</span><br><span class="line">    </span><br><span class="line">    [leatherShoes decorate:xc];</span><br><span class="line">    [tie decorate:leatherShoes];</span><br><span class="line">    [suit decorate:tie];</span><br><span class="line">    [suit show];</span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//LTPerson.h</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">LTPerson</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithName:(<span class="built_in">NSString</span> *)name;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)show;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//LTPerson.m</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">LTPerson</span> ()</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *name;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">LTPerson</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithName:(<span class="built_in">NSString</span> *)name &#123;</span><br><span class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> init];</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>) &#123;</span><br><span class="line">        _name = name;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)show &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;装扮的%@&quot;</span>,<span class="keyword">self</span>.name);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//LTFinery.h</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">LTFinery</span> : <span class="title">LTPerson</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)decorate:(LTPerson *)person;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">LTTshirts</span> : <span class="title">LTFinery</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">LTBigTrouser</span> : <span class="title">LTFinery</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">LTSneakers</span> : <span class="title">LTFinery</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">LTLeatherShoes</span> : <span class="title">LTFinery</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">LTTie</span> : <span class="title">LTFinery</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">LTSuit</span> : <span class="title">LTFinery</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//LTFinery.m</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">LTFinery</span> ()</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) LTPerson *person;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">LTFinery</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)decorate:(LTPerson *)person &#123;</span><br><span class="line">    <span class="keyword">self</span>.person = person;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)show &#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">self</span>.person) &#123;</span><br><span class="line">        [<span class="keyword">self</span>.person show];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">LTTshirts</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)show &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;大T恤&quot;</span>);</span><br><span class="line">    [<span class="keyword">super</span> show];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">LTBigTrouser</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)show &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;垮裤&quot;</span>);</span><br><span class="line">    [<span class="keyword">super</span> show];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">LTSneakers</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)show &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;破球鞋&quot;</span>);</span><br><span class="line">    [<span class="keyword">super</span> show];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">LTLeatherShoes</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)show &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;皮鞋&quot;</span>);</span><br><span class="line">    [<span class="keyword">super</span> show];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">LTTie</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)show &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;领带&quot;</span>);</span><br><span class="line">    [<span class="keyword">super</span> show];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">LTSuit</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)show &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;西装&quot;</span>);</span><br><span class="line">    [<span class="keyword">super</span> show];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<h4 id="外观模式"><a href="#外观模式" class="headerlink" title="外观模式"></a>外观模式</h4><h5 id="模式动机-10"><a href="#模式动机-10" class="headerlink" title="模式动机"></a>模式动机</h5><p>为子系统中的一组接口提供一个一致的界面，此模式定义了一个高层的接口，这个接口使得这一子系统更加容易使用。</p>
<h5 id="模式定义-10"><a href="#模式定义-10" class="headerlink" title="模式定义"></a>模式定义</h5><p>外观模式(Facade Pattern)：外部与一个子系统的通信必须通过一个统一的外观对象进行，为子系统中的一组接口提供一个一致的界面，外观模式定义了一个高层接口，这个接口使得这一子系统更加容易使用。它是一种对象结构型模式。</p>
<h5 id="模式结构-9"><a href="#模式结构-9" class="headerlink" title="模式结构"></a>模式结构</h5><p>外观模式包含如下角色：</p>
<ul>
<li>Facade: 外观角色</li>
<li>SubSystem:子系统角色</li>
</ul>
<p><img src="/images/design-facade-pattern-class.png" alt="外观模式类图"></p>
<h5 id="时序图-9"><a href="#时序图-9" class="headerlink" title="时序图"></a>时序图</h5><p><img src="/images/design-facade-pattern-equence.png" alt="外观模式时序图"></p>
<h5 id="源码-9"><a href="#源码-9" class="headerlink" title="源码"></a>源码</h5><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//使用示例</span></span><br><span class="line">    HCDFound *found = [[HCDFound alloc]init];</span><br><span class="line">    [found buyFund];</span><br><span class="line">    [found sellFund];</span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//HCDstock.h</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">HCDstock</span> : <span class="title">NSObject</span>&lt;<span class="title">HCDStockProtocol</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">HCDFound</span>()</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) HCDstock1 *stock1;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) HCDstock2 *stock2;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) HCDstock3 *stock3;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">HCDFound</span></span></span><br><span class="line"></span><br><span class="line">-(<span class="keyword">instancetype</span>)init&#123;</span><br><span class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> init];</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>) &#123;</span><br><span class="line">        _stock1 = [[HCDstock1 alloc]init];</span><br><span class="line">        _stock2 = [[HCDstock2 alloc]init];</span><br><span class="line">        _stock3 = [[HCDstock3 alloc]init];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-(<span class="keyword">void</span>)buyFund&#123;</span><br><span class="line">    [<span class="keyword">self</span>.stock1 buy];</span><br><span class="line">    [<span class="keyword">self</span>.stock2 buy];</span><br><span class="line">    [<span class="keyword">self</span>.stock3 buy];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-(<span class="keyword">void</span>)sellFund&#123;</span><br><span class="line">    [<span class="keyword">self</span>.stock1 sell];</span><br><span class="line">    [<span class="keyword">self</span>.stock2 sell];</span><br><span class="line">    [<span class="keyword">self</span>.stock3 sell];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="享元模式"><a href="#享元模式" class="headerlink" title="享元模式"></a>享元模式</h4><h5 id="模式动机-11"><a href="#模式动机-11" class="headerlink" title="模式动机"></a>模式动机</h5><p>面向对象技术可以很好地解决一些灵活性或可扩展性问题，但在很多情况下需要在系统中增加类和对象的个数。当对象数量太多时，将导致运行代价过高，带来性能下降等问题。</p>
<ul>
<li>享元模式正是为解决这一类问题而诞生的。享元模式通过共享技术实现相同或相似对象的重用。</li>
<li>在享元模式中可以共享的相同内容称为内部状态(IntrinsicState)，而那些需要外部环境来设置的不能共享的内容称为外部状态(Extrinsic State)，由于区分了内部状态和外部状态，因此可以通过设置不同的外部状态使得相同的对象可以具有一些不同的特征，而相同的内部状态是可以共享的。</li>
<li>在享元模式中通常会出现工厂模式，需要创建一个享元工厂来负责维护一个享元池(Flyweight Pool)用于存储具有相同内部状态的享元对象。</li>
<li>在享元模式中共享的是享元对象的内部状态，外部状态需要通过环境来设置。在实际使用中，能够共享的内部状态是有限的，因此享元对象一般都设计为较小的对象，它所包含的内部状态较少，这种对象也称为细粒度对象。享元模式的目的就是使用共享技术来实现大量细粒度对象的复用。</li>
</ul>
<h5 id="模式定义-11"><a href="#模式定义-11" class="headerlink" title="模式定义"></a>模式定义</h5><p>享元模式(Flyweight Pattern)：运用共享技术有效地支持大量细粒度对象的复用。系统只使用少量的对象，而这些对象都很相似，状态变化很小，可以实现对象的多次复用。由于享元模式要求能够共享的对象必须是细粒度对象，因此它又称为轻量级模式，它是一种对象结构型模式。</p>
<h5 id="模式结构-10"><a href="#模式结构-10" class="headerlink" title="模式结构"></a>模式结构</h5><p>享元模式包含如下角色：</p>
<ul>
<li>Flyweight: 抽象享元类</li>
<li>ConcreteFlyweight: 具体享元类</li>
<li>UnsharedConcreteFlyweight: 非共享具体享元类</li>
<li>FlyweightFactory: 享元工厂类</li>
</ul>
<p><img src="/images/design-flyweight-pattern-class.png" alt="享元模式类图"></p>
<h5 id="时序图-10"><a href="#时序图-10" class="headerlink" title="时序图"></a>时序图</h5><p><img src="/images/design-flyweight-pattern-sequence.png" alt="享元模式时序图"></p>
<h5 id="源码-10"><a href="#源码-10" class="headerlink" title="源码"></a>源码</h5><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//使用示例</span></span><br><span class="line">HCDWebSiteFactory *facoty = [[HCDWebSiteFactory alloc]init];</span><br><span class="line">HCDWebSiteType fx = [facoty getWebSiteCategory:<span class="string">@&quot;产品展示&quot;</span>];</span><br><span class="line">HCDUser *user = [[HCDUser alloc]init];</span><br><span class="line">user.name = <span class="string">@&quot;小菜&quot;</span>;</span><br><span class="line">[fx use:user];</span><br><span class="line"></span><br><span class="line">HCDWebSiteType fy = [facoty getWebSiteCategory:<span class="string">@&quot;产品展示&quot;</span>];</span><br><span class="line">HCDUser *user1 = [[HCDUser alloc]init];</span><br><span class="line">user1.name = <span class="string">@&quot;大鸟&quot;</span>;</span><br><span class="line">[fy use:user1];</span><br><span class="line"></span><br><span class="line">HCDWebSiteType fz = [facoty getWebSiteCategory:<span class="string">@&quot;博客&quot;</span>];</span><br><span class="line">HCDUser *user2 = [[HCDUser alloc]init];</span><br><span class="line">user2.name = <span class="string">@&quot;咪咪&quot;</span>;</span><br><span class="line">[fz use:user2];</span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//HCDWebSiteFactory.h</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">HCDWebSiteFactory</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>,<span class="keyword">strong</span>) <span class="built_in">NSDictionary</span> *flyweights;</span><br><span class="line"></span><br><span class="line">-(<span class="keyword">id</span>&lt;HCDWebSite&gt; )getWebSiteCategory:(<span class="built_in">NSString</span> *)webkey;</span><br><span class="line"></span><br><span class="line">-(<span class="built_in">NSInteger</span>)getWebSiteCount;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//HCDWebSiteFactory.m</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">HCDWebSiteFactory</span></span></span><br><span class="line"></span><br><span class="line">-(<span class="keyword">instancetype</span>)init&#123;</span><br><span class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> init];</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>) &#123;</span><br><span class="line">        _flyweights = [<span class="built_in">NSDictionary</span> dictionary];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-(<span class="keyword">id</span>&lt;HCDWebSite&gt; )getWebSiteCategory:(<span class="built_in">NSString</span> *)webkey&#123;</span><br><span class="line">    __block <span class="keyword">id</span>&lt;HCDWebSite&gt; webset = <span class="literal">nil</span>;</span><br><span class="line">    [<span class="keyword">self</span>.flyweights enumerateKeysAndObjectsUsingBlock:^(<span class="keyword">id</span> key, <span class="keyword">id</span> obj, <span class="built_in">BOOL</span> *stop) &#123;</span><br><span class="line">        <span class="keyword">if</span> (webkey == key) &#123;</span><br><span class="line">            webset = obj;</span><br><span class="line">            *stop = <span class="literal">YES</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;];</span><br><span class="line">    <span class="keyword">if</span> (webset == <span class="literal">nil</span>) &#123;</span><br><span class="line">        HCDConcreteWebSite  *concreteset = [[HCDConcreteWebSite alloc] init];</span><br><span class="line">        concreteset.webName = webkey;</span><br><span class="line">        webset = concreteset;</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">NSMutableDictionary</span> *mutabledic = [<span class="built_in">NSMutableDictionary</span> dictionaryWithDictionary:<span class="keyword">self</span>.flyweights];</span><br><span class="line">        [mutabledic setObject:webset forKey:webkey];</span><br><span class="line">        <span class="keyword">self</span>.flyweights = [<span class="built_in">NSDictionary</span> dictionaryWithDictionary:mutabledic];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> webset;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-(<span class="built_in">NSInteger</span>)getWebSiteCount&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>.flyweights.count;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//HCDConcreteWebSite.h</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">HCDConcreteWebSite</span> : <span class="title">NSObject</span>&lt;<span class="title">HCDWebSite</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>,<span class="keyword">strong</span>)<span class="built_in">NSString</span> *webName;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//HCDConcreteWebSite.m</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">HCDConcreteWebSite</span></span></span><br><span class="line"></span><br><span class="line">-(<span class="keyword">void</span>)use:(HCDUser *)user&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;网站分类:%@,用户:%@&quot;</span>,<span class="keyword">self</span>.webName,user.name);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<h4 id="代理模式"><a href="#代理模式" class="headerlink" title="代理模式"></a>代理模式</h4><h5 id="模式动机-12"><a href="#模式动机-12" class="headerlink" title="模式动机"></a>模式动机</h5><p>在某些情况下，一个客户不想或者不能直接引用一个对象，此时可以通过一个称之为“代理”的第三者来实现间接引用。代理对象可以在客户端和目标对象之间起到中介的作用，并且可以通过代理对象去掉客户不能看到的内容和服务或者添加客户需要的额外服务。</p>
<h5 id="模式定义-12"><a href="#模式定义-12" class="headerlink" title="模式定义"></a>模式定义</h5><p>在某些情况下，一个客户不想或者不能直接引用一个对 象，此时可以通过一个称之为“代理”的第三者来实现 间接引用。代理对象可以在客户端和目标对象之间起到 中介的作用，并且可以通过代理对象去掉客户不能看到 的内容和服务或者添加客户需要的额外服务。</p>
<h5 id="模式结构-11"><a href="#模式结构-11" class="headerlink" title="模式结构"></a>模式结构</h5><p>代理模式包含如下角色：</p>
<ul>
<li>Subject: 抽象主题角色</li>
<li>Proxy: 代理主题角色</li>
<li>RealSubject: 真实主题角色</li>
</ul>
<p><img src="/images/design-proxy-pattern-class.png" alt="代理模式类图"></p>
<h5 id="时序图-11"><a href="#时序图-11" class="headerlink" title="时序图"></a>时序图</h5><p><img src="/images/design-proxy-pattern-sequence.png" alt="代理模式时序图"></p>
<h5 id="源码-11"><a href="#源码-11" class="headerlink" title="源码"></a>源码</h5><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//使用示例</span></span><br><span class="line">    HCDschoolGirl *girl = [[HCDschoolGirl alloc] init];</span><br><span class="line">    girl.name = <span class="string">@&quot;哈哈哈哈哈&quot;</span>;</span><br><span class="line">    HCDproxy *proxy = [[HCDproxy alloc] initWithSchoolGirl:girl];</span><br><span class="line">    [proxy giveFlowers];</span><br><span class="line">    [proxy giveDolls];</span><br><span class="line">    [proxy giveChocolate]; </span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//HCDschoolGirl.h</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">HCDschoolGirl</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>,<span class="keyword">strong</span>)<span class="built_in">NSString</span> *name;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//HCDgiveGift.h</span></span><br><span class="line"><span class="class"><span class="keyword">@protocol</span> <span class="title">HCDgiveGift</span> &lt;<span class="title">NSObject</span>&gt;</span></span><br><span class="line"><span class="comment">///  送洋娃娃</span></span><br><span class="line">- (<span class="keyword">void</span>)giveDolls;</span><br><span class="line"></span><br><span class="line"><span class="comment">///  送鲜花</span></span><br><span class="line">- (<span class="keyword">void</span>)giveFlowers;</span><br><span class="line"></span><br><span class="line"><span class="comment">///  送巧克力</span></span><br><span class="line">- (<span class="keyword">void</span>)giveChocolate;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//HCDpursuit.m</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">HCDpursuit</span> ()</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>,<span class="keyword">strong</span>)HCDschoolGirl *schoolGirl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">HCDpursuit</span></span></span><br><span class="line">-(<span class="keyword">instancetype</span>)initWithSchoolGirl:(HCDschoolGirl *)schoolGirl&#123;</span><br><span class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> init];</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>) &#123;</span><br><span class="line">        _schoolGirl = schoolGirl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line">-(<span class="keyword">void</span>)giveChocolate&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;送你巧克力%@&quot;</span>,<span class="keyword">self</span>.schoolGirl.name);</span><br><span class="line">&#125;</span><br><span class="line">-(<span class="keyword">void</span>)giveDolls&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;送你洋娃娃%@&quot;</span>,<span class="keyword">self</span>.schoolGirl.name);</span><br><span class="line">&#125;</span><br><span class="line">-(<span class="keyword">void</span>)giveFlowers&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;送你玫瑰花%@&quot;</span>,<span class="keyword">self</span>.schoolGirl.name);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//HCDproxy.m</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">HCDproxy</span> ()</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">strong</span>, <span class="keyword">nonatomic</span>) HCDpursuit *pursuit;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">HCDproxy</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithSchoolGirl:(HCDschoolGirl *)schoolGirl &#123;</span><br><span class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> init];</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.pursuit = [[HCDpursuit alloc] initWithSchoolGirl:schoolGirl];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)giveDolls &#123;</span><br><span class="line">    [<span class="keyword">self</span>.pursuit giveDolls];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)giveFlowers &#123;</span><br><span class="line">    [<span class="keyword">self</span>.pursuit giveFlowers];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)giveChocolate &#123;</span><br><span class="line">    [<span class="keyword">self</span>.pursuit giveChocolate];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<h3 id="行为型模式"><a href="#行为型模式" class="headerlink" title="行为型模式"></a>行为型模式</h3><h4 id="迭代器模式"><a href="#迭代器模式" class="headerlink" title="迭代器模式"></a>迭代器模式</h4><h5 id="模式动机-13"><a href="#模式动机-13" class="headerlink" title="模式动机"></a>模式动机</h5><p>针对不同的需要，可能还要以不同的方式遍历整个聚合对象，但是我们并不希望在聚合对象的抽象层接口中充斥着各种不同遍历的操作。<br>怎样遍历一个聚合对象，又不需要了解聚合对象的内部结构，还能够提供多种不同的遍历方式，这就是迭代器模式的模式动机。</p>
<h5 id="模式定义-13"><a href="#模式定义-13" class="headerlink" title="模式定义"></a>模式定义</h5><p>提供一种方法顺序访问一个聚合对象中的各个元素，而又不暴露该对象的内部表示。</p>
<h5 id="模式结构-12"><a href="#模式结构-12" class="headerlink" title="模式结构"></a>模式结构</h5><p>模板方法模式包含如下角色：</p>
<ul>
<li>Aggregate: 聚集抽象类</li>
<li>ConcreteAggregate: 具体聚集类</li>
<li>Iterator: 迭代抽象类</li>
<li>ConcreteIterator: 具体迭代器类</li>
</ul>
<p><img src="/images/design-iterator-pattern-class.png" alt="迭代器模式类图"></p>
<h5 id="时序图-12"><a href="#时序图-12" class="headerlink" title="时序图"></a>时序图</h5><p>略</p>
<h5 id="源码-12"><a href="#源码-12" class="headerlink" title="源码"></a>源码</h5><p>略</p>
<h4 id="命令模式"><a href="#命令模式" class="headerlink" title="命令模式"></a>命令模式</h4><h5 id="模式动机-14"><a href="#模式动机-14" class="headerlink" title="模式动机"></a>模式动机</h5><p>在软件设计中，我们经常需要向某些对象发送请求，但是并不知道请求的接收者是谁，也不知道被请求的操作是哪个，我们只需在程序运行时指定具体的请求接收者即可，此时，可以使用命令模式来进行设计，使得请求发送者与请求接收者消除彼此之间的耦合，让对象之间的调用关系更加灵活。</p>
<p>命令模式可以对发送者和接收者完全解耦，发送者与接收者之间没有直接引用关系，发送请求的对象只需要知道如何发送请求，而不必知道如何完成请求。这就是命令模式的模式动机。</p>
<h5 id="模式定义-14"><a href="#模式定义-14" class="headerlink" title="模式定义"></a>模式定义</h5><p>命令模式(Command Pattern)：将一个请求封装为一个对象，从而使我们可用不同的请求对客户进行参数化；对请求排队或者记录请求日志，以及支持可撤销的操作。命令模式是一种对象行为型模式，其别名为动作(Action)模式或事务(Transaction)模式。</p>
<h5 id="模式结构-13"><a href="#模式结构-13" class="headerlink" title="模式结构"></a>模式结构</h5><p>命令模式包含如下角色：</p>
<ul>
<li>Command: 抽象命令类</li>
<li>ConcreteCommand: 具体命令类</li>
<li>Invoker: 调用者</li>
<li>Receiver: 接收者</li>
<li>Client:客户类</li>
</ul>
<p><img src="/images/design-command-pattern-class.png" alt="命令模式类图"></p>
<h5 id="时序图-13"><a href="#时序图-13" class="headerlink" title="时序图"></a>时序图</h5><p><img src="/images/design-command-pattern-sequence.png" alt="命令模式时序图"></p>
<h5 id="源码-13"><a href="#源码-13" class="headerlink" title="源码"></a>源码</h5><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//使用示例</span></span><br><span class="line">    <span class="comment">//waiter用于接收各种类型的order。waiter是请求接收者。</span></span><br><span class="line">    <span class="comment">//接收不同customer产生的不同order，并且都存入waiter这个接受者中,type表示不同类型的order。</span></span><br><span class="line">    HCDWaiter *waiter = [[HCDWaiter alloc]init];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//顾客一</span></span><br><span class="line">    HCDCustomr *customer = [[HCDCustomr alloc]init];</span><br><span class="line">    HCDOrder *customerOrder1 = [customer pushOrderWithString:<span class="string">@&quot;顾客一要十串羊肉&quot;</span> type:orderTypeMutton];</span><br><span class="line">    HCDOrder *customerOrder2 = [customer pushOrderWithString:<span class="string">@&quot;顾客一要十串鸭肉&quot;</span> type:orderTypeDuck];</span><br><span class="line">    [waiter addOrder:customerOrder1];</span><br><span class="line">    [waiter addOrder:customerOrder2];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//顾客二</span></span><br><span class="line">    HCDCustomr *customer1 = [[HCDCustomr alloc]init];</span><br><span class="line">    HCDOrder *customer1Order1 = [customer1 pushOrderWithString:<span class="string">@&quot;顾客二要二十串鸡肉&quot;</span> type:orderTypeChicken];</span><br><span class="line">    HCDOrder *customer1Order2 = [customer1 pushOrderWithString:<span class="string">@&quot;顾客二要二十串鸭肉&quot;</span> type:orderTypeDuck];</span><br><span class="line">    [waiter addOrder:customer1Order1];</span><br><span class="line">    [waiter addOrder:customer1Order2];</span><br><span class="line">    [waiter deleteOrder:customer1Order2];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//waiter发送order，背后有一个HCDWorker这个单列作为行为实现者来处理具体的order。命令接收完毕，开始发送命令。</span></span><br><span class="line">    [waiter notifyOrder];</span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//HCDCustomr.m</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">HCDCustomr</span></span></span><br><span class="line"></span><br><span class="line">-(HCDOrder *)pushOrderWithString:(<span class="built_in">NSString</span> *)string type:(orderType)type&#123;</span><br><span class="line">    HCDOrder *order = <span class="literal">nil</span>;</span><br><span class="line">    <span class="keyword">switch</span> (type) &#123;</span><br><span class="line">        <span class="keyword">case</span> orderTypeMutton:</span><br><span class="line">            order = [[HCDMuttonOrder alloc]initWithOrderString:string];</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> orderTypeChicken:</span><br><span class="line">            order = [[HCDChickenOrder alloc]initWithOrderString:string];</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> orderTypeDuck:</span><br><span class="line">            order = [[HCDDuckOrder alloc]initWithOrderString:string];</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> order;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//HCDWaiter.m</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">HCDWaiter</span></span></span><br><span class="line"></span><br><span class="line">-(<span class="keyword">instancetype</span>)init&#123;</span><br><span class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> init];</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>) &#123;</span><br><span class="line">        _orderList = [<span class="built_in">NSMutableArray</span> array];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line">-(<span class="keyword">void</span>)addOrder:(HCDOrder *)order&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;添加Order&quot;</span>);</span><br><span class="line">    [<span class="keyword">self</span>.orderList addObject:order];</span><br><span class="line">&#125;</span><br><span class="line">-(<span class="keyword">void</span>)deleteOrder:(HCDOrder *)order&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;取消Order&quot;</span>);</span><br><span class="line">    [<span class="keyword">self</span>.orderList removeObject:order];</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> 命令接收完毕，开始执行命令</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">-(<span class="keyword">void</span>)notifyOrder&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;====开始执行Order===&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (HCDOrder *order <span class="keyword">in</span> <span class="keyword">self</span>.orderList) &#123;</span><br><span class="line">        [order executeOrder];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//HCDOrder.h</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">HCDOrder</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>,<span class="keyword">copy</span>)<span class="built_in">NSString</span> *orderString;</span><br><span class="line"></span><br><span class="line">-(<span class="keyword">instancetype</span>)initWithOrderString:(<span class="built_in">NSString</span> *)orderString;</span><br><span class="line"><span class="comment">//执行命令</span></span><br><span class="line">-(<span class="keyword">void</span>)executeOrder;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//HCDMuttonOrder.m</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">HCDMuttonOrder</span></span></span><br><span class="line"></span><br><span class="line">-(<span class="keyword">void</span>)executeOrder&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;烤羊&quot;</span>);</span><br><span class="line">    [[HCDWorker sharedWorker] doMuttonWork:<span class="keyword">self</span>.orderString];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//HCDChickenOrder.m</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">HCDChickenOrder</span></span></span><br><span class="line"></span><br><span class="line">-(<span class="keyword">void</span>)executeOrder&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;烤鸡&quot;</span>);</span><br><span class="line">    [[HCDWorker sharedWorker] doChickenWork:<span class="keyword">self</span>.orderString];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//HCDDuckOrder.m</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">HCDDuckOrder</span></span></span><br><span class="line"></span><br><span class="line">-(<span class="keyword">void</span>)executeOrder&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;烤鸭&quot;</span>);</span><br><span class="line">    [[HCDWorker sharedWorker] doChickenWork:<span class="keyword">self</span>.orderString];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span> </span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//HCDWorker.h</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">HCDWorker</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line">+(<span class="keyword">instancetype</span>)sharedWorker;</span><br><span class="line"></span><br><span class="line">-(<span class="keyword">void</span>)doMuttonWork:(<span class="built_in">NSString</span> *)work;</span><br><span class="line"></span><br><span class="line">-(<span class="keyword">void</span>)doChickenWork:(<span class="built_in">NSString</span> *)work;</span><br><span class="line"></span><br><span class="line">-(<span class="keyword">void</span>)doDuckWork:(<span class="built_in">NSString</span> *)work;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<h4 id="中介者模式"><a href="#中介者模式" class="headerlink" title="中介者模式"></a>中介者模式</h4><h5 id="模式动机-15"><a href="#模式动机-15" class="headerlink" title="模式动机"></a>模式动机</h5><ul>
<li>在用户与用户直接聊天的设计方案中，用户对象之间存在很强的关联性，将导致系统出现如下问题：</li>
<li>系统结构复杂：对象之间存在大量的相互关联和调用，若有一个对象发生变化，则需要跟踪和该对象关联的其他所有对象，并进行适当处理。</li>
<li>对象可重用性差：由于一个对象和其他对象具有很强的关联，若没有其他对象的支持，一个对象很难被另一个系统或模块重用，这些对象表现出来更像一个不可分割的整体，职责较为混乱。</li>
<li>系统扩展性低：增加一个新的对象需要在原有相关对象上增加引用，增加新的引用关系也需要调整原有对象，系统耦合度很高，对象操作很不灵活，扩展性差。</li>
<li>在面向对象的软件设计与开发过程中，根据“单一职责原则”，我们应该尽量将对象细化，使其只负责或呈现单一的职责。</li>
<li>对于一个模块，可能由很多对象构成，而且这些对象之间可能存在相互的引用，为了减少对象两两之间复杂的引用关系，使之成为一个松耦合的系统，我们需要使用中介者模式，这就是中介者模式的模式动机。</li>
</ul>
<h5 id="模式定义-15"><a href="#模式定义-15" class="headerlink" title="模式定义"></a>模式定义</h5><p>中介者模式(Mediator Pattern)定义：用一个中介对象来封装一系列的对象交互，中介者使各对象不需要显式地相互引用，从而使其耦合松散，而且可以独立地改变它们之间的交互。它是一种对象行为型模式。</p>
<h5 id="模式结构-14"><a href="#模式结构-14" class="headerlink" title="模式结构"></a>模式结构</h5><p>中介者模式包含如下角色：</p>
<ul>
<li>Mediator: 抽象中介者</li>
<li>ConcreteMediator: 具体中介者</li>
<li>Colleague: 抽象同事类</li>
<li>ConcreteColleague: 具体同事类</li>
</ul>
<p><img src="/images/design-mediator-pattern-class.png" alt="中介者模式类图"></p>
<h5 id="时序图-14"><a href="#时序图-14" class="headerlink" title="时序图"></a>时序图</h5><p><img src="/images/design-mediator-pattern-sequence.png" alt="中介者模式时序图"></p>
<h5 id="源码-14"><a href="#源码-14" class="headerlink" title="源码"></a>源码</h5><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//使用示例</span></span><br><span class="line">ConcreteMediator *mediator = [[ConcreteMediator alloc] init];</span><br><span class="line"></span><br><span class="line"><span class="comment">//初始化并且让两个同事有相同的中介者对象</span></span><br><span class="line">ConcreteColleague1 *c1 = [[ConcreteColleague1 alloc] initWithMediator:mediator];</span><br><span class="line">ConcreteColleague2 *c2 = [[ConcreteColleague2 alloc] initWithMediator:mediator];</span><br><span class="line"></span><br><span class="line"><span class="comment">//给中介者对象绑定两个要交互的同事对象</span></span><br><span class="line">mediator.colleague1 = c1;</span><br><span class="line">mediator.colleague2 = c2;</span><br><span class="line"></span><br><span class="line">[c1 send:<span class="string">@&quot;吃过饭了吗？&quot;</span>];</span><br><span class="line">[c2 send:<span class="string">@&quot;没有呢，你打算请客？&quot;</span>];</span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Mediator.h</span></span><br><span class="line"><span class="class"><span class="keyword">@class</span> <span class="title">Colleague</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Mediator</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) Colleague *colleague1;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) Colleague *colleague2;</span><br><span class="line"></span><br><span class="line">-(<span class="keyword">void</span>)send:(<span class="built_in">NSString</span> *)message colleague:(Colleague *)colleague;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ConcreteMediator.m</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ConcreteMediator</span></span></span><br><span class="line"></span><br><span class="line">-(<span class="keyword">void</span>)send:(<span class="built_in">NSString</span> *)message colleague:(Colleague *)colleague&#123;</span><br><span class="line">    <span class="keyword">if</span> (colleague == <span class="keyword">self</span>.colleague1) &#123;</span><br><span class="line">        [<span class="keyword">self</span>.colleague2 notify:message];</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        [<span class="keyword">self</span>.colleague1 notify:message];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Colleague.h</span></span><br><span class="line"><span class="class"><span class="keyword">@class</span> <span class="title">Mediator</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Colleague</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) Mediator *mediator;</span><br><span class="line"></span><br><span class="line">-(<span class="keyword">instancetype</span>)initWithMediator:(Mediator *)mediator;</span><br><span class="line"></span><br><span class="line">-(<span class="keyword">void</span>)notify:(<span class="built_in">NSString</span> *)message;</span><br><span class="line"></span><br><span class="line">-(<span class="keyword">void</span>)send:(<span class="built_in">NSString</span> *)message;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ConcreteColleague1.m</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ConcreteColleague1</span></span></span><br><span class="line"></span><br><span class="line">-(<span class="keyword">instancetype</span>)initWithMediator:(Mediator *)mediator&#123;</span><br><span class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> init];</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.mediator = mediator;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-(<span class="keyword">void</span>)send:(<span class="built_in">NSString</span> *)message&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;同事1发送了信息&quot;</span>);</span><br><span class="line">    [<span class="keyword">self</span>.mediator send:message colleague:<span class="keyword">self</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-(<span class="keyword">void</span>)notify:(<span class="built_in">NSString</span> *)message&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@%@&quot;</span>,<span class="string">@&quot;同事1得到消息:&quot;</span>, message);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ConcreteColleague2.m</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ConcreteColleague2</span></span></span><br><span class="line"></span><br><span class="line">-(<span class="keyword">instancetype</span>)initWithMediator:(Mediator *)mediator&#123;</span><br><span class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> init];</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.mediator = mediator;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-(<span class="keyword">void</span>)send:(<span class="built_in">NSString</span> *)message&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;同事2发送了信息&quot;</span>);</span><br><span class="line">    [<span class="keyword">self</span>.mediator send:message colleague:<span class="keyword">self</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-(<span class="keyword">void</span>)notify:(<span class="built_in">NSString</span> *)message&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@%@&quot;</span>,<span class="string">@&quot;同事2得到消息&quot;</span>, message);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<h4 id="观察者模式"><a href="#观察者模式" class="headerlink" title="观察者模式"></a>观察者模式</h4><h5 id="模式动机-16"><a href="#模式动机-16" class="headerlink" title="模式动机"></a>模式动机</h5><p>建立一种对象与对象之间的依赖关系，一个对象发生改变时将自动通知其他对象，其他对象将相应做出反应。在此，发生改变的对象称为观察目标，而被通知的对象称为观察者，一个观察目标可以对应多个观察者，而且这些观察者之间没有相互联系，可以根据需要增加和删除观察者，使得系统更易于扩展，这就是观察者模式的模式动机。</p>
<h5 id="模式定义-16"><a href="#模式定义-16" class="headerlink" title="模式定义"></a>模式定义</h5><p>观察者模式(Observer Pattern)：定义对象间的一种一对多依赖关系，使得每当一个对象状态发生改变时，其相关依赖对象皆得到通知并被自动更新。观察者模式是一种对象行为型模式。</p>
<h5 id="模式结构-15"><a href="#模式结构-15" class="headerlink" title="模式结构"></a>模式结构</h5><p>观察者模式包含如下角色：</p>
<ul>
<li>Subject: 目标</li>
<li>ConcreteSubject: 具体目标</li>
<li>Observer: 观察者</li>
<li>ConcreteObserver: 具体观察者</li>
</ul>
<p><img src="/images/design-observes-pattern-class.png"></p>
<h5 id="时序图-15"><a href="#时序图-15" class="headerlink" title="时序图"></a>时序图</h5><p><img src="/images/design-observer-pattern-sequence.png"></p>
<h5 id="源码-15"><a href="#源码-15" class="headerlink" title="源码"></a>源码</h5><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//使用示例</span></span><br><span class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</span><br><span class="line">    [<span class="keyword">super</span> viewDidLoad];</span><br><span class="line">    </span><br><span class="line">    HCDServiceCenter *serviceCenter = [[HCDServiceCenter alloc] init];</span><br><span class="line">    </span><br><span class="line">    [serviceCenter addDelegate:<span class="keyword">self</span>.nbaobserver];</span><br><span class="line">    [serviceCenter addDelegate:<span class="keyword">self</span>.stockobserver];</span><br><span class="line">    [serviceCenter addDelegate:<span class="keyword">self</span>.gameObserver];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;秘书通知：老板回来了，大家赶紧撤&quot;</span>); </span><br><span class="line">    [serviceCenter notifyServiceDelegate:<span class="keyword">@selector</span>(update)</span><br><span class="line">                                 perform:^(<span class="keyword">id</span> responder) &#123;</span><br><span class="line">                                     [responder update];</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> mark - getter &amp; setter</span></span><br><span class="line"></span><br><span class="line">-(HCDNBAObserver *)nbaobserver &#123;</span><br><span class="line">    <span class="keyword">if</span> (!_nbaobserver) &#123;</span><br><span class="line">        _nbaobserver = [[HCDNBAObserver alloc] init];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> _nbaobserver;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-(HCDStockObserver *)stockobserver &#123;</span><br><span class="line">    <span class="keyword">if</span> (!_stockobserver) &#123;</span><br><span class="line">      _stockobserver = [[HCDStockObserver alloc] init];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> _stockobserver;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-(HCDGameObserver *)gameObserver &#123;</span><br><span class="line">    <span class="keyword">if</span> (!_gameObserver) &#123;</span><br><span class="line">        _gameObserver = [[HCDGameObserver alloc] init];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> _gameObserver;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//HCDServiceCenter.h</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">HCDServiceCenter</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) <span class="built_in">NSHashTable</span> *responders;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithNotifyQueue:(<span class="built_in">dispatch_queue_t</span>)notifyQueue;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)addDelegate:(<span class="keyword">id</span>)delegate;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)removeDelegate:(<span class="keyword">id</span>)delegate;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)notifyServiceDelegate:(SEL)aSelector</span><br><span class="line">                      perform:(<span class="keyword">void</span> (^)(<span class="keyword">id</span> responder))perform;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//HCDServiceCenter.m</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOCK(...) dispatch_semaphore_wait(_lock, DISPATCH_TIME_FOREVER); \</span></span><br><span class="line"><span class="meta">__VA_ARGS__; \</span></span><br><span class="line"><span class="meta">dispatch_semaphore_signal(_lock);</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">HCDServiceCenter</span>()</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">dispatch_queue_t</span> notifyQueue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSHashTable</span> *responders;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">HCDServiceCenter</span> </span>&#123;</span><br><span class="line">    dispatch_semaphore_t _lock;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)init &#123;</span><br><span class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> init];</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.responders = [<span class="built_in">NSHashTable</span> weakObjectsHashTable];</span><br><span class="line">        <span class="keyword">self</span>.notifyQueue = dispatch_get_main_queue();</span><br><span class="line">        _lock = dispatch_semaphore_create(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithNotifyQueue:(<span class="built_in">dispatch_queue_t</span>)notifyQueue &#123;</span><br><span class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> init];</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.responders = [<span class="built_in">NSHashTable</span> weakObjectsHashTable];</span><br><span class="line">        <span class="keyword">self</span>.notifyQueue = notifyQueue;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)addDelegate:(<span class="keyword">id</span>)delegate &#123; </span><br><span class="line">    LOCK([<span class="keyword">self</span>.responders addObject:delegate]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)removeDelegate:(<span class="keyword">id</span>)delegate &#123;</span><br><span class="line">    LOCK([<span class="keyword">self</span>.responders removeObject:delegate]); </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)notifyServiceDelegate:(SEL)aSelector</span><br><span class="line">                      perform:(<span class="keyword">void</span> (^)(<span class="keyword">id</span> responder))perform &#123;</span><br><span class="line">    <span class="built_in">dispatch_async</span>(<span class="keyword">self</span>.notifyQueue, ^&#123;</span><br><span class="line">        <span class="built_in">NSArray</span> *responders = <span class="keyword">self</span>.responders.allObjects;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">id</span> responder <span class="keyword">in</span> responders) &#123;</span><br><span class="line">            <span class="keyword">if</span> ([responder respondsToSelector:aSelector]) &#123;</span><br><span class="line">                <span class="keyword">@try</span> &#123;</span><br><span class="line">                    perform(responder);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">@catch</span> (<span class="built_in">NSException</span> *exception) &#123;</span><br><span class="line">                    <span class="built_in">NSLog</span>(<span class="string">@&quot;catch notifyServiceDelegate exception: %@&quot;</span>, exception);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//HCDObserver.h</span></span><br><span class="line"><span class="class"><span class="keyword">@protocol</span> <span class="title">HCDObserver</span> &lt;<span class="title">NSObject</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@optional</span></span><br><span class="line">- (<span class="keyword">void</span>)update;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//HCDStockObserver.h</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">HCDStockObserver</span> : <span class="title">NSObject</span>&lt;<span class="title">HCDObserver</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//HCDNBAObserver.h</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">HCDNBAObserver</span> : <span class="title">NSObject</span>&lt;<span class="title">HCDObserver</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//HCDGameObserver.h</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">HCDGameObserver</span> : <span class="title">NSObject</span>&lt;<span class="title">HCDObserver</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<h4 id="状态模式"><a href="#状态模式" class="headerlink" title="状态模式"></a>状态模式</h4><h5 id="模式动机-17"><a href="#模式动机-17" class="headerlink" title="模式动机"></a>模式动机</h5><p>在很多情况下，一个对象的行为取决于一个或多个动态变化的属性，这样的属性叫做状态，这样的对象叫做有状态的(stateful)对象，这样的对象状态是从事先定义好的一系列值中取出的。当一个这样的对象与外部事件产生互动时，其内部状态就会改变，从而使得系统的行为也随之发生变化。</p>
<p>状态模式主要解决的是当控制一个对象状态转换的条件表达式过于负责时的情况。把状态的判断逻辑转移到表示不同状态的一系列类当中，可以把复杂的判断逻辑简化。</p>
<h5 id="模式定义-17"><a href="#模式定义-17" class="headerlink" title="模式定义"></a>模式定义</h5><p>允许一个对象在其内部状态改变时改变它的行为，对象看起来似乎修改了它的类。状态模式是一种对象行为型模式。</p>
<h5 id="模式结构-16"><a href="#模式结构-16" class="headerlink" title="模式结构"></a>模式结构</h5><p>状态模式包含如下角色：</p>
<ul>
<li>Context: 环境类</li>
<li>State: 抽象状态类</li>
<li>ConcreteState: 具体状态类</li>
</ul>
<p><img src="/images/design-state-pattern-class.png" alt="状态模式类图"></p>
<h5 id="时序图-16"><a href="#时序图-16" class="headerlink" title="时序图"></a>时序图</h5><p><img src="/images/design-state-pattern-sequence.png" alt="状态模式类图"></p>
<h5 id="源码-16"><a href="#源码-16" class="headerlink" title="源码"></a>源码</h5><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//使用示例</span></span><br><span class="line">HCDWork *work = [[HCDWork alloc]init];</span><br><span class="line">work.hour = <span class="number">9</span>;</span><br><span class="line">[work writeProgram];</span><br><span class="line"></span><br><span class="line">work.hour = <span class="number">10</span>;</span><br><span class="line">[work writeProgram];</span><br><span class="line"></span><br><span class="line">work.hour = <span class="number">12</span>;</span><br><span class="line">[work writeProgram];</span><br><span class="line"></span><br><span class="line">work.hour = <span class="number">13</span>;</span><br><span class="line">[work writeProgram];</span><br><span class="line"></span><br><span class="line">work.hour = <span class="number">14</span>;</span><br><span class="line">[work writeProgram];</span><br><span class="line"></span><br><span class="line">work.hour = <span class="number">17</span>;</span><br><span class="line">[work writeProgram];</span><br><span class="line"></span><br><span class="line">work.finished = <span class="literal">NO</span>;</span><br><span class="line">[work writeProgram];</span><br><span class="line"></span><br><span class="line">work.hour = <span class="number">19</span>;</span><br><span class="line">[work writeProgram];</span><br><span class="line"></span><br><span class="line">work.hour = <span class="number">22</span>;</span><br><span class="line">[work writeProgram];</span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//HCDWork.h</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">HCDWork</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">CGFloat</span> hour;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">BOOL</span> finished;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)writeProgram;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)changeState:(HCDState *)state;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//HCDWork.m</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">HCDWork</span>()</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) HCDState *state;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">HCDWork</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)init&#123;</span><br><span class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> init];</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.state = [[HCDForenoonState alloc]init];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)writeProgram &#123;</span><br><span class="line">    [<span class="keyword">self</span>.state writeProgram:<span class="keyword">self</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)changeState:(HCDState *)state &#123;</span><br><span class="line">    <span class="keyword">self</span>.state = state;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//HCDProtocol.h</span></span><br><span class="line"><span class="class"><span class="keyword">@class</span> <span class="title">HCDWork</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">@protocol</span> <span class="title">HCDProtocol</span> &lt;<span class="title">NSObject</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@optional</span></span><br><span class="line">- (<span class="keyword">void</span>)writeProgram:(HCDWork *)work;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//HCDState.h</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">HCDState</span> : <span class="title">NSObject</span>&lt;<span class="title">HCDProtocol</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//HCDForenoonState.m</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">HCDForenoonState</span></span></span><br><span class="line"></span><br><span class="line">-(<span class="keyword">void</span>)writeProgram:(HCDWork *)work&#123;</span><br><span class="line">    <span class="keyword">if</span> (work.hour &lt; <span class="number">12</span>) &#123;</span><br><span class="line">         <span class="built_in">NSLog</span>(<span class="string">@&quot;当前时间：&#123;%.f&#125;点，上午工作，精神百倍&quot;</span>, work.hour);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        HCDNoonState *noonState = [[HCDNoonState alloc] init];</span><br><span class="line">        [work changeState:noonState];</span><br><span class="line">        [work writeProgram];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//HCDNoonState.m</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">HCDNoonState</span></span></span><br><span class="line"></span><br><span class="line">-(<span class="keyword">void</span>)writeProgram:(HCDWork *)work&#123;</span><br><span class="line">    <span class="keyword">if</span> (work.hour &lt; <span class="number">13</span>) &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;当前时间：&#123;%.f&#125;点，饿了，午饭；犯困，午休&quot;</span>, work.hour);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        HCDAfternoonState *afternoonState = [[HCDAfternoonState alloc] init];</span><br><span class="line">        [work changeState:afternoonState];</span><br><span class="line">        [work writeProgram];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//HCDAfternoonState.m</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">HCDAfternoonState</span></span></span><br><span class="line"></span><br><span class="line">-(<span class="keyword">void</span>)writeProgram:(HCDWork *)work&#123;</span><br><span class="line">    <span class="keyword">if</span> (work.hour &lt; <span class="number">17</span>) &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;当前时间：&#123;%.f&#125;点，下午状态还不错，继续努力&quot;</span>, work.hour);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        HCDEventState *eventState = [[HCDEventState alloc] init];</span><br><span class="line">        [work changeState:eventState];</span><br><span class="line">        [work writeProgram];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//HCDEventState.m</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">HCDEventState</span></span></span><br><span class="line"></span><br><span class="line">-(<span class="keyword">void</span>)writeProgram:(HCDWork *)work&#123;</span><br><span class="line">    <span class="keyword">if</span> (work.finished) &#123;</span><br><span class="line">        HCDRestState *restState = [[HCDRestState alloc] init];</span><br><span class="line">        [work changeState:restState];</span><br><span class="line">        [work writeProgram];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (work.hour &lt; <span class="number">21</span>) &#123;</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@&quot;当前时间：&#123;%.f&#125;点，加班哦，疲累之极&quot;</span>, work.hour);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            HCDSleepState *sleepState = [[HCDSleepState alloc] init];</span><br><span class="line">            [work changeState:sleepState]; </span><br><span class="line">            [work writeProgram];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//HCDSleepState.m</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">HCDSleepState</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)writeProgram:(HCDWork *)work &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;当前时间：&#123;%.f&#125;点，不行了，睡着了&quot;</span>, work.hour);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//HCDRestState.m</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">HCDRestState</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)writeProgram:(HCDWork *)work &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;当前时间：&#123;%.f&#125;点，下班回家了&quot;</span>, work.hour);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<h4 id="策略模式"><a href="#策略模式" class="headerlink" title="策略模式"></a>策略模式</h4><h5 id="模式动机-18"><a href="#模式动机-18" class="headerlink" title="模式动机"></a>模式动机</h5><ul>
<li>完成一项任务，往往可以有多种不同的方式，每一种方式称为一个策略，我们可以根据环境或者条件的不同选择不同的策略来完成该项任务。</li>
<li>在软件开发中也常常遇到类似的情况，实现某一个功能有多个途径，此时可以使用一种设计模式来使得系统可以灵活地选择解决途径，也能够方便地增加新的解决途径。</li>
<li>为了解决这些问题，可以定义一些独立的类来封装不同的算法，每一个类封装一个具体的算法，在这里，每一个封装算法的类我们都可以称之为策略(Strategy)，为了保证这些策略的一致性，一般会用一个抽象的策略类来做算法的定义，而具体每种算法则对应于一个具体策略类。</li>
</ul>
<h5 id="模式定义-18"><a href="#模式定义-18" class="headerlink" title="模式定义"></a>模式定义</h5><p>定义了算法家族，分别封装起来，让它们之间可以互相替换，此模式让算法的变化，不会影响到使用算法的客户。</p>
<h5 id="模式结构-17"><a href="#模式结构-17" class="headerlink" title="模式结构"></a>模式结构</h5><p>策略模式包含如下角色：</p>
<ul>
<li>Context: 环境类</li>
<li>Strategy: 抽象策略类</li>
<li>ConcreteStrategy: 具体策略类</li>
</ul>
<p><img src="/images/design-strategy-pattern-class.png" alt="策略模式类图"></p>
<h5 id="时序图-17"><a href="#时序图-17" class="headerlink" title="时序图"></a>时序图</h5><p><img src="/images/design-strategy-pattern-sequence.png" alt="策略模式时序图"></p>
<h5 id="源码-17"><a href="#源码-17" class="headerlink" title="源码"></a>源码</h5><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//使用示例</span></span><br><span class="line">HCDCashContext *context = [[HCDCashContext alloc] initWithCashType:HCDCashTypeNormal];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@&quot;结果是%f&quot;</span>,[context getResult:<span class="number">100</span>]);</span><br><span class="line"></span><br><span class="line">HCDCashContext *contextReturn = [[HCDCashContext alloc] initWithCashType:HCDCashTypeReturn];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@&quot;结果是%f&quot;</span>,[contextReturn getResult:<span class="number">100</span>]);</span><br><span class="line"></span><br><span class="line">HCDCashContext *contextRobate = [[HCDCashContext alloc] initWithCashType:HCDCashTypeRobate];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@&quot;结果是%f&quot;</span>,[contextRobate getResult:<span class="number">100</span>]);</span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//HCDCashContext.h</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="built_in">NS_ENUM</span>(<span class="built_in">NSInteger</span>, HCDCashType)&#123;</span><br><span class="line">    HCDCashTypeNormal = <span class="number">0</span>,</span><br><span class="line">    HCDCashTypeRobate,</span><br><span class="line">    HCDCashTypeReturn</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">HCDCashContext</span> : <span class="title">NSObject</span> </span></span><br><span class="line"></span><br><span class="line">-(<span class="keyword">instancetype</span>)initWithCashType:(HCDCashType)type;</span><br><span class="line"></span><br><span class="line">-(<span class="built_in">CGFloat</span>)getResult:(<span class="built_in">CGFloat</span>)money;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//HCDCashContext.m</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">HCDCashContext</span>()</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="keyword">id</span>&lt;HCDCashProtocol&gt; cash;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">HCDCashContext</span> </span></span><br><span class="line"></span><br><span class="line">-(<span class="keyword">instancetype</span>)initWithCashType:(HCDCashType)type&#123;</span><br><span class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> init];</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>) &#123;</span><br><span class="line">        [<span class="keyword">self</span> cofigureWithCashType:type];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)cofigureWithCashType:(HCDCashType)type &#123;</span><br><span class="line">    <span class="keyword">switch</span> (type) &#123;</span><br><span class="line">        <span class="keyword">case</span> HCDCashTypeNormal: &#123;</span><br><span class="line">            <span class="keyword">self</span>.cash = [[HCDCashNormal alloc] init];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> HCDCashTypeRobate: &#123;</span><br><span class="line">            <span class="keyword">self</span>.cash = [[HCDCashRobate alloc] initWithMoneyRebate:<span class="number">0.8</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> HCDCashTypeReturn: &#123;</span><br><span class="line">            <span class="keyword">self</span>.cash = [[HCDCaseReturn alloc] initWithMoneyReturn:<span class="number">5</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">CGFloat</span>)getResult:(<span class="built_in">CGFloat</span>)money &#123;</span><br><span class="line">    <span class="keyword">return</span> [<span class="keyword">self</span>.cash acceptCash:money];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//HCDCashProtocol.h</span></span><br><span class="line"><span class="class"><span class="keyword">@protocol</span> <span class="title">HCDCashProtocol</span> &lt;<span class="title">NSObject</span>&gt;</span></span><br><span class="line"></span><br><span class="line">- (<span class="built_in">CGFloat</span>)acceptCash:(<span class="built_in">CGFloat</span>)cash;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//HCDCaseReturn.h</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">HCDCaseReturn</span> : <span class="title">NSObject</span>&lt;<span class="title">HCDCashProtocol</span>&gt;</span></span><br><span class="line"></span><br><span class="line">-(<span class="keyword">instancetype</span>)initWithMoneyReturn:(<span class="built_in">CGFloat</span>)moneyReturn;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//HCDCaseReturn.m</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">HCDCaseReturn</span> ()</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>)<span class="built_in">CGFloat</span> moneyReturn;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">HCDCaseReturn</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> mark - life cycle</span></span><br><span class="line"></span><br><span class="line">-(<span class="keyword">instancetype</span>)initWithMoneyReturn:(<span class="built_in">CGFloat</span>)moneyReturn&#123;</span><br><span class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> init];</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>) &#123;</span><br><span class="line">        _moneyReturn = moneyReturn;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> mark - HCDCashProtocol</span></span><br><span class="line"></span><br><span class="line">-(<span class="built_in">CGFloat</span>)acceptCash:(<span class="built_in">CGFloat</span>)cash&#123;</span><br><span class="line">    <span class="keyword">return</span> cash - <span class="keyword">self</span>.moneyReturn;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//HCDCashNormal.m</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">HCDCashNormal</span></span></span><br><span class="line"> </span><br><span class="line">-(<span class="built_in">CGFloat</span>)acceptCash:(<span class="built_in">CGFloat</span>)cash&#123;</span><br><span class="line">    <span class="keyword">return</span> cash;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//HCDCashRobate.h</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">HCDCashRobate</span> : <span class="title">NSObject</span>&lt;<span class="title">HCDCashProtocol</span>&gt;</span></span><br><span class="line"></span><br><span class="line">-(<span class="keyword">instancetype</span>)initWithMoneyRebate:(<span class="built_in">CGFloat</span>)moneyRebate;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//HCDCashRobate.m</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">HCDCashRobate</span> ()</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">CGFloat</span> moneyRebate;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">HCDCashRobate</span></span></span><br><span class="line"></span><br><span class="line">-(<span class="keyword">instancetype</span>)initWithMoneyRebate:(<span class="built_in">CGFloat</span>)moneyRebate&#123;</span><br><span class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> init];</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>) &#123;</span><br><span class="line">        _moneyRebate = moneyRebate;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-(<span class="built_in">CGFloat</span>)acceptCash:(<span class="built_in">CGFloat</span>)cash&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>.moneyRebate * cash;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<h4 id="模板方法模式"><a href="#模板方法模式" class="headerlink" title="模板方法模式"></a>模板方法模式</h4><h5 id="模式动机-19"><a href="#模式动机-19" class="headerlink" title="模式动机"></a>模式动机</h5><p>模板方法模式是基于继承的代码复用基本技术，模板方法模式的结构和用法也是面向对象设计的核心之一。<br>在模板方法模式中，可以将相同的代码放在父类中，而将不同的方法实现放在不同的子类中。</p>
<h5 id="模式定义-19"><a href="#模式定义-19" class="headerlink" title="模式定义"></a>模式定义</h5><p>定义一个操作中的算法的骨架，而将一些步骤延迟到子类中。模板方法使得子类可以不改变一个算法的结构即可重定义该算法的某些特定步骤。</p>
<h5 id="模式结构-18"><a href="#模式结构-18" class="headerlink" title="模式结构"></a>模式结构</h5><p>模板方法模式包含如下角色：</p>
<ul>
<li>AbstractClass: 抽象类 </li>
<li>ConcreteClass: 具体子类</li>
</ul>
<p><img src="/images/design-template-method-class.png" alt="策略模式类图"></p>
<h5 id="时序图-18"><a href="#时序图-18" class="headerlink" title="时序图"></a>时序图</h5><p>略</p>
<h5 id="源码-18"><a href="#源码-18" class="headerlink" title="源码"></a>源码</h5><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//使用示例</span></span><br><span class="line">HCDtextPaper *paperA = [[HCDtextPaperA alloc]init];</span><br><span class="line">[paperA testQuestion1];</span><br><span class="line">[paperA testQuestion2];</span><br><span class="line"></span><br><span class="line">HCDtextPaper *paperB = [[HCDtextPaperB alloc]init];</span><br><span class="line">[paperB testQuestion1];</span><br><span class="line">[paperB testQuestion2];</span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//HCDtextPaper.h</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">HCDtextPaper</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)testQuestion1;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)testQuestion2;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> 子类需要重写这个方法</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> @return 结果</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (<span class="built_in">NSString</span> *)answer1;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> 子类需要重写这个方法</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment"> @return 结果</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (<span class="built_in">NSString</span> *)answer2;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//HCDtextPaper.m</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">HCDtextPaper</span></span></span><br><span class="line"></span><br><span class="line">-(<span class="keyword">void</span>)testQuestion1 &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;问题：杨过得到，后来给了郭靖，炼成倚天剑、屠龙刀的玄铁可能是[ ]：a.球磨铸铁 b.马口铁 c.高速合金钢 d.碳素纤维&quot;</span>);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;答案：%@&quot;</span>, [<span class="keyword">self</span> answer1]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-(<span class="built_in">NSString</span> *)answer1 &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">@&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-(<span class="keyword">void</span>)testQuestion2 &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;问题：杨过、程英、陆无双铲除了情花，造成[ ]：a.使这种植物不再害人 b.使一种珍稀物种灭绝 c.破坏了那个生物圈的生态平衡 d.造成该地区沙漠化&quot;</span>);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;答案：%@&quot;</span>, [<span class="keyword">self</span> answer2]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-(<span class="built_in">NSString</span> *)answer2&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">@&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//HCDtextPaperA.m</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">HCDtextPaperA</span></span></span><br><span class="line"></span><br><span class="line">-(<span class="built_in">NSString</span> *)answer1&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">@&quot;b&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-(<span class="built_in">NSString</span> *)answer2&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">@&quot;c&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//HCDtextPaperB.m</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">HCDtextPaperB</span></span></span><br><span class="line"></span><br><span class="line">-(<span class="built_in">NSString</span> *)answer1&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">@&quot;a&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-(<span class="built_in">NSString</span> *)answer2&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">@&quot;d&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<h4 id="职责链模式"><a href="#职责链模式" class="headerlink" title="职责链模式"></a>职责链模式</h4><h5 id="模式动机-20"><a href="#模式动机-20" class="headerlink" title="模式动机"></a>模式动机</h5><p>很多情况下，在一个软件系统中可以处理某个请求的对象不止一个。例如采购审批子系统，主任、副董事长、董事长和董事会都可以处理采购单，他们可以构成一条处理采购单的链式结构，采购单(可以看作是要处理的信息)沿着这条链进行传递，这条链就称为责任链。责任链可以是一条直线、一个环或者一个树形结构，最常见的职责链是直线型，即沿着一条单向的链来传递请求，如下图所示。链上的每一个对象都是请求处理者，责任链模式可以将请求的处理者组织成一条链，并让请求沿着链传递，由链上的处理者对请求进行相应的处理。在此过程中，客户端实际上无须关心请求的处理细节以及请求的传递，只需将请求发送到链上即可，从而实现请求发送者和请求处理者解耦。 </p>
<h5 id="模式定义-20"><a href="#模式定义-20" class="headerlink" title="模式定义"></a>模式定义</h5><p>使多个对象都有机会处理请求，从而避免请求的发送者和接受者之间的耦合关系。将这个对象连成一条链，并沿着这条链传递该请求，直到有一个对象处理它为止。</p>
<h5 id="模式结构-19"><a href="#模式结构-19" class="headerlink" title="模式结构"></a>模式结构</h5><p>职责链模式包含如下角色：</p>
<ul>
<li>Handler: 处理者抽象类</li>
<li>ConcreteAggregate: 具体处理者类</li>
</ul>
<p><img src="/images/design-chain-of-responsibility-class.png" alt="职责链模式类图"></p>
<h5 id="时序图-19"><a href="#时序图-19" class="headerlink" title="时序图"></a>时序图</h5><p>略</p>
<h5 id="源码-19"><a href="#源码-19" class="headerlink" title="源码"></a>源码</h5><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//使用示例</span></span><br><span class="line">HCDCommonManager *jinli = [[HCDCommonManager alloc]initWithName:<span class="string">@&quot;经理&quot;</span>];</span><br><span class="line">HCDMajorManager *zongjian = [[HCDMajorManager alloc]initWithName:<span class="string">@&quot;总监&quot;</span>];</span><br><span class="line">HCDGenaralManager *zongjinli = [[HCDGenaralManager alloc]initWithName:<span class="string">@&quot;总经理&quot;</span>];</span><br><span class="line">jinli.superior = zongjian;</span><br><span class="line">zongjian.superior = zongjinli;</span><br><span class="line"></span><br><span class="line">HCDReuquest *request = [[HCDReuquest alloc] init];</span><br><span class="line">request.requestType = <span class="string">@&quot;请假&quot;</span>;</span><br><span class="line">request.requestContent = <span class="string">@&quot;小菜请假&quot;</span>;</span><br><span class="line">request.number = <span class="number">1</span>;</span><br><span class="line">[jinli dealRequest:request];</span><br><span class="line"></span><br><span class="line">HCDReuquest *request1 = [[HCDReuquest alloc] init];</span><br><span class="line">request1.requestType = <span class="string">@&quot;请假&quot;</span>;</span><br><span class="line">request1.requestContent = <span class="string">@&quot;小菜请假&quot;</span>;</span><br><span class="line">request1.number = <span class="number">4</span>;</span><br><span class="line">[jinli dealRequest:request1];</span><br><span class="line"></span><br><span class="line">HCDReuquest *request2 = [[HCDReuquest alloc] init];</span><br><span class="line">request2.requestType = <span class="string">@&quot;加薪&quot;</span>;</span><br><span class="line">request2.requestContent = <span class="string">@&quot;小菜请求加薪&quot;</span>;</span><br><span class="line">request2.number = <span class="number">500</span>;</span><br><span class="line">[jinli dealRequest:request2];</span><br><span class="line"></span><br><span class="line">HCDReuquest *request4 = [[HCDReuquest alloc] init];</span><br><span class="line">request4.requestType = <span class="string">@&quot;加薪&quot;</span>;</span><br><span class="line">request4.requestContent = <span class="string">@&quot;小菜请求加薪&quot;</span>;</span><br><span class="line">request4.number = <span class="number">1000</span>;</span><br><span class="line">[jinli dealRequest:request4];</span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//HCDMnager.h</span></span><br><span class="line"><span class="class"><span class="keyword">@class</span> <span class="title">HCDReuquest</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">HCDMnager</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *name;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) HCDMnager *superior;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithName:(<span class="built_in">NSString</span> *)name;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)dealRequest:(HCDReuquest *)request;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//HCDCommonManager.h</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">HCDCommonManager</span> : <span class="title">HCDMnager</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//HCDCommonManager.m</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">HCDCommonManager</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)dealRequest:(HCDReuquest *)request&#123;</span><br><span class="line">    <span class="keyword">if</span> ([request.requestType isEqualToString:<span class="string">@&quot;请假&quot;</span>] &amp;&amp; request.number &lt;= <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;%@:%@ 数量%ld 被批准&quot;</span>,<span class="keyword">self</span>.name,request.requestType,request.number);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">self</span>.superior) &#123;</span><br><span class="line">            [<span class="keyword">self</span>.superior dealRequest:request]; </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//HCDMajorManager.h</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">HCDMajorManager</span> : <span class="title">HCDMnager</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//HCDMajorManager.m</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">HCDMajorManager</span></span></span><br><span class="line"></span><br><span class="line">-(<span class="keyword">void</span>)dealRequest:(HCDReuquest *)request&#123;</span><br><span class="line">    <span class="keyword">if</span> ([request.requestType isEqualToString:<span class="string">@&quot;请假&quot;</span>] &amp;&amp; request.number &lt;= <span class="number">5</span>) &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;%@:%@ 数量%ld 被批准&quot;</span>,<span class="keyword">self</span>.name,request.requestType,request.number);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">self</span>.superior) &#123;</span><br><span class="line">            [<span class="keyword">self</span>.superior dealRequest:request];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//HCDGenaralManager.h</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">HCDGenaralManager</span> : <span class="title">HCDMnager</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//HCDGenaralManager.m</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">HCDGenaralManager</span></span></span><br><span class="line"></span><br><span class="line">-(<span class="keyword">void</span>)dealRequest:(HCDReuquest *)request&#123;</span><br><span class="line">    <span class="keyword">if</span> ([request.requestType isEqualToString:<span class="string">@&quot;请假&quot;</span>]) &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;%@:%@ 数量%ld 被批准&quot;</span>,<span class="keyword">self</span>.name,request.requestType,request.number);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([request.requestType isEqualToString:<span class="string">@&quot;加薪&quot;</span>])&#123;</span><br><span class="line">        <span class="keyword">if</span> (request.number &lt;= <span class="number">500</span>) &#123;</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@&quot;%@:%@ 数量%ld 被批准&quot;</span>,<span class="keyword">self</span>.name,request.requestType,request.number);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@&quot;%@:%@ 数量%ld 再说吧&quot;</span>,<span class="keyword">self</span>.name,request.requestType,request.number);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//HCDReuquest.h</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">HCDReuquest</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> 请求类型</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *requestType;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> 请求内容</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *requestContent;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> 请求的数量</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">NSInteger</span> number;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<h4 id="解释器模式"><a href="#解释器模式" class="headerlink" title="解释器模式"></a>解释器模式</h4><h5 id="模式动机-21"><a href="#模式动机-21" class="headerlink" title="模式动机"></a>模式动机</h5><p>如果在系统中某一特定类型的问题发生的频率很高，此时可以考虑将这些问题的实例表述为一个语言中的句子，因此可以构建一个解释器，该解释器通过解释这些句子来解决这些问题。<br>解释器模式描述了如何构成一个简单的语言解释器，主要应用在使用面向对象语言开发的编译器中。</p>
<h5 id="模式定义-21"><a href="#模式定义-21" class="headerlink" title="模式定义"></a>模式定义</h5><p>给定一种语言，定义它的文法的一种表示，并定义一个解释器，这个解释器使用该表示来解释语言中的句子。</p>
<h5 id="模式结构-20"><a href="#模式结构-20" class="headerlink" title="模式结构"></a>模式结构</h5><p>解释器模式模式包含如下角色：</p>
<ul>
<li>AbstractExpression: 抽象表达式</li>
<li>TerminalExpression: 终结符表达式</li>
<li>NonterminalExpression: 非终结符表达式</li>
<li>Context: 环境类</li>
<li>Client: 客户类</li>
</ul>
<p><img src="/images/design-interpreter-pattern-class.png" alt="解释器模式类图"></p>
<h5 id="时序图-20"><a href="#时序图-20" class="headerlink" title="时序图"></a>时序图</h5><p>略</p>
<h5 id="源码-20"><a href="#源码-20" class="headerlink" title="源码"></a>源码</h5><p>略</p>
<h4 id="访问者模式"><a href="#访问者模式" class="headerlink" title="访问者模式"></a>访问者模式</h4><h5 id="模式动机-22"><a href="#模式动机-22" class="headerlink" title="模式动机"></a>模式动机</h5><p>访问者模式的目的是封装一些施加于某种数据结构元素之上的操作，一旦这些操作需要修改的话，接受这个操作的数据结构可以保持不变。为不同类型的元素提供多种访问操作方式，且可以在不修改原有系统的情况下增加新的操作方式，这就是访问者模式的模式动机。</p>
<h5 id="模式定义-22"><a href="#模式定义-22" class="headerlink" title="模式定义"></a>模式定义</h5><p>表示一个作用于某对象结构中的各元素的操作。它使你可以在不改变各元素的类的前提下定义作用于这些元素的新操作。</p>
<h5 id="模式结构-21"><a href="#模式结构-21" class="headerlink" title="模式结构"></a>模式结构</h5><p>访问者模式包含如下角色：</p>
<ul>
<li>Vistor: 抽象访问者。为该对象结构中的ConcreteElement的每一个类声明的一个操作。 </li>
<li>ConcreteVisitor: 具体访问者。实现Visitor申明的每一个操作，每一个操作实现算法的一部分。 </li>
<li>Element: 抽象元素。定义一个Accept操作，它以一个访问者为参数。 </li>
<li>ConcreteElement: 具体元素 。实现Accept操作。 </li>
<li>ObjectStructure: 对象结构。能够枚举它的元素，可以提供一个高层的接口来允许访问者访问它的元素。</li>
</ul>
<p><img src="/images/design-visitor-pattern-class.png" alt="访问者模式类图"></p>
<h5 id="时序图-21"><a href="#时序图-21" class="headerlink" title="时序图"></a>时序图</h5><p>略</p>
<h5 id="源码-21"><a href="#源码-21" class="headerlink" title="源码"></a>源码</h5><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//使用示例</span></span><br><span class="line">HCDObjectStructure *o = [[HCDObjectStructure alloc]init];</span><br><span class="line"></span><br><span class="line"><span class="comment">//初始化不同的element对象</span></span><br><span class="line">HCDConcreteElementA *eA = [HCDConcreteElementA new];</span><br><span class="line">HCDConcreteElementB *eB = [HCDConcreteElementB new];</span><br><span class="line"><span class="comment">//加入o对象里面，存在一个数据结构o中。</span></span><br><span class="line">[o attach:eA];</span><br><span class="line">[o attach:eB];</span><br><span class="line"></span><br><span class="line"><span class="comment">//初始化不同的visitor对象。</span></span><br><span class="line">HCDConcreteVisitor1 *v1 = [HCDConcreteVisitor1 new];</span><br><span class="line">HCDConcreteVisitor2 *v2 = [HCDConcreteVisitor2 new];</span><br><span class="line"><span class="comment">//eA,eB(男人女人)接收到访问者v1(喜)的不同反应。</span></span><br><span class="line">[o accept:v1];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@&quot;================================&quot;</span>);</span><br><span class="line"><span class="comment">//eA,eB(男人女人)接收到访问者v2(怒)的不同反应。</span></span><br><span class="line">[o accept:v2];</span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//HCDObjectStructure.h</span></span><br><span class="line"><span class="class"><span class="keyword">@class</span> <span class="title">HCDElements</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">@class</span> <span class="title">HCDVisitors</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">HCDObjectStructure</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line">-(<span class="keyword">void</span>)attach:(HCDElements *)element;</span><br><span class="line"></span><br><span class="line">-(<span class="keyword">void</span>)detach:(HCDElements *)element;</span><br><span class="line"></span><br><span class="line">-(<span class="keyword">void</span>)accept:(HCDVisitors *)visitor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//HCDObjectStructure.m</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">HCDObjectStructure</span> ()</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSMutableArray</span> *elements;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">HCDObjectStructure</span></span></span><br><span class="line"></span><br><span class="line">-(<span class="keyword">instancetype</span>)init&#123;</span><br><span class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> init];</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>) &#123;</span><br><span class="line">        _elements = [[<span class="built_in">NSMutableArray</span> alloc]init];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-(<span class="keyword">void</span>)attach:(HCDElements *)element&#123;</span><br><span class="line">    [<span class="keyword">self</span>.elements addObject:element];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-(<span class="keyword">void</span>)detach:(HCDElements *)element&#123;</span><br><span class="line">    [<span class="keyword">self</span>.elements removeObject:element];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-(<span class="keyword">void</span>)accept:(HCDVisitors *)visitor&#123;</span><br><span class="line">    <span class="keyword">for</span> (HCDElements *e <span class="keyword">in</span> <span class="keyword">self</span>.elements) &#123;</span><br><span class="line">        [e accept:visitor];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//HCDVisitors.h</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">HCDVisitors</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line">-(<span class="keyword">void</span>)visitConcreteElementA:(HCDConcreteElementA *)concreteElementA;</span><br><span class="line"></span><br><span class="line">-(<span class="keyword">void</span>)visitConcreteElementB:(HCDConcreteElementB *)concreteElementB;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//HCDConcreteVisitor1.h</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">HCDConcreteVisitor1</span> : <span class="title">HCDVisitors</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//HCDConcreteVisitor1.m</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">HCDConcreteVisitor1</span></span></span><br><span class="line"></span><br><span class="line">-(<span class="keyword">void</span>)visitConcreteElementA:(HCDConcreteElementA *)concreteElementA&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;男人接收到喜这个visitor============我要飞&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-(<span class="keyword">void</span>)visitConcreteElementB:(HCDConcreteElementB *)concreteElementB&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;女人接收到喜这个visitor============我要跳&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//HCDConcreteVisitor2.h</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">HCDConcreteVisitor2</span> : <span class="title">HCDVisitors</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//HCDConcreteVisitor2.m</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">HCDConcreteVisitor2</span></span></span><br><span class="line"></span><br><span class="line">-(<span class="keyword">void</span>)visitConcreteElementA:(HCDConcreteElementA *)concreteElementA&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;男人接收到怒这个visitor============我要叫&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-(<span class="keyword">void</span>)visitConcreteElementB:(HCDConcreteElementB *)concreteElementB&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;女人接收到怒这个visitor============我要苦&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//HCDElements.h</span></span><br><span class="line"><span class="class"><span class="keyword">@class</span> <span class="title">HCDVisitors</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">HCDElements</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line">-(<span class="keyword">void</span>)accept:(HCDVisitors *)visitor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//HCDConcreteElementA.m</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">HCDConcreteElementA</span></span></span><br><span class="line"></span><br><span class="line">-(<span class="keyword">void</span>)operationA&#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-(<span class="keyword">void</span>)accept:(HCDVisitors *)visitor&#123;</span><br><span class="line">    [visitor visitConcreteElementA:<span class="keyword">self</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//HCDConcreteElementB.m</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">HCDConcreteElementB</span></span></span><br><span class="line"></span><br><span class="line">-(<span class="keyword">void</span>)operationB&#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-(<span class="keyword">void</span>)accept:(HCDVisitors *)visitor&#123;</span><br><span class="line">    [visitor visitConcreteElementB:<span class="keyword">self</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>在实际的项目开发过程中，使用某些特定的设计模式能够很好的解决问题。同时，在维护他人编写的代码时，如果对设计模式特别熟悉，遇到时也比较容易定位问题。<br>源码和demo请点<a target="_blank" rel="noopener" href="https://github.com/leverTsui/Design-Pattern-For-iOS">这里</a><br>参考的文章链接如下<br><a target="_blank" rel="noopener" href="http://design-patterns.readthedocs.io/zh_CN/latest/read_uml.html">Graphic Design Patterns</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://levertsui.github.io/2018/07/03/%E4%BD%BF%E7%94%A8%E4%BA%8B%E4%BB%B6%E5%93%8D%E5%BA%94%E9%93%BE%E5%A4%84%E7%90%86%E4%BA%8B%E4%BB%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="leverTsui">
      <meta itemprop="description" content="要有狮子的力量， 菩萨的心肠">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="leverTsui">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/07/03/%E4%BD%BF%E7%94%A8%E4%BA%8B%E4%BB%B6%E5%93%8D%E5%BA%94%E9%93%BE%E5%A4%84%E7%90%86%E4%BA%8B%E4%BB%B6/" class="post-title-link" itemprop="url">使用事件响应链处理事件</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-07-03 20:46:28" itemprop="dateCreated datePublished" datetime="2018-07-03T20:46:28+08:00">2018-07-03</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-02-08 09:46:16" itemprop="dateModified" datetime="2022-02-08T09:46:16+08:00">2022-02-08</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/iOS-%E6%8A%80%E5%B7%A7/" itemprop="url" rel="index"><span itemprop="name">iOS 技巧</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p>Apps receive and handle events using <em>responder objects</em>. A responder object is any instance of the <a target="_blank" rel="noopener" href="https://developer.apple.com/documentation/uikit/uiresponder"><code>UIResponder</code></a> class, and common subclasses include <a target="_blank" rel="noopener" href="https://developer.apple.com/documentation/uikit/uiview"><code>UIView</code></a>, <a target="_blank" rel="noopener" href="https://developer.apple.com/documentation/uikit/uiviewcontroller"><code>UIViewController</code></a>, and <a target="_blank" rel="noopener" href="https://developer.apple.com/documentation/uikit/uiapplication"><code>UIApplication</code></a>. Responders receive the raw event data and must either handle the event or forward it to another responder object. When your app receives an event, UIKit automatically directs that event to the most appropriate responder object, known as the <em>first responder</em>.</p>
<p>Unhandled events are passed from responder to responder in the active <em>responder chain</em>, which is the dynamic configuration of your app’s responder objects. <a target="_blank" rel="noopener" href="https://developer.apple.com/documentation/uikit/touches_presses_and_gestures/using_responders_and_the_responder_chain_to_handle_events#3004381">Figure 1</a> shows the responders in an app whose interface contains a label, a text field, a button, and two background views. The diagram also shows how events move from one responder to the next, following the responder chain.</p>
<p><img src="https://upload-images.jianshu.io/upload_images/117999-2ca955f249dd0a6e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/620" alt="Figure 1.png"></p>
<p>If the text field does not handle an event, UIKit sends the event to the text field’s parent UIView object, followed by the root view of the window. From the root view, the responder chain diverts to the owning view controller before directing the event to the window. If the window cannot handle the event, UIKit delivers the event to the UIApplication object, and possibly to the app delegate if that object is an instance of UIResponder and not already part of the responder chain.</p>
<h3 id="基于ResponderChain实现对象交互"><a href="#基于ResponderChain实现对象交互" class="headerlink" title="基于ResponderChain实现对象交互"></a>基于ResponderChain实现对象交互</h3><p>我们可以借用responder chain实现了一个自己的事件传递链。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//UIResponder的分类</span></span><br><span class="line"><span class="comment">//.h文件</span></span><br><span class="line"><span class="meta">#import <span class="string">&lt;UIKit/UIKit.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">UIResponder</span> (<span class="title">Router</span>)</span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)routerEventWithName:(<span class="built_in">NSString</span> *)eventName userInfo:(<span class="built_in">NSDictionary</span> *)userInfo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//.m文件</span></span><br><span class="line"><span class="meta">#import <span class="string">&quot;UIResponder+Router.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">UIResponder</span> (<span class="title">Router</span>)</span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)routerEventWithName:(<span class="built_in">NSString</span> *)eventName userInfo:(<span class="built_in">NSDictionary</span> *)userInfo &#123;</span><br><span class="line">    [[<span class="keyword">self</span> nextResponder] routerEventWithName:eventName userInfo:userInfo];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//NSObject</span></span><br><span class="line"><span class="comment">//.h文件</span></span><br><span class="line"><span class="meta">#import <span class="string">&lt;Foundation/Foundation.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">NSObject</span> (<span class="title">Invocation</span>)</span></span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSInvocation</span> *)createInvocationWithSelector:(SEL)aSelector;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//.m文件</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#import <span class="string">&quot;NSObject+Invocation.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">NSObject</span> (<span class="title">Invocation</span>)</span></span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSInvocation</span> *)createInvocationWithSelector:(SEL)aSelector &#123;</span><br><span class="line">    <span class="comment">//1、创建签名对象</span></span><br><span class="line">    <span class="built_in">NSMethodSignature</span> *signature = [[<span class="keyword">self</span> <span class="keyword">class</span>] instanceMethodSignatureForSelector:aSelector];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//2、判断传入的方法是否存在</span></span><br><span class="line">    <span class="keyword">if</span> (signature==<span class="literal">nil</span>) &#123;</span><br><span class="line">        <span class="comment">//传入的方法不存在 就抛异常</span></span><br><span class="line">        <span class="built_in">NSString</span>*info = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@&quot;-[%@ %@]:unrecognized selector sent to instance&quot;</span>,[<span class="keyword">self</span> <span class="keyword">class</span>],<span class="built_in">NSStringFromSelector</span>(aSelector)];</span><br><span class="line">        <span class="keyword">@throw</span> [[<span class="built_in">NSException</span> alloc] initWithName:<span class="string">@&quot;方法没有&quot;</span> reason:info userInfo:<span class="literal">nil</span>];</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//3、、创建NSInvocation对象</span></span><br><span class="line">    <span class="built_in">NSInvocation</span>*invocation = [<span class="built_in">NSInvocation</span> invocationWithMethodSignature:signature];</span><br><span class="line">    <span class="comment">//4、保存方法所属的对象</span></span><br><span class="line">    invocation.target = <span class="keyword">self</span>;</span><br><span class="line">    invocation.selector = aSelector;</span><br><span class="line">    <span class="keyword">return</span> invocation;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>在需要响应事件的类中重载<code>routerEventWithName::</code>方法</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)routerEventWithName:(<span class="built_in">NSString</span> *)eventName userInfo:(<span class="built_in">NSDictionary</span> *)userInfo &#123;</span><br><span class="line">    [<span class="keyword">self</span>.eventProxy handleEvent:eventName userInfo:userInfo];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用<code>EventProxy</code>类来专门处理对应的事件</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//EventProxy.h</span></span><br><span class="line"><span class="meta">#import <span class="string">&lt;Foundation/Foundation.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">EventProxy</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)handleEvent:(<span class="built_in">NSString</span> *)eventName userInfo:(<span class="built_in">NSDictionary</span> *)userInfo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//EventProxy.m</span></span><br><span class="line"><span class="meta">#import <span class="string">&quot;EventProxy.h&quot;</span></span></span><br><span class="line"><span class="meta">#import <span class="string">&quot;ResponderChainDefine.h&quot;</span></span></span><br><span class="line"><span class="meta">#import <span class="string">&quot;UIResponder+Router.h&quot;</span></span></span><br><span class="line"><span class="meta">#import <span class="string">&quot;NSObject+Invocation.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">EventProxy</span> ()</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSDictionary</span> *eventStrategy;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">EventProxy</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)handleEvent:(<span class="built_in">NSString</span> *)eventName userInfo:(<span class="built_in">NSDictionary</span> *)userInfo &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSInvocation</span> *invocation = <span class="keyword">self</span>.eventStrategy[eventName];</span><br><span class="line">    [invocation setArgument:&amp;userInfo atIndex:<span class="number">2</span>];</span><br><span class="line">    [invocation invoke];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)cellLeftButtonClick:(<span class="built_in">NSDictionary</span> *)userInfo &#123;</span><br><span class="line">    <span class="built_in">NSIndexPath</span> *indexPath = userInfo[<span class="string">@&quot;indexPath&quot;</span>];</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;indexPath:section:%ld, row:%ld 左边按钮被点击啦！&quot;</span>,indexPath.section, indexPath.row);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)cellMiddleButtonClick:(<span class="built_in">NSDictionary</span> *)userInfo &#123;</span><br><span class="line">    <span class="built_in">NSIndexPath</span> *indexPath = userInfo[<span class="string">@&quot;indexPath&quot;</span>];</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;indexPath:section:%ld, row:%ld 中间按钮被点击啦！&quot;</span>,indexPath.section, indexPath.row);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)cellRightButtonClick:(<span class="built_in">NSDictionary</span> *)userInfo &#123;</span><br><span class="line">    <span class="built_in">NSIndexPath</span> *indexPath = userInfo[<span class="string">@&quot;indexPath&quot;</span>];</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;indexPath:section:%ld, row:%ld 右边按钮被点击啦！&quot;</span>,indexPath.section, indexPath.row);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> mark - getter &amp; setter</span></span><br><span class="line">- (<span class="built_in">NSDictionary</span> &lt;<span class="built_in">NSString</span> *, <span class="built_in">NSInvocation</span> *&gt;*)eventStrategy &#123;</span><br><span class="line">    <span class="keyword">if</span> (!_eventStrategy) &#123;</span><br><span class="line">        _eventStrategy = @&#123;</span><br><span class="line">                           kTableViewCellEventTappedLeftButton:[<span class="keyword">self</span> createInvocationWithSelector:<span class="keyword">@selector</span>(cellLeftButtonClick:)],</span><br><span class="line">                           kTableViewCellEventTappedMiddleButton:[<span class="keyword">self</span> createInvocationWithSelector:<span class="keyword">@selector</span>(cellMiddleButtonClick:)],</span><br><span class="line">                           kTableViewCellEventTappedRightButton:[<span class="keyword">self</span> createInvocationWithSelector:<span class="keyword">@selector</span>(cellRightButtonClick:)]</span><br><span class="line">                           &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> _eventStrategy;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>在<code>TableViewCell</code>的事件中，调用<code>routerEventWithName:userInfo:</code>方法，就会调用到<code>EventProxy</code>类中的方法。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">TableViewCell</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">IBAction</span>)leftButtonClick:(<span class="built_in">UIButton</span> *)sender &#123;</span><br><span class="line">    [<span class="keyword">self</span> routerEventWithName:kTableViewCellEventTappedLeftButton userInfo:@&#123;<span class="string">@&quot;indexPath&quot;</span>:<span class="keyword">self</span>.indexPath&#125;];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">IBAction</span>)middelButtonClick:(<span class="built_in">UIButton</span> *)sender &#123;</span><br><span class="line">    [<span class="keyword">self</span> routerEventWithName:kTableViewCellEventTappedMiddleButton userInfo:@&#123;<span class="string">@&quot;indexPath&quot;</span>:<span class="keyword">self</span>.indexPath&#125;];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">IBAction</span>)rightButtonClick:(<span class="built_in">UIButton</span> *)sender &#123;</span><br><span class="line">    [<span class="keyword">self</span> routerEventWithName:kTableViewCellEventTappedRightButton userInfo:@&#123;<span class="string">@&quot;indexPath&quot;</span>:<span class="keyword">self</span>.indexPath&#125;];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ul>
<li>使用这种基于Responder Chain的方式来传递事件，在复杂UI层级的页面中，可以避免无谓的delegate声明。</li>
<li>事件处理的逻辑得到归拢，在这个方法里面下断点就能够管理所有的事件处理。</li>
</ul>
<h3 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h3><p><a target="_blank" rel="noopener" href="https://developer.apple.com/documentation/uikit/touches_presses_and_gestures/using_responders_and_the_responder_chain_to_handle_events">Using Responders and the Responder Chain to Handle Events</a><br><a target="_blank" rel="noopener" href="https://casatwy.com/responder_chain_communication.html">一种基于ResponderChain的对象交互方式</a><br><a target="_blank" rel="noopener" href="https://github.com/leverTsui/summary/tree/master/responderChainDemo">responderChainDemo</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://levertsui.github.io/2018/01/19/iOS%E9%95%BF%E6%8C%89%E7%A7%BB%E5%8A%A8Table%20View%20Cells/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="leverTsui">
      <meta itemprop="description" content="要有狮子的力量， 菩萨的心肠">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="leverTsui">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/01/19/iOS%E9%95%BF%E6%8C%89%E7%A7%BB%E5%8A%A8Table%20View%20Cells/" class="post-title-link" itemprop="url">iOS长按移动Table View Cells</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-01-19 13:01:28" itemprop="dateCreated datePublished" datetime="2018-01-19T13:01:28+08:00">2018-01-19</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-02-08 09:46:16" itemprop="dateModified" datetime="2022-02-08T09:46:16+08:00">2022-02-08</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/UI/" itemprop="url" rel="index"><span itemprop="name">UI</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h4><p>最近参与了事务流程工具化组件的开发，其中有一个模块需要通过长按移动<code>Table View Cells</code>，来达到调整任务的需求，再次记录下开发过程中的实现思路。完成后的效果如下图所示：</p>
<p><img src="http://upload-images.jianshu.io/upload_images/117999-aca3146c0222d73a.gif?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="长按移动cell.gif"></p>
<h4 id="实现思路"><a href="#实现思路" class="headerlink" title="实现思路"></a>实现思路</h4><h5 id="添加手势"><a href="#添加手势" class="headerlink" title="添加手势"></a>添加手势</h5><p>首先给 <code>collection view</code> 添加一个 <code>UILongGestureRecognizer</code>,在项目中一般使用懒加载的方式来对对象进行初始化：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">UICollectionView</span> *)collectionView &#123;</span><br><span class="line">    <span class="keyword">if</span> (!_collectionView) &#123;</span><br><span class="line">        _collectionView =  [[<span class="built_in">UICollectionView</span> alloc] initWithFrame:<span class="built_in">CGRectZero</span> collectionViewLayout:<span class="keyword">self</span>.flowLayout];</span><br><span class="line">        </span><br><span class="line">        _collectionView.backgroundColor = [<span class="built_in">UIColor</span> whiteColor];</span><br><span class="line">        _collectionView.dataSource = <span class="keyword">self</span>;</span><br><span class="line">        _collectionView.delegate = <span class="keyword">self</span>;</span><br><span class="line">        </span><br><span class="line">        [_collectionView registerClass:[TLCMainCollectionViewCell <span class="keyword">class</span>] forCellWithReuseIdentifier:[TLCMainCollectionViewCell identifier]];</span><br><span class="line">        </span><br><span class="line">        _collectionView.showsHorizontalScrollIndicator = <span class="literal">NO</span>;</span><br><span class="line">        _collectionView.showsVerticalScrollIndicator = <span class="literal">NO</span>;</span><br><span class="line">        _collectionView.bounces = <span class="literal">YES</span>;</span><br><span class="line">        _collectionView.decelerationRate = <span class="number">0</span>;</span><br><span class="line">        </span><br><span class="line">        [_collectionView addGestureRecognizer:<span class="keyword">self</span>.longPress];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> _collectionView;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">UILongPressGestureRecognizer</span> *)longPress &#123;</span><br><span class="line">    <span class="keyword">if</span> (!_longPress) &#123;</span><br><span class="line">        _longPress = [[<span class="built_in">UILongPressGestureRecognizer</span> alloc] initWithTarget:<span class="keyword">self</span> action:<span class="keyword">@selector</span>(longPressGestureRecognized:)];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> _longPress;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在用户长按后，触犯长按事件，先获取到当前手势所在的<code>collection view</code>位置，再做后续的处理。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)longPressGestureRecognized:(<span class="built_in">UILongPressGestureRecognizer</span> *)sender &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">CGPoint</span> location = [sender locationInView:sender.view];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">UIGestureRecognizerState</span> state = sender.state;</span><br><span class="line">    <span class="keyword">switch</span> (state) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="built_in">UIGestureRecognizerStateBegan</span>: &#123;</span><br><span class="line">                [<span class="keyword">self</span> handleLongPressStateBeganWithLocation:location];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">case</span> <span class="built_in">UIGestureRecognizerStateChanged</span>: &#123;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">case</span> <span class="built_in">UIGestureRecognizerStateEnded</span>:</span><br><span class="line">            <span class="keyword">case</span> <span class="built_in">UIGestureRecognizerStateCancelled</span>: &#123;</span><br><span class="line">                [<span class="keyword">self</span> longGestureEndedOrCancelledWithLocation:location];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="长按手势状态为开始"><a href="#长按手势状态为开始" class="headerlink" title="长按手势状态为开始"></a>长按手势状态为开始</h5><p>主要处理两个方面的事务，一为获取当前长按手势所对应的<code>Table View Cell</code>的镜像，将其添加到 <code>Collection View</code>上。二为一些初始状态的设置，后续在移动后网络请求出错及判断当前手势所处的<code>Table View</code>和上一次是否一致需要使用到。最后调用<code>startPageEdgeScroll </code>开启定时器。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)handleLongPressStateBeganWithLocation:(<span class="built_in">CGPoint</span>)location &#123;</span><br><span class="line">    </span><br><span class="line">    TLCMainCollectionViewCell *selectedCollectionViewCell = [<span class="keyword">self</span> currentTouchedCollectionCellWithLocation:location];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSIndexPath</span> *touchIndexPath = [<span class="keyword">self</span> longGestureBeganIndexPathForRowAtPoint:location atTableView:selectedCollectionViewCell.tableView];</span><br><span class="line">   </span><br><span class="line">    <span class="keyword">if</span> (!selectedCollectionViewCell || !touchIndexPath) &#123;</span><br><span class="line">        <span class="keyword">return</span> ;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">self</span>.selectedCollectionViewCellRow = [<span class="keyword">self</span>.collectionView indexPathForCell:selectedCollectionViewCell].row;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 已完成的任务，不支持排序</span></span><br><span class="line">    TLPlanItem *selectedItem = [<span class="keyword">self</span>.viewModel itemAtIndex:<span class="keyword">self</span>.selectedCollectionViewCellRow</span><br><span class="line">                                              subItemIndex:touchIndexPath.section];</span><br><span class="line">    <span class="keyword">if</span> (!selectedItem || selectedItem.finish) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    selectedItem.isHidden = <span class="literal">YES</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">self</span>.snapshotView = [<span class="keyword">self</span> snapshotViewWithTableView:selectedCollectionViewCell.tableView</span><br><span class="line">                                            atIndexPath:touchIndexPath];</span><br><span class="line">    [<span class="keyword">self</span>.collectionView addSubview:<span class="keyword">self</span>.snapshotView];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">self</span>.selectedIndexPath = touchIndexPath;</span><br><span class="line">    <span class="keyword">self</span>.originalSelectedIndexPathSection = touchIndexPath.section;</span><br><span class="line">    <span class="keyword">self</span>.originalCollectionViewCellRow = <span class="keyword">self</span>.selectedCollectionViewCellRow;</span><br><span class="line">    <span class="keyword">self</span>.previousPoint = <span class="built_in">CGPointZero</span>;</span><br><span class="line">    </span><br><span class="line">    [<span class="keyword">self</span> startPageEdgeScroll];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="长按手势状态为改变"><a href="#长按手势状态为改变" class="headerlink" title="长按手势状态为改变"></a>长按手势状态为改变</h5><p>在<code>longPressGestureRecognized </code>方法中，可以发现，长按手势状态改变时，并未做任何的操作，主要原因是如果在此做<code>Table View Cells</code>的移动操作，如果数据超过一屏幕，无法自动将未在屏幕上的数据滚动显示出来。所以在长按手势状态为开始时，如果触摸点在<code>Table View Cell</code>上，开启定时器，来处理长按手势状态为改变时的情况。 </p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)startPageEdgeScroll &#123;</span><br><span class="line">    <span class="keyword">self</span>.edgeScrollTimer = [<span class="built_in">CADisplayLink</span> displayLinkWithTarget:<span class="keyword">self</span> selector:<span class="keyword">@selector</span>(pageEdgeScrollEvent)];</span><br><span class="line">    [<span class="keyword">self</span>.edgeScrollTimer addToRunLoop:[<span class="built_in">NSRunLoop</span> mainRunLoop] forMode:<span class="built_in">NSRunLoopCommonModes</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在定时器触发的事件中，处理两个方面的事情，移动cell和滚动<code>ScrollView</code>。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)pageEdgeScrollEvent &#123;</span><br><span class="line">    [<span class="keyword">self</span> longGestureChanged:<span class="keyword">self</span>.longPress];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">CGFloat</span> snapshotViewCenterOffsetX =  [<span class="keyword">self</span> touchSnapshotViewCenterOffsetX];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (fabs(snapshotViewCenterOffsetX) &gt; (TLCMainViewControllerFlowLayoutWidthOffset<span class="number">-20</span>)) &#123;</span><br><span class="line">        <span class="comment">//横向滚动</span></span><br><span class="line">        [<span class="keyword">self</span> handleScrollViewHorizontalScroll:<span class="keyword">self</span>.collectionView viewCenterOffsetX:snapshotViewCenterOffsetX];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//垂直滚动</span></span><br><span class="line">        [<span class="keyword">self</span> handleScrollViewVerticalScroll:[<span class="keyword">self</span> selectedCollectionViewCellTableView]];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在长按手势触摸点位置改变时，处理对应<code>cell</code>的移除和插入动作。横向滚动和垂直滚动主要是根据不同情况设置对应的<code> Table View</code> 和 <code>Collection View</code>的内容偏移量。可以在文末的链接中查看源码。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)longGestureChanged:(<span class="built_in">UILongPressGestureRecognizer</span> *)sender &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">CGPoint</span> currentPoint = [sender locationInView:sender.view];</span><br><span class="line">    TLCMainCollectionViewCell *currentCollectionViewCell = [<span class="keyword">self</span> currentTouchedCollectionCellWithLocation:currentPoint];</span><br><span class="line">    <span class="keyword">if</span> (!currentCollectionViewCell) &#123;</span><br><span class="line">        currentCollectionViewCell = [<span class="keyword">self</span> collectionViewCellAtRow:<span class="keyword">self</span>.selectedCollectionViewCellRow];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    TLCMainCollectionViewCell *lasetSelectedCollectionViewCell = [<span class="keyword">self</span> collectionViewCellAtRow:<span class="keyword">self</span>.selectedCollectionViewCellRow];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//判断targetTableView是否改变</span></span><br><span class="line">    <span class="built_in">BOOL</span> isTargetTableViewChanged = <span class="literal">NO</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.selectedCollectionViewCellRow != currentCollectionViewCell.indexPath.row) &#123;</span><br><span class="line">        isTargetTableViewChanged = <span class="literal">YES</span>;</span><br><span class="line">        <span class="keyword">self</span>.selectedCollectionViewCellRow = currentCollectionViewCell.indexPath.row;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//获取到需要移动到的目标indexpath</span></span><br><span class="line">    <span class="built_in">NSIndexPath</span> *targetIndexPath = [<span class="keyword">self</span> longGestureChangeIndexPathForRowAtPoint:currentPoint</span><br><span class="line">                                                        collectionViewCell:currentCollectionViewCell];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSIndexPath</span> *lastSelectedIndexPath = <span class="keyword">self</span>.selectedIndexPath;</span><br><span class="line">    </span><br><span class="line">    TLCMainCollectionViewCell *selectedCollectionViewCell = [<span class="keyword">self</span> collectionViewCellAtRow:<span class="keyword">self</span>.selectedCollectionViewCellRow];</span><br><span class="line">    <span class="comment">//判断跟上一次长按手势所处的Table View是否相同，如果相同，移动cell，</span></span><br><span class="line">    <span class="comment">//如果不同，删除上一次所定义的cell，插入到当前位置</span></span><br><span class="line">    <span class="keyword">if</span> (isTargetTableViewChanged) &#123;</span><br><span class="line">        <span class="keyword">if</span> ([[<span class="keyword">self</span> selectedCollectionViewCellTableView] numberOfSections]&gt;targetIndexPath.section) &#123;</span><br><span class="line">            [[<span class="keyword">self</span> selectedCollectionViewCellTableView] scrollToRowAtIndexPath:targetIndexPath</span><br><span class="line">                                                              atScrollPosition:<span class="built_in">UITableViewScrollPositionNone</span> animated:<span class="literal">YES</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        TLPlanItem *moveItem = [<span class="keyword">self</span>.viewModel itemAtIndex:lasetSelectedCollectionViewCell.indexPath.row</span><br><span class="line">                                              subItemIndex:lastSelectedIndexPath.section];</span><br><span class="line">        [<span class="keyword">self</span>.viewModel removeObject:moveItem</span><br><span class="line">                           itemIndex:lasetSelectedCollectionViewCell.indexPath.row];</span><br><span class="line">        [<span class="keyword">self</span>.viewModel insertItem:moveItem</span><br><span class="line">                             index:<span class="keyword">self</span>.selectedCollectionViewCellRow</span><br><span class="line">                      subItemIndex:targetIndexPath.section];</span><br><span class="line"></span><br><span class="line">        [lasetSelectedCollectionViewCell updateCellWithData:[<span class="keyword">self</span> planItemsAtIndex:lasetSelectedCollectionViewCell.indexPath.row]];</span><br><span class="line">        [lasetSelectedCollectionViewCell.tableView deleteSections:[<span class="built_in">NSIndexSet</span> indexSetWithIndex:lastSelectedIndexPath.section]</span><br><span class="line">                                                 withRowAnimation:<span class="built_in">UITableViewRowAnimationNone</span>];</span><br><span class="line"></span><br><span class="line">        [selectedCollectionViewCell updateCellWithData:[<span class="keyword">self</span> planItemsAtIndex:<span class="keyword">self</span>.selectedCollectionViewCellRow]];</span><br><span class="line">        [selectedCollectionViewCell.tableView insertSections:[<span class="built_in">NSIndexSet</span> indexSetWithIndex:targetIndexPath.section]</span><br><span class="line">                                            withRowAnimation:<span class="built_in">UITableViewRowAnimationNone</span>];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">BOOL</span> isSameSection = lastSelectedIndexPath.section == targetIndexPath.section;</span><br><span class="line">        <span class="built_in">UITableViewCell</span> *targetCell = [<span class="keyword">self</span> tableView:[<span class="keyword">self</span> selectedCollectionViewCellTableView]</span><br><span class="line">                                selectedCellAtSection:targetIndexPath.section];</span><br><span class="line">        <span class="keyword">if</span> (isSameSection || !targetCell ) &#123;</span><br><span class="line">            [<span class="keyword">self</span> modifySnapshotViewFrameWithTouchPoint:currentPoint];</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        TLPlanItem *item = [<span class="keyword">self</span>.viewModel itemAtIndex:<span class="keyword">self</span>.selectedCollectionViewCellRow</span><br><span class="line">                                          subItemIndex:lastSelectedIndexPath.section];</span><br><span class="line">        [<span class="keyword">self</span>.viewModel removeObject:item</span><br><span class="line">                           itemIndex:<span class="keyword">self</span>.selectedCollectionViewCellRow];</span><br><span class="line">        [<span class="keyword">self</span>.viewModel insertItem:item</span><br><span class="line">                             index:<span class="keyword">self</span>.selectedCollectionViewCellRow</span><br><span class="line">                      subItemIndex:targetIndexPath.section];</span><br><span class="line">        </span><br><span class="line">        [selectedCollectionViewCell updateCellWithData:[<span class="keyword">self</span> planItemsAtIndex:<span class="keyword">self</span>.selectedCollectionViewCellRow]];</span><br><span class="line">        [selectedCollectionViewCell.tableView moveSection:lastSelectedIndexPath.section</span><br><span class="line">                                                toSection:targetIndexPath.section];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">self</span>.selectedIndexPath = targetIndexPath;</span><br><span class="line">    <span class="comment">//改变长按cell镜像的位置</span></span><br><span class="line">    [<span class="keyword">self</span> modifySnapshotViewFrameWithTouchPoint:currentPoint];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="长按手势状态为取消或结束"><a href="#长按手势状态为取消或结束" class="headerlink" title="长按手势状态为取消或结束"></a>长按手势状态为取消或结束</h5><p>取消计时器，设置<code>Collection View</code>的偏移量，让其<code>Collection View Cell</code>位于屏幕的中心，发送网络请求，去调整任务的排序，同时将镜像视图隐藏，并将其所对应的<code>Table View Cell</code>显示出来。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)longGestureEndedOrCancelledWithLocation:(<span class="built_in">CGPoint</span>)location &#123;</span><br><span class="line">    </span><br><span class="line">    [<span class="keyword">self</span> stopEdgeScrollTimer];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">CGPoint</span> contentOffset = [<span class="keyword">self</span>.flowLayout targetContentOffsetForProposedContentOffset:<span class="keyword">self</span>.collectionView.contentOffset</span><br><span class="line">                                                                   withScrollingVelocity:<span class="built_in">CGPointZero</span>];</span><br><span class="line">    [<span class="keyword">self</span>.collectionView setContentOffset:contentOffset animated:<span class="literal">YES</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">UITableViewCell</span> *targetCell = [[<span class="keyword">self</span> selectedCollectionViewCellTableView] cellForRowAtIndexPath:<span class="keyword">self</span>.selectedIndexPath];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ([<span class="keyword">self</span> canAdjustPlanRanking]) &#123;</span><br><span class="line">        [<span class="keyword">self</span> adjustPlanRanking];</span><br><span class="line">    &#125;</span><br><span class="line">    TLPlanItem *slectedItem = [<span class="keyword">self</span>.viewModel itemAtIndex:<span class="keyword">self</span>.selectedCollectionViewCellRow subItemIndex:<span class="keyword">self</span>.selectedIndexPath.section];</span><br><span class="line">    [<span class="built_in">UIView</span> animateWithDuration:<span class="number">0.25</span> animations:^&#123;</span><br><span class="line">        <span class="keyword">self</span>.snapshotView.transform = <span class="built_in">CGAffineTransformIdentity</span>;</span><br><span class="line">        <span class="keyword">self</span>.snapshotView.frame = [<span class="keyword">self</span> snapshotViewFrameWithCell:targetCell];</span><br><span class="line">        </span><br><span class="line">    &#125; completion:^(<span class="built_in">BOOL</span> finished) &#123;</span><br><span class="line">        targetCell.hidden = <span class="literal">NO</span>;</span><br><span class="line">        slectedItem.isHidden = <span class="literal">NO</span>;</span><br><span class="line">        [<span class="keyword">self</span>.snapshotView removeFromSuperview];</span><br><span class="line">        <span class="keyword">self</span>.snapshotView = <span class="literal">nil</span>;</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="数据的处理"><a href="#数据的处理" class="headerlink" title="数据的处理"></a>数据的处理</h5><p>在移动和插入<code>Table View Cell</code>时，需要将其所对应的数据做响应的改变，数据相关的操作均放在<code>TLCMainViewModel</code>对象中。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">TLCMainViewModel</span> : <span class="title">NSObject</span> </span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> 今日要做、下一步要做和以后要做</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>, <span class="keyword">strong</span>) <span class="built_in">NSArray</span> &lt;<span class="built_in">NSString</span> *&gt; *titleArray; </span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> 获取计划列表</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment"> @param completion  TLTodoModel</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (<span class="keyword">void</span>)obtainTotalPlanListWithTypeCompletion:(TLSDKCompletionBlk)completion;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> 添加计划</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> @param requestItem requestItem</span></span><br><span class="line"><span class="comment"> @param completion 完成回调</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (<span class="keyword">void</span>)addPlanWithReq:(TLPlanItemReq *)requestItem</span><br><span class="line">           atIndexPath:(<span class="built_in">NSIndexPath</span> *)indexPath</span><br><span class="line">            completion:(TLSDKCompletionBlk)completion;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> 返回显示的collectionViewCell的个数</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> @return 数据的个数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (<span class="built_in">NSInteger</span>)numberOfItems;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> 根据type获取对应的数据</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> @param index 位置</span></span><br><span class="line"><span class="comment"> @return 此计划所对应的数据</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (<span class="built_in">NSMutableArray</span>&lt;TLPlanItem *&gt; *)planItemsAtIndex:(<span class="built_in">NSInteger</span>)index;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> 删除某个计划</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment"> @param itemIndex 单项数据在数组中的位置，如今日计划中的数据，itemIndex为0</span></span><br><span class="line"><span class="comment"> @param subItemIndex  单项数据数组中所在的位置</span></span><br><span class="line"><span class="comment"> @param completion 完成回调</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (<span class="keyword">void</span>)deletePlanAtItemIndex:(<span class="built_in">NSInteger</span>)itemIndex</span><br><span class="line">                 subItemIndex:(<span class="built_in">NSInteger</span>)subItemIndex</span><br><span class="line">                   completion:(dispatch_block_t)completion;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> 修改计划状态：完成与非完成</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment"> @param itemIndex 单项数据在数组中的位置，如今日计划中的数据，itemIndex为0</span></span><br><span class="line"><span class="comment"> @param subItemIndex  单项数据数组中所在的位置</span></span><br><span class="line"><span class="comment"> @param completion 完成回调</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (<span class="keyword">void</span>)modiflyPlanStateAtItemIndex:(<span class="built_in">NSInteger</span>)itemIndex</span><br><span class="line">                       subItemIndex:(<span class="built_in">NSInteger</span>)subItemIndex</span><br><span class="line">                         completion:(TLSDKCompletionBlk)completion;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> 修改计划的title和重点标记状态</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> @param itemIndex 单项数据在数组中的位置，如今日计划中的数据，itemIndex为0</span></span><br><span class="line"><span class="comment"> @param subItemIndex 单项数据数组中所在的位置</span></span><br><span class="line"><span class="comment"> @param targetItem 目标对象</span></span><br><span class="line"><span class="comment"> @param completion 完成回调</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (<span class="keyword">void</span>)modiflyItemAtIndex:(<span class="built_in">NSInteger</span>)itemIndex</span><br><span class="line">              subItemIndex:(<span class="built_in">NSInteger</span>)subItemIndex</span><br><span class="line">                targetItem:(TLPlanItem *)targetItem</span><br><span class="line">                completion:(dispatch_block_t)completion;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> 移除数据</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> @param item item</span></span><br><span class="line"><span class="comment"> @param itemIndex 单项数据在数组中的位置</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (<span class="keyword">void</span>)removeObject:(TLPlanItem *)item</span><br><span class="line">           itemIndex:(<span class="built_in">NSInteger</span>)itemIndex;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> 插入数据</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment"> @param item 插入的对象模型</span></span><br><span class="line"><span class="comment"> @param itemIndex 单项数据在数组中的位置，如今日计划中的数据，itemIndex为0</span></span><br><span class="line"><span class="comment"> @param subItemIndex 单项数据数组中所在的位置</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (<span class="keyword">void</span>)insertItem:(TLPlanItem *)item</span><br><span class="line">             index:(<span class="built_in">NSInteger</span>)itemIndex</span><br><span class="line">      subItemIndex:(<span class="built_in">NSInteger</span>)subItemIndex;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> 获取数据</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> @param itemIndex 一级index</span></span><br><span class="line"><span class="comment"> @param subItemIndex 二级index</span></span><br><span class="line"><span class="comment"> @return 数据模型</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (TLPlanItem *)itemAtIndex:(<span class="built_in">NSInteger</span>)itemIndex</span><br><span class="line">               subItemIndex:(<span class="built_in">NSInteger</span>)subItemIndex; </span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> 重置数据</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (<span class="keyword">void</span>)reset;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> 保存长按开始时的数据</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (<span class="keyword">void</span>)storePressBeginState;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<h4 id="代码完善"><a href="#代码完善" class="headerlink" title="代码完善"></a>代码完善</h4><h5 id="cell未居中显示问题"><a href="#cell未居中显示问题" class="headerlink" title="cell未居中显示问题"></a><code>cell</code>未居中显示问题</h5><p><code>2018年2月1号</code><br>在iPhone系统版本为<code>iOS8.x</code>和<code>iOS9.x</code>时，会出现<code>以后要做</code>界面不会回弹的情况。如下图所示：<br><img src="http://upload-images.jianshu.io/upload_images/117999-dfea45068404f800.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="bug1.png"></p>
<p>经排查，是在<code>UICollectionViewFlowLayout</code>类中的</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">CGPoint</span>)targetContentOffsetForProposedContentOffset:(<span class="built_in">CGPoint</span>)proposedContentOffset withScrollingVelocity:(<span class="built_in">CGPoint</span>)velocity</span><br></pre></td></tr></table></figure>
<p>方法计算得出的<code>proposedContentOffset</code>有偏差，修改后如下所示：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">CGPoint</span>)targetContentOffsetForProposedContentOffset:(<span class="built_in">CGPoint</span>)proposedContentOffset withScrollingVelocity:(<span class="built_in">CGPoint</span>)velocity &#123;</span><br><span class="line">    <span class="built_in">CGFloat</span> rawPageValue = <span class="keyword">self</span>.collectionView.contentOffset.x / [<span class="keyword">self</span> tlc_pageWidth];</span><br><span class="line">    <span class="built_in">CGFloat</span> currentPage = (velocity.x &gt; <span class="number">0.0</span>) ? floor(rawPageValue) : ceil(rawPageValue);</span><br><span class="line">    <span class="built_in">CGFloat</span> nextPage = (velocity.x &gt; <span class="number">0.0</span>) ? ceil(rawPageValue) : floor(rawPageValue);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">BOOL</span> pannedLessThanAPage = fabs(<span class="number">1</span> + currentPage - rawPageValue) &gt; <span class="number">0.5</span>;</span><br><span class="line">    <span class="built_in">BOOL</span> flicked = fabs(velocity.x) &gt; [<span class="keyword">self</span> tlc_flickVelocity];</span><br><span class="line">    <span class="built_in">CGFloat</span> actualPage = <span class="number">0.0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (pannedLessThanAPage &amp;&amp; flicked) &#123;</span><br><span class="line">        proposedContentOffset.x = nextPage * [<span class="keyword">self</span> tlc_pageWidth];</span><br><span class="line">        actualPage = nextPage;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        proposedContentOffset.x = round(rawPageValue) * [<span class="keyword">self</span> tlc_pageWidth];</span><br><span class="line">        actualPage = round(rawPageValue);</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">if</span> (lround(actualPage) &gt;= <span class="number">1</span>) &#123;</span><br><span class="line">        proposedContentOffset.x -= <span class="number">4.5</span>;</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="comment">//下面为添加的代码</span></span><br><span class="line">    <span class="keyword">if</span> (lround(actualPage) &gt;= <span class="number">2</span>) &#123;</span><br><span class="line">        proposedContentOffset.x = <span class="keyword">self</span>.collectionView.contentSize.width - TLCScreenWidth;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> proposedContentOffset;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="在系统版本为iOS9-x时，输入框会上一段距离问题"><a href="#在系统版本为iOS9-x时，输入框会上一段距离问题" class="headerlink" title="在系统版本为iOS9.x时，输入框会上一段距离问题"></a>在系统版本为iOS9.x时，输入框会上一段距离问题</h5><p><code>2018年2月12号</code><br>在机型为iPhone SE，系统版本为iOS9.x时，新建计划时，新建窗口会上移一段，如下图所示：<br><img src="http://upload-images.jianshu.io/upload_images/117999-edc9204a4f9985ab.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="适配问题.png"><br>分析发现，应该是监听键盘高度变化时，输入框的高度计算在特定机型的特定版本上计算错误，将原有的计算<code>frame</code>的来布局的方式改为自动布局。监听键盘高度改变的代码修改后如下：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)viewWillAppear:(<span class="built_in">BOOL</span>)animated&#123;</span><br><span class="line">    </span><br><span class="line">    [<span class="keyword">super</span> viewWillAppear:animated]; </span><br><span class="line">    [<span class="keyword">self</span> addObserverForKeybord];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)viewWillDisappear:(<span class="built_in">BOOL</span>)animated &#123;</span><br><span class="line">    </span><br><span class="line">    [<span class="keyword">super</span> viewWillDisappear:animated];</span><br><span class="line">    [<span class="keyword">self</span>.view endEditing:<span class="literal">YES</span>];</span><br><span class="line">    [<span class="keyword">self</span> removeobserverForKeybord];</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> mark - keyboard observer</span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)addObserverForKeybord &#123;</span><br><span class="line">    </span><br><span class="line">    [[<span class="built_in">NSNotificationCenter</span> defaultCenter] addObserver:<span class="keyword">self</span></span><br><span class="line">                                             selector:<span class="keyword">@selector</span>(keyboardWillShow:)</span><br><span class="line">                                                 name:<span class="built_in">UIKeyboardWillShowNotification</span></span><br><span class="line">                                               object:<span class="literal">nil</span>];</span><br><span class="line">    </span><br><span class="line">    [[<span class="built_in">NSNotificationCenter</span> defaultCenter] addObserver:<span class="keyword">self</span></span><br><span class="line">                                             selector:<span class="keyword">@selector</span>(keyboardWillHide:)</span><br><span class="line">                                                 name:<span class="built_in">UIKeyboardWillHideNotification</span></span><br><span class="line">                                               object:<span class="literal">nil</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)removeobserverForKeybord &#123;</span><br><span class="line">    </span><br><span class="line">    [[<span class="built_in">NSNotificationCenter</span> defaultCenter] removeObserver:<span class="keyword">self</span></span><br><span class="line">                                                    name:<span class="built_in">UIKeyboardWillShowNotification</span></span><br><span class="line">                                                  object:<span class="literal">nil</span>];</span><br><span class="line">    </span><br><span class="line">    [[<span class="built_in">NSNotificationCenter</span> defaultCenter] removeObserver:<span class="keyword">self</span></span><br><span class="line">                                                    name:<span class="built_in">UIKeyboardWillHideNotification</span></span><br><span class="line">                                                  object:<span class="literal">nil</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)keyboardWillShow:(<span class="built_in">NSNotification</span> *)notification &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">CGRect</span> keyboardBounds;</span><br><span class="line">    [[notification.userInfo valueForKey:<span class="built_in">UIKeyboardFrameEndUserInfoKey</span>] getValue:&amp;keyboardBounds];</span><br><span class="line">    <span class="built_in">NSNumber</span> *duration = [notification.userInfo objectForKey:<span class="built_in">UIKeyboardAnimationDurationUserInfoKey</span>];</span><br><span class="line">    <span class="built_in">NSNumber</span> *curve = [notification.userInfo objectForKey:<span class="built_in">UIKeyboardAnimationCurveUserInfoKey</span>];</span><br><span class="line">    </span><br><span class="line">    keyboardBounds = [<span class="keyword">self</span>.view convertRect:keyboardBounds toView:<span class="literal">nil</span>];</span><br><span class="line">    </span><br><span class="line">    [<span class="keyword">self</span>.inputProjectView mas_updateConstraints:^(MASConstraintMaker *make) &#123;</span><br><span class="line">        make.bottom.equalTo(<span class="keyword">self</span>.view).offset(-<span class="built_in">CGRectGetHeight</span>(keyboardBounds));</span><br><span class="line">    &#125;];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//设置动画</span></span><br><span class="line">    [<span class="built_in">UIView</span> beginAnimations:<span class="literal">nil</span> context:<span class="literal">NULL</span>];</span><br><span class="line">    [<span class="built_in">UIView</span> setAnimationBeginsFromCurrentState:<span class="literal">YES</span>];</span><br><span class="line">    [<span class="built_in">UIView</span> setAnimationDuration:[duration doubleValue]];</span><br><span class="line">    [<span class="built_in">UIView</span> setAnimationCurve:[curve intValue]];</span><br><span class="line">    </span><br><span class="line">    [<span class="keyword">self</span>.inputProjectView layoutIfNeeded];</span><br><span class="line">    </span><br><span class="line">    [<span class="built_in">UIView</span> commitAnimations];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)keyboardWillHide:(<span class="built_in">NSNotification</span> *)notification &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>([<span class="keyword">self</span>.inputProjectView inputText].length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        [<span class="keyword">self</span>.inputProjectView resetText];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">CGRect</span> keyboardBounds;</span><br><span class="line">    [[notification.userInfo valueForKey:<span class="built_in">UIKeyboardFrameEndUserInfoKey</span>] getValue:&amp;keyboardBounds];</span><br><span class="line">    <span class="built_in">NSNumber</span> *duration = [notification.userInfo objectForKey:<span class="built_in">UIKeyboardAnimationDurationUserInfoKey</span>];</span><br><span class="line">    <span class="built_in">NSNumber</span> *curve = [notification.userInfo objectForKey:<span class="built_in">UIKeyboardAnimationCurveUserInfoKey</span>];</span><br><span class="line">    </span><br><span class="line">    keyboardBounds = [<span class="keyword">self</span>.view convertRect:keyboardBounds toView:<span class="literal">nil</span>];</span><br><span class="line">    </span><br><span class="line">    [<span class="keyword">self</span>.inputProjectView mas_updateConstraints:^(MASConstraintMaker *make) &#123;</span><br><span class="line">        <span class="keyword">if</span> (@available(iOS <span class="number">11.0</span>, *)) &#123;</span><br><span class="line">            make.bottom.equalTo(<span class="keyword">self</span>.view).offset(<span class="keyword">self</span>.view.safeAreaInsets.bottom+<span class="number">88</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            make.bottom.equalTo(<span class="keyword">self</span>.view).offset(<span class="number">88</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        make.height.mas_equalTo(<span class="number">88</span>);</span><br><span class="line">    &#125;];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//设置动画</span></span><br><span class="line">    [<span class="built_in">UIView</span> beginAnimations:<span class="literal">nil</span> context:<span class="literal">NULL</span>];</span><br><span class="line">    [<span class="built_in">UIView</span> setAnimationBeginsFromCurrentState:<span class="literal">YES</span>];</span><br><span class="line">    [<span class="built_in">UIView</span> setAnimationDuration:[duration doubleValue]];</span><br><span class="line">    [<span class="built_in">UIView</span> setAnimationCurve:[curve intValue]];</span><br><span class="line">    </span><br><span class="line">    [<span class="keyword">self</span>.inputProjectView layoutIfNeeded];</span><br><span class="line">    </span><br><span class="line">    [<span class="built_in">UIView</span> commitAnimations];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="切换输入法时，输入框被键盘遮住问题"><a href="#切换输入法时，输入框被键盘遮住问题" class="headerlink" title="切换输入法时，输入框被键盘遮住问题"></a>切换输入法时，输入框被键盘遮住问题</h5><p>在修复此问题后，自测时发现，输入法由简体拼音切换为表情符号时，输入框会被键盘挡住，在代码中打断点发现<code>UIKeyboardWillShowNotification</code>和<code>UIKeyboardWillChangeFrameNotification</code>通知均未被触发，同时对比微信发现，切换输入法时，同时开启了自动校正功能，所以参考添加如下代码：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_textView.internalTextView.autocorrectionType = <span class="built_in">UITextAutocorrectionTypeYes</span>;</span><br></pre></td></tr></table></figure>
<p>解决切换输入法时，输入框被键盘遮住的问题。</p>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>除了上述<code>Table View Cell</code>移动的操作，在项目中还处理了创建事务和事务详情相关的业务。在整个过程中，比较棘手的还是<code>Table View Cell</code>的移动，在开发过程中，有时数据的移动和<code>Table View Cell</code>的移动未对应上，造成<code>Table View Cell</code>布局错乱，排查了很久。在项目开发过程中，还是需要仔细去分析需求。</p>
<p>文章所对应的<code>Demo</code>请点<a target="_blank" rel="noopener" href="https://github.com/leverTsui/LongPressMoveCellDemo">这里</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://levertsui.github.io/2017/12/14/iOS%E6%B7%B1%E6%8B%B7%E8%B4%9D%E5%92%8C%E6%B5%85%E6%8B%B7%E8%B4%9D/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="leverTsui">
      <meta itemprop="description" content="要有狮子的力量， 菩萨的心肠">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="leverTsui">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/12/14/iOS%E6%B7%B1%E6%8B%B7%E8%B4%9D%E5%92%8C%E6%B5%85%E6%8B%B7%E8%B4%9D/" class="post-title-link" itemprop="url">iOS深拷贝和浅拷贝</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2017-12-14 12:26:00" itemprop="dateCreated datePublished" datetime="2017-12-14T12:26:00+08:00">2017-12-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-02-08 09:46:16" itemprop="dateModified" datetime="2022-02-08T09:46:16+08:00">2022-02-08</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" itemprop="url" rel="index"><span itemprop="name">基础知识</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>在工作中，有时会涉及到深拷贝和浅拷贝的内容，发现有些地方理解的不够透彻，所以在网上搜集资料总结一下，主要分四个方面来介绍下iOS中深拷贝和浅拷贝：</p>
<ul>
<li>对象的拷贝；</li>
<li>集合的拷贝；</li>
<li>如何对集合进行深拷贝？</li>
<li>总结<h4 id="对象的拷贝"><a href="#对象的拷贝" class="headerlink" title="对象的拷贝"></a>对象的拷贝</h4>对对象进行拷贝，通过调用<code>copy</code>或<code>mutableCopy</code>方法来实现：</li>
<li>调用 <code>copy</code>方法返回的对象为不可变对象,需要实现<code>NSCopying</code>协议 ；</li>
<li>调用<code>mutableCopy</code>方法返回的对象为可变对象，需要实现<code>NSMutableCopying</code>协议 ；</li>
</ul>
<p><img src="http://upload-images.jianshu.io/upload_images/117999-adeebf183df99baa.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="object copying"><br>上图是苹果文档中关于对象拷贝的实例图，从图中可知：</p>
<blockquote>
<p>浅拷贝：<code>object A</code>和<code>object B</code>及其属性使用同样的内存地址，简单说明的话，可以认为是指针复制；<br>深拷贝：<code>object A</code>和<code>object B</code>及其属性使用不同的内存地址，简单说明的话，可以认为是内容复制。</p>
</blockquote>
<p>下面通过分析<code>NSString</code>、<code>NSMutableString</code>、和自定义对象<code>DBTestModel</code>，调用<code>copy</code>和<code>mutableCopy</code>之后，分析其返回的对象及此对象的属性的内存地址来判断其行为是深拷贝还是浅拷贝。</p>
<h5 id="NSString"><a href="#NSString" class="headerlink" title="NSString"></a>NSString</h5><p><img src="http://upload-images.jianshu.io/upload_images/117999-bcac53e449d8b0a7.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="NSString.png"></p>
<p>通过打印的信息可知：</p>
<ul>
<li>对象<code>string</code>调用<code>copy</code>方法后返回的对象<code>copySting</code>，其所对应的内存地址和对象<code>string</code>一致，即为指针复制；</li>
<li>对象<code>string</code>调用<code>mutableCopy</code>方法后返回的对象<code>mutaCopySting</code>，其所对应的内存地址和对象<code>string</code>不一致，即为指内容复制；</li>
</ul>
<h5 id="NSMutableString"><a href="#NSMutableString" class="headerlink" title="NSMutableString"></a>NSMutableString</h5><p><img src="http://upload-images.jianshu.io/upload_images/117999-0eab0dce73bccbec.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="NSMutableString.png"></p>
<p>通过打印的信息可知：</p>
<ul>
<li>对象<code>mutaString</code>调用<code>copy</code>方法后返回的对象<code>copyMutaString</code>，其所对应的内存地址和对象<code>mutaString</code>不一致，即为内容复制；</li>
<li>对象<code>mutaString</code>调用<code>mutableCopy</code>方法后返回的对象<code>mutaCopyMutaString</code>，其所对应的内存地址和对象<code>mutaString</code>不一致，即为指内容复制；</li>
</ul>
<h5 id="DBTestModel"><a href="#DBTestModel" class="headerlink" title="DBTestModel"></a>DBTestModel</h5><p>下面为自定义的对象’DBTestModel’: </p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="string">&lt;Foundation/Foundation.h&gt;</span></span></span><br><span class="line"><span class="meta">#import <span class="string">&lt;Mantle/Mantle.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">DBTestModel</span> : <span class="title">MTLModel</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *text;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSArray</span> *sourceArray;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSMutableArray</span> *mutableArray;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithText:(<span class="built_in">NSString</span> *)text</span><br><span class="line">                 sourceArray:(<span class="built_in">NSArray</span> *)sourceArray</span><br><span class="line">                mutableArray:(<span class="built_in">NSMutableArray</span> *)mutableArray;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>定义了三个属性，<code>text</code>、<code>sourceArray</code>、<code>mutableArray</code>。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)testCustomObject &#123;</span><br><span class="line">    <span class="built_in">NSMutableArray</span> *mutableArray = [<span class="built_in">NSMutableArray</span> array];</span><br><span class="line">    DBTestModel *model = [[DBTestModel alloc] initWithText:<span class="string">@&quot;text&quot;</span></span><br><span class="line">                                               sourceArray:@[<span class="string">@&quot;test1&quot;</span>,<span class="string">@&quot;test2&quot;</span>]</span><br><span class="line">                                              mutableArray:mutableArray];</span><br><span class="line">    DBTestModel *copyModel = [model <span class="keyword">copy</span>];</span><br><span class="line">    DBTestModel *mutaCopyModel = [model mutableCopy];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;DBTestModel memory address&quot;</span>);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;original   :%p&quot;</span>, model);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;copy       :%p&quot;</span>, copyModel);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;mutableCopy:%p&quot;</span>, mutaCopyModel);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;\n&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;text memory address&quot;</span>);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;original   :%p&quot;</span>, model.text);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;copy       :%p&quot;</span>, copyModel.text);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;mutableCopy:%p&quot;</span>, mutaCopyModel.text);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;\n&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;sourceArray memory address&quot;</span>);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;original   :%p&quot;</span>, model.sourceArray);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;copy       :%p&quot;</span>, copyModel.sourceArray);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;mutableCopy:%p&quot;</span>, mutaCopyModel.sourceArray);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;\n&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;mutableArray memory address&quot;</span>);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;original   :%p&quot;</span>, model.mutableArray);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;copy       :%p&quot;</span>, copyModel.mutableArray);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;mutableCopy:%p&quot;</span>, mutaCopyModel.mutableArray);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;\n&quot;</span>); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>打印结果如下：<br><img src="http://upload-images.jianshu.io/upload_images/117999-7edadb3411c425dd.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"><br>分析其打印数据可知：</p>
<ul>
<li>除<code>DBTestModel</code>实例对象中的属性<code>text</code>和<code>sourceArray</code>调用<code>copy</code>后，没有产生一个新的对象，为指针复制，其余均为内容复制。</li>
</ul>
<h4 id="集合的拷贝"><a href="#集合的拷贝" class="headerlink" title="集合的拷贝"></a>集合的拷贝</h4><p><img src="http://upload-images.jianshu.io/upload_images/117999-c329ce5e7a3eb4e5.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p>
<h5 id="不可变集合NSArray"><a href="#不可变集合NSArray" class="headerlink" title="不可变集合NSArray"></a>不可变集合<code>NSArray</code></h5><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)testCollectiveCopy &#123;</span><br><span class="line">    <span class="built_in">NSMutableArray</span> *mutableArray1 = [<span class="built_in">NSMutableArray</span> array];</span><br><span class="line">    DBTestModel *model1 = [[DBTestModel alloc] initWithText:<span class="string">@&quot;text&quot;</span></span><br><span class="line">                                               sourceArray:@[<span class="string">@&quot;test1&quot;</span>,<span class="string">@&quot;test2&quot;</span>]</span><br><span class="line">                                              mutableArray:mutableArray1];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSMutableArray</span> *mutableArray2 = [<span class="built_in">NSMutableArray</span> array];</span><br><span class="line">    DBTestModel *model2 = [[DBTestModel alloc] initWithText:<span class="string">@&quot;text&quot;</span></span><br><span class="line">                                                sourceArray:@[<span class="string">@&quot;test1&quot;</span>,<span class="string">@&quot;test2&quot;</span>]</span><br><span class="line">                                               mutableArray:mutableArray2];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSMutableArray</span> *mutableArray3 = [<span class="built_in">NSMutableArray</span> array];</span><br><span class="line">    DBTestModel *model3 = [[DBTestModel alloc] initWithText:<span class="string">@&quot;text&quot;</span></span><br><span class="line">                                                sourceArray:@[<span class="string">@&quot;test1&quot;</span>,<span class="string">@&quot;test2&quot;</span>]</span><br><span class="line">                                               mutableArray:mutableArray3];</span><br><span class="line">    <span class="built_in">NSArray</span> *array = @[model1,model2,model3];</span><br><span class="line">    <span class="built_in">NSArray</span> *copyArray = [array <span class="keyword">copy</span>];</span><br><span class="line">    <span class="built_in">NSMutableArray</span> *mutaCopyArray = [array mutableCopy];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;\nNSArray memory address\noriginal   :%p\ncopy       :%p\nmutableCopy:%p\n&quot;</span>,</span><br><span class="line">          array,copyArray,mutaCopyArray);</span><br><span class="line"> </span><br><span class="line">    DBTestModel *firstCopyModel = [copyArray firstObject];</span><br><span class="line">    DBTestModel *firstMutableCopyModel = [mutaCopyArray firstObject];</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;\nDBTestModel memory address\noriginal   :%p\ncopy       :%p\nmutableCopy:%p\n&quot;</span>,</span><br><span class="line">          model1,firstCopyModel,firstMutableCopyModel);</span><br><span class="line"> </span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;\nDBTestModel sourceArray memory address\noriginal   :%p\ncopy       :%p\nmutableCopy:%p\n&quot;</span>,</span><br><span class="line">          model1.sourceArray,firstCopyModel.sourceArray,firstMutableCopyModel.sourceArray); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>打印结果如下： </p>
<p><img src="http://upload-images.jianshu.io/upload_images/117999-b541a083c1018ea6.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="NSArray.png"></p>
<p>分析其打印数据可知：</p>
<ul>
<li>除<code>NSArray</code>实例对象调用<code>mutableCopy</code>方法为内容复制外，其余的均为指针拷贝。</li>
</ul>
<h5 id="可变集合NSMutableArray"><a href="#可变集合NSMutableArray" class="headerlink" title="可变集合NSMutableArray"></a>可变集合<code>NSMutableArray</code></h5><p>测试代码如下：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)testCollectiveMutacopy &#123;</span><br><span class="line">    <span class="built_in">NSMutableArray</span> *mutableArray1 = [<span class="built_in">NSMutableArray</span> array];</span><br><span class="line">    DBTestModel *model1 = [[DBTestModel alloc] initWithText:<span class="string">@&quot;text&quot;</span></span><br><span class="line">                                                sourceArray:@[<span class="string">@&quot;test1&quot;</span>,<span class="string">@&quot;test2&quot;</span>]</span><br><span class="line">                                               mutableArray:mutableArray1];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSMutableArray</span> *mutableArray2 = [<span class="built_in">NSMutableArray</span> array];</span><br><span class="line">    DBTestModel *model2 = [[DBTestModel alloc] initWithText:<span class="string">@&quot;text&quot;</span></span><br><span class="line">                                                sourceArray:@[<span class="string">@&quot;test1&quot;</span>,<span class="string">@&quot;test2&quot;</span>]</span><br><span class="line">                                               mutableArray:mutableArray2];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSMutableArray</span> *mutableArray3 = [<span class="built_in">NSMutableArray</span> array];</span><br><span class="line">    DBTestModel *model3 = [[DBTestModel alloc] initWithText:<span class="string">@&quot;text&quot;</span></span><br><span class="line">                                                sourceArray:@[<span class="string">@&quot;test1&quot;</span>,<span class="string">@&quot;test2&quot;</span>]</span><br><span class="line">                                               mutableArray:mutableArray3];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSArray</span> *array1 = @[model1,model2,model3];</span><br><span class="line">    <span class="built_in">NSMutableArray</span> *mutaArray = [<span class="built_in">NSMutableArray</span> arrayWithArray:array1];</span><br><span class="line">    <span class="built_in">NSMutableArray</span> *copyMutaArray = [mutaArray <span class="keyword">copy</span>];</span><br><span class="line">    <span class="built_in">NSMutableArray</span> *mutaCopyMutaArray= [mutaArray mutableCopy];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;\nNSMutableArray memory address\noriginal   :%p\ncopy       :%p\nmutableCopy:%p\n&quot;</span>,</span><br><span class="line">          mutaArray,copyMutaArray,mutaCopyMutaArray);</span><br><span class="line">    </span><br><span class="line">    DBTestModel *firstCopyModel = [copyMutaArray firstObject];</span><br><span class="line">    DBTestModel *firstMutableCopyModel = [mutaCopyMutaArray firstObject];</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;\nDBTestModel memory address\noriginal   :%p\ncopy       :%p\nmutableCopy:%p\n&quot;</span>,</span><br><span class="line">          model1,firstCopyModel,firstMutableCopyModel);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;\nDBTestModel sourceArray memory address\noriginal   :%p\ncopy       :%p\nmutableCopy:%p\n&quot;</span>,</span><br><span class="line">          model1.sourceArray,firstCopyModel.sourceArray,firstMutableCopyModel.sourceArray);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试结果如下： </p>
<p><img src="http://upload-images.jianshu.io/upload_images/117999-50c419ac45f0dd51.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="NSMutableArray.png"></p>
<p>分析其打印数据可知：<br>除<code>NSMutableArray </code>实例对象调用<code>copy</code>和<code>mutableCopy</code>方法为内容复制外，数组内容的元素均为指针拷贝。<br>结合上述测试代码得出的测试数据，得出如下的表格：<br><img src="http://upload-images.jianshu.io/upload_images/117999-cc6317d514f6c864.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p>
<p>从上图可以看出，<code>NSArray</code>或<code>NSMutableArray</code>对象调用<code>copy</code>或<code>mutableCopy</code>时，得到的集合中的元素均为指针拷贝，如果想要实现集合对象的深拷贝，应该怎么办呢？</p>
<ul>
<li><h4 id="如何对集合进行深拷贝？"><a href="#如何对集合进行深拷贝？" class="headerlink" title="如何对集合进行深拷贝？"></a>如何对集合进行深拷贝？</h4></li>
<li><h5 id="集合的单层深复制-one-level-deep-copy"><a href="#集合的单层深复制-one-level-deep-copy" class="headerlink" title="集合的单层深复制 (one-level-deep copy)"></a>集合的单层深复制 (one-level-deep copy)</h5>可以用 <code>initWithArray:copyItems:</code> 将第二个参数设置为YES即可深复制，如<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">NSArray *copyArray = [[NSArray alloc] initWithArray:array copyItems:YES];</span><br></pre></td></tr></table></figure>
如果你用这种方法深复制，集合里的每个对象都会收到 copyWithZone: 消息。同时集合里的对象需遵循 NSCopying 协议，否则会崩溃。<br><img src="http://upload-images.jianshu.io/upload_images/117999-8d496f137b153a4a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></li>
</ul>
<p>得到的结果如下：</p>
<p><img src="http://upload-images.jianshu.io/upload_images/117999-a48a67077a1f4d4a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p>
<p>从打印结果可以看出，拷贝后和拷贝前的数组中的<code>DBTestModel</code>对象的<code>sourceArray</code>的内存地址是相同的，这种拷贝方式只能够提供一层内存拷贝(<code>one-level-deep copy</code>)，而非真正的深复制。</p>
<ul>
<li><h5 id="A-true-deep-copy"><a href="#A-true-deep-copy" class="headerlink" title="A true deep copy"></a>A true deep copy</h5>使用归档来实现:</li>
</ul>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSArray</span> *copyArray = [<span class="built_in">NSKeyedUnarchiver</span> unarchiveObjectWithData:</span><br><span class="line">       [<span class="built_in">NSKeyedArchiver</span> archivedDataWithRootObject:array]];</span><br></pre></td></tr></table></figure>

<p>####小结<br>在项目中遇到需要需要对对象进行拷贝时，需要理解以下两点：<br>1、对系统自带的不可变对象进行<code>copy</code>时，为指针复制；<br>2、对集合类对象进行<code>copy</code>或<code>mutableCopy</code>时，集合类的元素均为指针复制；<br>3、如只需对集合进行单层深拷贝，可以使用<code>initWithArray:copyItems:</code>类似的方法，将第二个参数设为<code>YES</code>来实现，如需实现集合的完全复制，可以使用归解档来实现；<br>4、第三方库<code> Mantle</code>中的<code>MTLModel</code>类有实现<code>NSCoding</code>和<code>NSCopying</code>协议，自定义的类继承<code>MTLModel</code>类即可实现<code>NSCoding</code>和<code>NSCopying</code>协议。</p>
<h4 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h4><p><a target="_blank" rel="noopener" href="https://developer.apple.com/library/content/documentation/General/Conceptual/DevPedia-CocoaCore/ObjectCopying.html">Object copying</a><br><a target="_blank" rel="noopener" href="https://developer.apple.com/library/content/documentation/Cocoa/Conceptual/Collections/Articles/Copying.html">Copying Collections</a>
 </p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://levertsui.github.io/2017/11/08/MBProgressHUD%20%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="leverTsui">
      <meta itemprop="description" content="要有狮子的力量， 菩萨的心肠">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="leverTsui">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/11/08/MBProgressHUD%20%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" class="post-title-link" itemprop="url">MBProgressHUD 源码分析</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2017-11-08 22:26:00" itemprop="dateCreated datePublished" datetime="2017-11-08T22:26:00+08:00">2017-11-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-02-08 09:46:16" itemprop="dateModified" datetime="2022-02-08T09:46:16+08:00">2022-02-08</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E4%B8%89%E6%96%B9%E5%BC%80%E6%BA%90%E5%BA%93/" itemprop="url" rel="index"><span itemprop="name">三方开源库</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>在项目中经常会使用<code>MBProgressHUD</code>来实现弹窗提醒，所有来分析下<code>MBProgressHUD</code>这个三方库的代码。所分析的源码版本号为1.0.0。</p>
<hr>
<p>这篇总结主要分三个部分来介绍分析这个框架：</p>
<ul>
<li>代码结构</li>
<li>方法调用流程图</li>
<li>方法内部实现</li>
</ul>
<hr>
<h5 id="代码结构"><a href="#代码结构" class="headerlink" title="代码结构"></a>代码结构</h5><h6 id="类图"><a href="#类图" class="headerlink" title="类图"></a>类图</h6><p><img src="http://upload-images.jianshu.io/upload_images/117999-5da3f0778692f17f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="MBProgressHUD.png"></p>
<h5 id="核心API"><a href="#核心API" class="headerlink" title="核心API"></a>核心API</h5><h6 id="属性"><a href="#属性" class="headerlink" title="属性"></a>属性</h6> <figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 用来推迟HUD的显示，避免HUD显示时间过短，出现一闪而逝的情况，默认值为0。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">assign</span>, <span class="keyword">nonatomic</span>) <span class="built_in">NSTimeInterval</span> graceTime;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  HUD最短显示时间，单位为s，默认值为0。 </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">assign</span>, <span class="keyword">nonatomic</span>) <span class="built_in">NSTimeInterval</span> minShowTime;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * HUD隐藏时，将其从父视图上移除 。默认值为NO </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">assign</span>, <span class="keyword">nonatomic</span>) <span class="built_in">BOOL</span> removeFromSuperViewOnHide; </span><br><span class="line"></span><br><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * HUD显示类型，默认为 MBProgressHUDModeIndeterminate.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">assign</span>, <span class="keyword">nonatomic</span>) MBProgressHUDMode mode; </span><br></pre></td></tr></table></figure>
<h6 id="类方法"><a href="#类方法" class="headerlink" title="类方法"></a>类方法</h6><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 创建HUD,添加到提供的视图上并显示</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">+ (<span class="keyword">instancetype</span>)showHUDAddedTo:(<span class="built_in">UIView</span> *)view animated:(<span class="built_in">BOOL</span>)animated;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 找到最上层的HUD,并隐藏。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">+ (<span class="built_in">BOOL</span>)hideHUDForView:(<span class="built_in">UIView</span> *)view animated:(<span class="built_in">BOOL</span>)animated;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 在传入的View上找到最上层的HUD并隐藏此HUD</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">+ (<span class="keyword">nullable</span> MBProgressHUD *)HUDForView:(<span class="built_in">UIView</span> *)view;</span><br></pre></td></tr></table></figure>
<h6 id="实例方法"><a href="#实例方法" class="headerlink" title="实例方法"></a>实例方法</h6><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 构造函数，用来初始化HUD</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithView:(<span class="built_in">UIView</span> *)view;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * 显示HUD</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (<span class="keyword">void</span>)showAnimated:(<span class="built_in">BOOL</span>)animated;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * 隐藏HUD</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (<span class="keyword">void</span>)hideAnimated:(<span class="built_in">BOOL</span>)animated;</span><br></pre></td></tr></table></figure>
<h5 id="方法调用流程图"><a href="#方法调用流程图" class="headerlink" title="方法调用流程图"></a>方法调用流程图</h5><p>从<code>MBProgressHUD</code>提供的主要接口可以看出，主要有显示HUD和隐藏HUD这两个功能，一步步追溯，得出的方法调用流程图如下：<br><img src="http://upload-images.jianshu.io/upload_images/117999-4c522bd388a1a65a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="MBProgressHUD流程图.png"></p>
<h5 id="方法内部实现"><a href="#方法内部实现" class="headerlink" title="方法内部实现"></a>方法内部实现</h5><p>方法的内部实现主要从两个方面来分析，显示HUD和隐藏HUD。</p>
<h6 id="显示HUD"><a href="#显示HUD" class="headerlink" title="显示HUD"></a>显示HUD</h6><p>首先是MBProgressHUD的构造方法</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="keyword">instancetype</span>)showHUDAddedTo:(<span class="built_in">UIView</span> *)view animated:(<span class="built_in">BOOL</span>)animated &#123;</span><br><span class="line">    <span class="comment">//初始化MBProgressHUD</span></span><br><span class="line">    MBProgressHUD *hud = [[<span class="keyword">self</span> alloc] initWithView:view];</span><br><span class="line">    hud.removeFromSuperViewOnHide = <span class="literal">YES</span>;</span><br><span class="line">    [view addSubview:hud];</span><br><span class="line">    [hud showAnimated:animated];</span><br><span class="line">    [[<span class="built_in">UINavigationBar</span> appearance] setBarTintColor:<span class="literal">nil</span>];</span><br><span class="line">    <span class="keyword">return</span> hud;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先进入<code>- (id)initWithView:(UIView *)view</code>方法，再进入<code>- (instancetype)initWithFrame:(CGRect)frame</code>方法，最后调用<code>- (void)commonInit</code>方法，进行属性的初始化和添加子视图。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)commonInit &#123;</span><br><span class="line">    <span class="comment">// Set default values for properties</span></span><br><span class="line">    _animationType = MBProgressHUDAnimationFade;</span><br><span class="line">    _mode = MBProgressHUDModeIndeterminate;</span><br><span class="line">    _margin = <span class="number">20.0</span>f;</span><br><span class="line">    _opacity = <span class="number">1.</span>f;</span><br><span class="line">    _defaultMotionEffectsEnabled = <span class="literal">YES</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Default color, depending on the current iOS version</span></span><br><span class="line">    <span class="built_in">BOOL</span> isLegacy = kCFCoreFoundationVersionNumber &lt; kCFCoreFoundationVersionNumber_iOS_7_0;</span><br><span class="line">    _contentColor = isLegacy ? [<span class="built_in">UIColor</span> whiteColor] : [<span class="built_in">UIColor</span> colorWithWhite:<span class="number">0.</span>f alpha:<span class="number">0.7</span>f];</span><br><span class="line">    <span class="comment">// Transparent background</span></span><br><span class="line">    <span class="keyword">self</span>.opaque = <span class="literal">NO</span>;</span><br><span class="line">    <span class="keyword">self</span>.backgroundColor = [<span class="built_in">UIColor</span> clearColor];</span><br><span class="line">    <span class="comment">// Make it invisible for now</span></span><br><span class="line">    <span class="keyword">self</span>.alpha = <span class="number">0.0</span>f;</span><br><span class="line">    <span class="keyword">self</span>.autoresizingMask = <span class="built_in">UIViewAutoresizingFlexibleWidth</span> | <span class="built_in">UIViewAutoresizingFlexibleHeight</span>;</span><br><span class="line">    <span class="keyword">self</span>.layer.allowsGroupOpacity = <span class="literal">NO</span>;</span><br><span class="line">    <span class="comment">//添加子视图</span></span><br><span class="line">    [<span class="keyword">self</span> setupViews];</span><br><span class="line">    <span class="comment">//更新指示器</span></span><br><span class="line">    [<span class="keyword">self</span> updateIndicators];</span><br><span class="line">    [<span class="keyword">self</span> registerForNotifications];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>添加子视图都是常见的方式，让视图跟随陀螺仪运动，这个之前没有接触过，后续需要了解下。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)updateBezelMotionEffects &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> __IPHONE_OS_VERSION_MAX_ALLOWED &gt;= 70000 || TARGET_OS_TV</span></span><br><span class="line">    MBBackgroundView *bezelView = <span class="keyword">self</span>.bezelView;</span><br><span class="line">    <span class="keyword">if</span> (![bezelView respondsToSelector:<span class="keyword">@selector</span>(addMotionEffect:)]) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.defaultMotionEffectsEnabled) &#123;</span><br><span class="line">        <span class="built_in">CGFloat</span> effectOffset = <span class="number">10.</span>f;</span><br><span class="line">        <span class="built_in">UIInterpolatingMotionEffect</span> *effectX = [[<span class="built_in">UIInterpolatingMotionEffect</span> alloc] initWithKeyPath:<span class="string">@&quot;center.x&quot;</span> type:<span class="built_in">UIInterpolatingMotionEffectTypeTiltAlongHorizontalAxis</span>];</span><br><span class="line">        effectX.maximumRelativeValue = @(effectOffset);</span><br><span class="line">        effectX.minimumRelativeValue = @(-effectOffset);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">UIInterpolatingMotionEffect</span> *effectY = [[<span class="built_in">UIInterpolatingMotionEffect</span> alloc] initWithKeyPath:<span class="string">@&quot;center.y&quot;</span> type:<span class="built_in">UIInterpolatingMotionEffectTypeTiltAlongVerticalAxis</span>];</span><br><span class="line">        effectY.maximumRelativeValue = @(effectOffset);</span><br><span class="line">        effectY.minimumRelativeValue = @(-effectOffset);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">UIMotionEffectGroup</span> *group = [[<span class="built_in">UIMotionEffectGroup</span> alloc] init];</span><br><span class="line">        group.motionEffects = @[effectX, effectY];</span><br><span class="line"></span><br><span class="line">        [bezelView addMotionEffect:group];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">NSArray</span> *effects = [bezelView motionEffects];</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">UIMotionEffect</span> *effect <span class="keyword">in</span> effects) &#123;</span><br><span class="line">            [bezelView removeMotionEffect:effect];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再主要看下更新指示器的代码。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)updateIndicators &#123; </span><br><span class="line">    <span class="built_in">UIView</span> *indicator = <span class="keyword">self</span>.indicator;</span><br><span class="line">    <span class="built_in">BOOL</span> isActivityIndicator = [indicator isKindOfClass:[<span class="built_in">UIActivityIndicatorView</span> <span class="keyword">class</span>]];</span><br><span class="line">    <span class="built_in">BOOL</span> isRoundIndicator = [indicator isKindOfClass:[MBRoundProgressView <span class="keyword">class</span>]];</span><br><span class="line"></span><br><span class="line">    MBProgressHUDMode mode = <span class="keyword">self</span>.mode;</span><br><span class="line">    <span class="comment">//菊花动画</span></span><br><span class="line">    <span class="keyword">if</span> (mode == MBProgressHUDModeIndeterminate) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!isActivityIndicator) &#123;</span><br><span class="line">            <span class="comment">// Update to indeterminate indicator</span></span><br><span class="line">            [indicator removeFromSuperview];</span><br><span class="line">            indicator = [[<span class="built_in">UIActivityIndicatorView</span> alloc] initWithActivityIndicatorStyle:<span class="built_in">UIActivityIndicatorViewStyleWhiteLarge</span>];</span><br><span class="line">            [(<span class="built_in">UIActivityIndicatorView</span> *)indicator startAnimating];</span><br><span class="line">            [<span class="keyword">self</span>.bezelView addSubview:indicator];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//水平进度条动画</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (mode == MBProgressHUDModeDeterminateHorizontalBar) &#123;</span><br><span class="line">        <span class="comment">// Update to bar determinate indicator</span></span><br><span class="line">        [indicator removeFromSuperview];</span><br><span class="line">        indicator = [[MBBarProgressView alloc] init];</span><br><span class="line">        [<span class="keyword">self</span>.bezelView addSubview:indicator];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//圆形进度动画</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (mode == MBProgressHUDModeDeterminate || mode == MBProgressHUDModeAnnularDeterminate) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!isRoundIndicator) &#123;</span><br><span class="line">            <span class="comment">// Update to determinante indicator</span></span><br><span class="line">            [indicator removeFromSuperview];</span><br><span class="line">            indicator = [[MBRoundProgressView alloc] init];</span><br><span class="line">            [<span class="keyword">self</span>.bezelView addSubview:indicator];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//环形动画</span></span><br><span class="line">        <span class="keyword">if</span> (mode == MBProgressHUDModeAnnularDeterminate) &#123;</span><br><span class="line">            [(MBRoundProgressView *)indicator setAnnular:<span class="literal">YES</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//自定义动画</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (mode == MBProgressHUDModeCustomView &amp;&amp; <span class="keyword">self</span>.customView != indicator) &#123;</span><br><span class="line">        <span class="comment">// Update custom view indicator</span></span><br><span class="line">        [indicator removeFromSuperview];</span><br><span class="line">        indicator = <span class="keyword">self</span>.customView;</span><br><span class="line">        [<span class="keyword">self</span>.bezelView addSubview:indicator];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//只显示文本</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (mode == MBProgressHUDModeText) &#123;</span><br><span class="line">        [indicator removeFromSuperview];</span><br><span class="line">        indicator = <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    indicator.translatesAutoresizingMaskIntoConstraints = <span class="literal">NO</span>;</span><br><span class="line">    <span class="keyword">self</span>.indicator = indicator;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ([indicator respondsToSelector:<span class="keyword">@selector</span>(setProgress:)]) &#123;</span><br><span class="line">        [(<span class="keyword">id</span>)indicator setValue:@(<span class="keyword">self</span>.progress) forKey:<span class="string">@&quot;progress&quot;</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [indicator setContentCompressionResistancePriority:<span class="number">998.</span>f forAxis:<span class="built_in">UILayoutConstraintAxisHorizontal</span>];</span><br><span class="line">    [indicator setContentCompressionResistancePriority:<span class="number">998.</span>f forAxis:<span class="built_in">UILayoutConstraintAxisVertical</span>];</span><br><span class="line"></span><br><span class="line">    [<span class="keyword">self</span> updateViewsForColor:<span class="keyword">self</span>.contentColor];</span><br><span class="line">    [<span class="keyword">self</span> setNeedsUpdateConstraints];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这个方法中，主要是根据显示的模式，将不同的<code>indicator</code>视图赋值给<code>indicator</code>属性。更新完指示器后，就是开始将视图显示在界面上。调用的是<code>- (void)showAnimated:(BOOL)animated</code>方法。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)showAnimated:(<span class="built_in">BOOL</span>)animated &#123;</span><br><span class="line">    <span class="comment">//保证当前线程是主线程</span></span><br><span class="line">    MBMainThreadAssert();</span><br><span class="line">    [<span class="keyword">self</span>.minShowTimer invalidate];</span><br><span class="line">    <span class="keyword">self</span>.useAnimation = animated;</span><br><span class="line">    <span class="keyword">self</span>.finished = <span class="literal">NO</span>;</span><br><span class="line">    <span class="comment">// 如果设置了宽限时间，则推迟HUD的显示</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.graceTime &gt; <span class="number">0.0</span>) &#123;</span><br><span class="line">        <span class="built_in">NSTimer</span> *timer = [<span class="built_in">NSTimer</span> timerWithTimeInterval:<span class="keyword">self</span>.graceTime</span><br><span class="line">                                                 target:<span class="keyword">self</span></span><br><span class="line">                                               selector:<span class="keyword">@selector</span>(handleGraceTimer:)</span><br><span class="line">                                               userInfo:<span class="literal">nil</span></span><br><span class="line">                                                repeats:<span class="literal">NO</span>];</span><br><span class="line">        <span class="comment">//默认把你的Timer以NSDefaultRunLoopMode添加到MainRunLoop上，而当当前视图在滚动时，当前的MainRunLoop是处于UITrackingRunLoopMode的模式下，在这个模式下，是不会处理NSDefaultRunLoopMode的消息，要想在scrollView滚动的同时Timer也执行的话，我们需要将Timer以NSRunLoopCommonModes的模式注册到当前RunLoop中.</span></span><br><span class="line">        [[<span class="built_in">NSRunLoop</span> currentRunLoop] addTimer:timer forMode:<span class="built_in">NSRunLoopCommonModes</span>];</span><br><span class="line">        <span class="keyword">self</span>.graceTimer = timer;</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="comment">// ... otherwise show the HUD immediately</span></span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        [<span class="keyword">self</span> showUsingAnimation:<span class="keyword">self</span>.useAnimation];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在<code>- (void)showAnimated:(BOOL)animated</code>方法中，主要做的是判断是否设置了推迟显示HUD的时间，如果设置了，就推迟设置的时间再显示。最后，执行<code>- (void)showUsingAnimation:(BOOL)animated</code>方法。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)showUsingAnimation:(<span class="built_in">BOOL</span>)animated &#123;</span><br><span class="line">    <span class="comment">// Cancel any previous animations</span></span><br><span class="line">    [<span class="keyword">self</span>.bezelView.layer removeAllAnimations];</span><br><span class="line">    [<span class="keyword">self</span>.backgroundView.layer removeAllAnimations];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Cancel any scheduled hideDelayed: calls</span></span><br><span class="line">    [<span class="keyword">self</span>.hideDelayTimer invalidate];</span><br><span class="line">    <span class="comment">//记录当前显示的时间，在HUD隐藏时，比较HUD显示到HUD隐藏之间的间隔与最小显示时间，</span></span><br><span class="line">    <span class="comment">//如果小于，继续显示，直到显示时间等于最小显示时间，再隐藏HUD</span></span><br><span class="line">    <span class="keyword">self</span>.showStarted = [<span class="built_in">NSDate</span> date];</span><br><span class="line">    <span class="keyword">self</span>.alpha = <span class="number">1.</span>f;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Needed in case we hide and re-show with the same NSProgress object attached.</span></span><br><span class="line">    <span class="comment">//好像是通过这个去刷新进度，这个需要再查下。</span></span><br><span class="line">    [<span class="keyword">self</span> setNSProgressDisplayLinkEnabled:<span class="literal">YES</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (animated) &#123;</span><br><span class="line">        [<span class="keyword">self</span> animateIn:<span class="literal">YES</span> withType:<span class="keyword">self</span>.animationType completion:<span class="literal">NULL</span>];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> clang diagnostic push</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> clang diagnostic ignored <span class="string">&quot;-Wdeprecated-declarations&quot;</span></span></span><br><span class="line">        <span class="keyword">self</span>.bezelView.alpha = <span class="keyword">self</span>.opacity;</span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> clang diagnostic pop</span></span><br><span class="line">        <span class="keyword">self</span>.backgroundView.alpha = <span class="number">1.</span>f;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后执行<code>- (void)animateIn:(BOOL)animatingIn withType:(MBProgressHUDAnimation)type completion:(void(^)(BOOL finished))completion</code>方法，这个方法显示和隐藏均会调用。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//这个方法主要对self.bezelView视图进行动画</span></span><br><span class="line">- (<span class="keyword">void</span>)animateIn:(<span class="built_in">BOOL</span>)animatingIn withType:(MBProgressHUDAnimation)type completion:(<span class="keyword">void</span>(^)(<span class="built_in">BOOL</span> finished))completion &#123;</span><br><span class="line">    <span class="comment">// Automatically determine the correct zoom animation type</span></span><br><span class="line">    <span class="keyword">if</span> (type == MBProgressHUDAnimationZoom) &#123;</span><br><span class="line">        type = animatingIn ? MBProgressHUDAnimationZoomIn : MBProgressHUDAnimationZoomOut;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">CGAffineTransform</span> small = <span class="built_in">CGAffineTransformMakeScale</span>(<span class="number">0.5</span>f, <span class="number">0.5</span>f);</span><br><span class="line">    <span class="built_in">CGAffineTransform</span> large = <span class="built_in">CGAffineTransformMakeScale</span>(<span class="number">1.5</span>f, <span class="number">1.5</span>f);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Set starting state</span></span><br><span class="line">    <span class="built_in">UIView</span> *bezelView = <span class="keyword">self</span>.bezelView;</span><br><span class="line">    <span class="keyword">if</span> (animatingIn &amp;&amp; bezelView.alpha == <span class="number">0.</span>f &amp;&amp; type == MBProgressHUDAnimationZoomIn) &#123;</span><br><span class="line">        bezelView.transform = small;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (animatingIn &amp;&amp; bezelView.alpha == <span class="number">0.</span>f &amp;&amp; type == MBProgressHUDAnimationZoomOut) &#123;</span><br><span class="line">        bezelView.transform = large;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用动画</span></span><br><span class="line">    dispatch_block_t animations = ^&#123;</span><br><span class="line">        <span class="keyword">if</span> (animatingIn) &#123;</span><br><span class="line">            bezelView.transform = <span class="built_in">CGAffineTransformIdentity</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!animatingIn &amp;&amp; type == MBProgressHUDAnimationZoomIn) &#123;</span><br><span class="line">            bezelView.transform = large;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!animatingIn &amp;&amp; type == MBProgressHUDAnimationZoomOut) &#123;</span><br><span class="line">            bezelView.transform = small;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> clang diagnostic push</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> clang diagnostic ignored <span class="string">&quot;-Wdeprecated-declarations&quot;</span></span></span><br><span class="line">        bezelView.alpha = animatingIn ? <span class="keyword">self</span>.opacity : <span class="number">0.</span>f;</span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> clang diagnostic pop</span></span><br><span class="line">        <span class="keyword">self</span>.backgroundView.alpha = animatingIn ? <span class="number">1.</span>f : <span class="number">0.</span>f;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Spring animations are nicer, but only available on iOS 7+</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> __IPHONE_OS_VERSION_MAX_ALLOWED &gt;= 70000 || TARGET_OS_TV</span></span><br><span class="line">    <span class="keyword">if</span> (kCFCoreFoundationVersionNumber &gt;= kCFCoreFoundationVersionNumber_iOS_7_0) &#123;</span><br><span class="line">        [<span class="built_in">UIView</span> animateWithDuration:<span class="number">0.3</span> delay:<span class="number">0.</span> usingSpringWithDamping:<span class="number">1.</span>f initialSpringVelocity:<span class="number">0.</span>f options:<span class="built_in">UIViewAnimationOptionBeginFromCurrentState</span> animations:animations completion:completion];</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    [<span class="built_in">UIView</span> animateWithDuration:<span class="number">0.3</span> delay:<span class="number">0.</span> options:<span class="built_in">UIViewAnimationOptionBeginFromCurrentState</span> animations:animations completion:completion];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从代码可以看出，这里只是对指示器的父视图做了放大缩小的动画。</p>
<h6 id="隐藏HUD"><a href="#隐藏HUD" class="headerlink" title="隐藏HUD"></a>隐藏HUD</h6><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">+ (<span class="built_in">BOOL</span>)hideHUDForView:(<span class="built_in">UIView</span> *)view animated:(<span class="built_in">BOOL</span>)animated &#123;</span><br><span class="line">    <span class="comment">//获取当前显示的hud,如果存在，当前隐藏时，将其从父视图移除</span></span><br><span class="line">    MBProgressHUD *hud = [<span class="keyword">self</span> HUDForView:view];</span><br><span class="line">    <span class="keyword">if</span> (hud != <span class="literal">nil</span>) &#123;</span><br><span class="line">        hud.removeFromSuperViewOnHide = <span class="literal">YES</span>;</span><br><span class="line">        [hud hideAnimated:animated];</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这个方法的执行过程中，调用<code>- (void)hideAnimated:(BOOL)animated </code>方法。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"> - (<span class="keyword">void</span>)hideAnimated:(<span class="built_in">BOOL</span>)animated &#123;</span><br><span class="line">    MBMainThreadAssert();</span><br><span class="line">    [<span class="keyword">self</span>.graceTimer invalidate];</span><br><span class="line">    <span class="keyword">self</span>.useAnimation = animated;</span><br><span class="line">    <span class="keyword">self</span>.finished = <span class="literal">YES</span>;</span><br><span class="line">    <span class="comment">// 如果设置了最小显示时间，计算HUD显示时长，</span></span><br><span class="line">    <span class="comment">// 如果HUD显示时长小于最小显示时间，延迟显示</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.minShowTime &gt; <span class="number">0.0</span> &amp;&amp; <span class="keyword">self</span>.showStarted) &#123;</span><br><span class="line">        <span class="built_in">NSTimeInterval</span> interv = [[<span class="built_in">NSDate</span> date] timeIntervalSinceDate:<span class="keyword">self</span>.showStarted];</span><br><span class="line">        <span class="keyword">if</span> (interv &lt; <span class="keyword">self</span>.minShowTime) &#123;</span><br><span class="line">            <span class="built_in">NSTimer</span> *timer = [<span class="built_in">NSTimer</span> timerWithTimeInterval:(<span class="keyword">self</span>.minShowTime - interv) target:<span class="keyword">self</span> selector:<span class="keyword">@selector</span>(handleMinShowTimer:) userInfo:<span class="literal">nil</span> repeats:<span class="literal">NO</span>];</span><br><span class="line">            [[<span class="built_in">NSRunLoop</span> currentRunLoop] addTimer:timer forMode:<span class="built_in">NSRunLoopCommonModes</span>];</span><br><span class="line">            <span class="keyword">self</span>.minShowTimer = timer;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125; </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ... otherwise hide the HUD immediately</span></span><br><span class="line">    [<span class="keyword">self</span> hideUsingAnimation:<span class="keyword">self</span>.useAnimation];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>- (void)hideAnimated:(BOOL)animated </code>方法中，主要做的是判断是否需要推迟隐藏HUD，最后调用<code>- (void)hideUsingAnimation:(BOOL)animated</code>方法，</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)hideUsingAnimation:(<span class="built_in">BOOL</span>)animated &#123;</span><br><span class="line">    <span class="comment">//判断是否需要动画效果，如无，则直接隐藏</span></span><br><span class="line">    <span class="keyword">if</span> (animated &amp;&amp; <span class="keyword">self</span>.showStarted) &#123;</span><br><span class="line">        <span class="keyword">self</span>.showStarted = <span class="literal">nil</span>;</span><br><span class="line">        <span class="comment">//跟显示HUD差不多，只是指示器父视图没有做放大缩小的动画</span></span><br><span class="line">        [<span class="keyword">self</span> animateIn:<span class="literal">NO</span> withType:<span class="keyword">self</span>.animationType completion:^(<span class="built_in">BOOL</span> finished) &#123;</span><br><span class="line">            [<span class="keyword">self</span> done];</span><br><span class="line">        &#125;];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.showStarted = <span class="literal">nil</span>;</span><br><span class="line">        <span class="keyword">self</span>.bezelView.alpha = <span class="number">0.</span>f;</span><br><span class="line">        <span class="keyword">self</span>.backgroundView.alpha = <span class="number">1.</span>f;</span><br><span class="line">        [<span class="keyword">self</span> done];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后，调用<code>- (void)done</code>方法。这个方法主要负责属性的释放和隐藏完成回调的处理。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)done &#123;</span><br><span class="line">    <span class="comment">// Cancel any scheduled hideDelayed: calls</span></span><br><span class="line">    [<span class="keyword">self</span>.hideDelayTimer invalidate];</span><br><span class="line">    <span class="comment">//指示进度的显示问题，后续还需再补充</span></span><br><span class="line">    [<span class="keyword">self</span> setNSProgressDisplayLinkEnabled:<span class="literal">NO</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.hasFinished) &#123;</span><br><span class="line">        <span class="keyword">self</span>.alpha = <span class="number">0.0</span>f;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">self</span>.removeFromSuperViewOnHide) &#123;</span><br><span class="line">            [<span class="keyword">self</span> removeFromSuperview];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    MBProgressHUDCompletionBlock completionBlock = <span class="keyword">self</span>.completionBlock;</span><br><span class="line">    <span class="keyword">if</span> (completionBlock) &#123;</span><br><span class="line">        completionBlock();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">id</span>&lt;MBProgressHUDDelegate&gt; delegate = <span class="keyword">self</span>.delegate;</span><br><span class="line">    <span class="keyword">if</span> ([delegate respondsToSelector:<span class="keyword">@selector</span>(hudWasHidden:)]) &#123;</span><br><span class="line">        [delegate performSelector:<span class="keyword">@selector</span>(hudWasHidden:) withObject:<span class="keyword">self</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h5><p>从代码来看，<code>MBProgressHUD</code>这个三方库有几个地方值借鉴：</p>
<ul>
<li><code>graceTime</code>和<code>minShowTime</code>，在开发的时候会出现显示HUD后，存在缓存或者网速较好时，HUD显示到HUD隐藏的时间较短，界面出现闪动的情况，这时，就可以通过设置<code>graceTime</code>和<code>minShowTime</code>来处理，达到更好的用户体验。 这个在封装弹窗控件时，可以参考。</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://levertsui.github.io/2017/11/06/iOS%E5%B8%83%E5%B1%80%E4%B8%8EMasnory%E4%BD%BF%E7%94%A8%E5%AE%9E%E8%B7%B5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="leverTsui">
      <meta itemprop="description" content="要有狮子的力量， 菩萨的心肠">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="leverTsui">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/11/06/iOS%E5%B8%83%E5%B1%80%E4%B8%8EMasnory%E4%BD%BF%E7%94%A8%E5%AE%9E%E8%B7%B5/" class="post-title-link" itemprop="url">iOS布局与Masnory使用实践</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2017-11-06 18:46:28" itemprop="dateCreated datePublished" datetime="2017-11-06T18:46:28+08:00">2017-11-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-02-08 09:46:16" itemprop="dateModified" datetime="2022-02-08T09:46:16+08:00">2022-02-08</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/iOS-%E8%87%AA%E5%8A%A8%E5%B8%83%E5%B1%80/" itemprop="url" rel="index"><span itemprop="name">iOS 自动布局</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h5 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h5><p><code>UI</code>布局对于<code>iOS</code>开发者来说并不陌生，在<code>iOS6</code>之前，大家都是通过<code>UI</code>控件的<code>Frame</code>属性和<code>Autoresizing Mask</code>来进行<code>UI</code>布局的（简称为手动布局）。<code>AutoLayout</code>则是苹果公司在<code>iOS6</code>推出的一种基于约束的，描述性的布局系统（简称为自动布局），这里主要从四个方面来阐述iOS布局及实践。</p>
<ul>
<li>手动布局和自动布局</li>
<li><code>AutoLayout</code>原理</li>
<li><code>AutoLayout</code>的性能</li>
<li><code>Masnory</code>的使用</li>
</ul>
<p>首先对手动布局和自动布局做一个简单的介绍：</p>
<h5 id="手动布局和自动布局"><a href="#手动布局和自动布局" class="headerlink" title="手动布局和自动布局"></a>手动布局和自动布局</h5><ul>
<li><p>手动布局：指的是通过直接修改视图的<code>frame</code>属性的方式对界面进行布局。 </p>
<blockquote>
<p>对于<code>IOS</code>的<code>app</code>开发者来说，不会像<code>Android</code>开发者一样为很多的屏幕尺寸来做界面适配，因此手动调整 <code>frame</code>的方式来布局也能工作良好。但是还是会有一些问题，如设备发生旋转、适配<code>ipad</code>等，并且保证视图原来之间的相对关系，则以上的方法都是无法解决的。如果要做这些适配，在<code>AutoLayout</code>未出来之前需要编写大量的代码，并且花费大量的调试适配时间。 </p>
</blockquote>
</li>
<li><p>自动布局：指的是使用<code>AutoLayout</code>的方式对界面进行布局。</p>
</li>
</ul>
<blockquote>
<p><code>AutoLayout</code> 是苹果本身提倡的技术，在大部分情况下也能很好的提升开发效率，但是 <code>AutoLayout </code>对于复杂视图来说常常会产生严重的性能问题。随着视图数量的增长，<code>AutoLayout</code> 带来的 <code>CPU</code> 消耗会呈指数级上升。 如果对界面流畅度要求较高（如微博界面），可以通过提前计算好布局，在需要时一次性调整好对应属性 ，或者使用 <code>ComponentKit</code>、<code>AsyncDisplayKit</code> 等框架来处理界面布局。</p>
</blockquote>
<p>下面，我们来分析下 AutoLayout的原理。</p>
<h5 id="AutoLayout的原理"><a href="#AutoLayout的原理" class="headerlink" title="AutoLayout的原理"></a>AutoLayout的原理</h5><p>这里通过使用<code>Masonry</code>来进行布局，从而来分析<code>AutoLayout</code>的原理，先简要了解下<code>Masonry</code>。<br><code>Masonry</code>是一个轻量级的布局框架，拥有自己的描述语法，采用更优雅的链式语法封装自动布局，简洁明了，并具有高可读性，而且同时支持 <code>iOS</code> 和 <code>Max OS X</code>。<br><code>Masnory</code>支持的常用属性如下：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) MASConstraint *left;     <span class="comment">//左侧</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) MASConstraint *top;      <span class="comment">//上侧</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) MASConstraint *right;   <span class="comment">//右侧</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) MASConstraint *bottom;   <span class="comment">//下侧</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) MASConstraint *leading;  <span class="comment">//首部</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) MASConstraint *trailing;  <span class="comment">//首部</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) MASConstraint *width;    <span class="comment">//宽</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) MASConstraint *height;   <span class="comment">//高</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) MASConstraint *centerX;  <span class="comment">//横向中点</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) MASConstraint *centerY;  <span class="comment">//纵向中点</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) MASConstraint *baseline; <span class="comment">//文本基线 </span></span><br></pre></td></tr></table></figure>
<p><strong>其中<code>leading</code>与<code>left</code>，<code>trailing</code>与<code>right</code> 在正常情况下是等价的，但是当一些布局是从右至左时(比如阿拉伯语) 则会对调。</strong><br>同时，在<code>Masonry</code>中能够添加<code>AutoLayout</code>约束有三个函数：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">NSArray</span> *)mas_makeConstraints:(<span class="keyword">void</span>(^)(MASConstraintMaker *make))block;<span class="comment">//只负责新增约束` AutoLayout`不能同时存在两条针对于同一对象的约束,否则会报错</span></span><br><span class="line">- (<span class="built_in">NSArray</span> *)mas_updateConstraints:(<span class="keyword">void</span>(^)(MASConstraintMaker *make))block;<span class="comment">//针对上面的情况 会更新在block中出现的约束 不会导致出现两个相同约束的情况</span></span><br><span class="line">- (<span class="built_in">NSArray</span> *)mas_remakeConstraints:(<span class="keyword">void</span>(^)(MASConstraintMaker *make))block;<span class="comment">//则会清除之前的所有约束 仅保留最新的约束</span></span><br></pre></td></tr></table></figure>
<p>我们在代码中，经常会使用到<code>equalTo</code>和<code>mas_equalTo</code>，那它们的区别是什么呢？从代码中找到他们的定义如下：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> mas_equalTo(...)                 equalTo(MASBoxValue((__VA_ARGS__)))</span></span><br><span class="line">...</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MASBoxValue(value) _MASBoxValue(@encode(__typeof__((value))), (value))</span></span><br></pre></td></tr></table></figure>
<p>可以看到 <code>mas_equalTo</code>只是对其参数进行了一个<code>BOX</code>操作(装箱) ，所支持的类型，除了<code>NSNumber</code>支持的那些数值类型之外，还支持<code>CGPoint</code>，<code>CGSize</code>和<code>UIEdgeInsets</code>类型。<br>下面，我们通过一个例子，一步步来看下界面是怎么布局的，代码如下：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</span><br><span class="line">    [<span class="keyword">super</span> viewDidLoad];</span><br><span class="line">    <span class="keyword">self</span>.view.backgroundColor = [<span class="built_in">UIColor</span> blackColor];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">UIView</span> *v1 = [[<span class="built_in">UIView</span> alloc] init];</span><br><span class="line">    v1.backgroundColor = [<span class="built_in">UIColor</span> orangeColor];</span><br><span class="line">    [v1 showPlaceHolder];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">UIView</span> *v2 = [[<span class="built_in">UIView</span> alloc] init];</span><br><span class="line">    v2.backgroundColor = [<span class="built_in">UIColor</span> orangeColor];</span><br><span class="line">    [v2 showPlaceHolder];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">UIView</span> *v3 = [[<span class="built_in">UIView</span> alloc] init];</span><br><span class="line">    v3.backgroundColor = [<span class="built_in">UIColor</span> orangeColor];</span><br><span class="line">    [v3 showPlaceHolder];</span><br><span class="line">    </span><br><span class="line">    [<span class="keyword">self</span>.view addSubview:v1];</span><br><span class="line">    [<span class="keyword">self</span>.view addSubview:v2];</span><br><span class="line">    [<span class="keyword">self</span>.view addSubview:v3];</span><br><span class="line">    </span><br><span class="line">    [v1 mas_makeConstraints:^(MASConstraintMaker *make) &#123;</span><br><span class="line">        make.top.mas_equalTo(<span class="number">100</span>);</span><br><span class="line">        make.leading.mas_equalTo(<span class="number">100</span>);</span><br><span class="line">        make.width.mas_equalTo(<span class="number">70</span>);</span><br><span class="line">        make.height.mas_equalTo(<span class="number">65</span>);</span><br><span class="line">    &#125;];</span><br><span class="line">    </span><br><span class="line">    [v2 mas_makeConstraints:^(MASConstraintMaker *make) &#123;</span><br><span class="line">        make.top.equalTo(v1.mas_top);</span><br><span class="line">        make.leading.mas_equalTo(v1.mas_trailing).offset(<span class="number">20</span>);</span><br><span class="line">        make.width.equalTo(v1.mas_width);</span><br><span class="line">        make.height.equalTo(v1.mas_height);</span><br><span class="line">    &#125;];</span><br><span class="line">    </span><br><span class="line">    [v3 mas_makeConstraints:^(MASConstraintMaker *make) &#123;</span><br><span class="line">        make.top.equalTo(v1.mas_bottom).offset(<span class="number">20</span>);</span><br><span class="line">        make.leading.equalTo(v1.mas_leading);</span><br><span class="line">        make.trailing.equalTo(v2.mas_trailing);</span><br><span class="line">        make.height.equalTo(v1.mas_height);</span><br><span class="line">    &#125;];</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<p>界面运行结果如下图：<br><img src="http://upload-images.jianshu.io/upload_images/5835116-10acd4fa0c0e292c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="CD52E302-FAFD-4D6E-9DFF-F5DB44C6098B.png"><br>下面，我们将界面中的左上角的视图视为视图1，右上角的视图视为视图2，底部视图视为视图3，使用<code>x1、y1、m1、n1</code>来标识视图1的<code>left</code>、<code>top</code>、<code>width</code>和<code>height</code>，以此类推。<br>通过以上举例抽象出自动布局数学公式：<br> <img src="http://upload-images.jianshu.io/upload_images/5835116-6ceec51e08a7f571.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="1C7344E7-1ED1-421A-B84E-ACBD70F98859.png"><br>将以上等式变形为：</p>
<p><img src="http://upload-images.jianshu.io/upload_images/5835116-101854d5027207fd.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="8AAD54BE-0157-4591-A117-0094F69BE6E7.png"><br>此时，以上方程组，大家肯定很熟悉了，也就是《线性代数》中的线性方程组，现在将以上线性方程组抽象为：</p>
<p><img src="http://upload-images.jianshu.io/upload_images/5835116-665ec9939aa6a902.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="B5E84F57-07DE-4A15-9D06-3D0ADD7E6EBD.png"><br>上图表示“等式”方程组，那么是否还可以继续抽象？也就是说上述方程组能否完全表示未知元素之间与已知元素之间的关系，显然还不全面，因为还有（&lt;,&gt;,&lt;&#x3D;,&gt;&#x3D;）不等关系，因此将“&#x3D;”等号抽象为关系”R”,在数学上关系R也就包括了“&#x3D;”,”&lt;”,”&gt;”,”&lt;&#x3D;”,”&gt;&#x3D;”等关系。上述线程方程组变形为：（实质上，AutoLayout中所有的约束确实都是用数学关系式y R ax + b描述）</p>
<p><img src="http://upload-images.jianshu.io/upload_images/5835116-8ae25f0ead6f4c29.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="9A877277-5DEB-437C-AEF6-D6530AB6FE6F.png"><br>现在已经将自动布局一步步抽象为数学公式，那么对视图的布局其实就是对线性方程组的求解。线性方程组解的情况有三种，实质上也对应着自动布局对视图的三种布局方案:</p>
<ul>
<li>唯一解：所有方程中的未知数能够解出唯一解。 充分约束：给一个视图添加的约束必须是充分的，才能正确布局一个视图；</li>
<li>多个解：未知数不能求解出准确的唯一解，即未知数可能存在多个或者无限个解满足线性方程组。 欠约束：给视图所添加的约束不能够充分的表达视图的准确位置，在这种情况下自动布局会随意给视图一个布局方案，也就是自动布局中视图不能够正确布局或者视图丢失的情况。 </li>
<li>无解：不存在满足线性方程组的解。 冲突约束：给视图添加的约束表达视图布局出现了冲突，比如同时满足同一个视图宽度即为100又为200，这是不可能存在的。此时程序会出现崩溃。</li>
</ul>
<p>通过以上描述，将<code>AutoLayout</code>系统的作用描述如图所示：</p>
<p><img src="http://upload-images.jianshu.io/upload_images/5835116-55978c66c8eea66b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="FBB5F53F-0B23-48B2-B150-39B405BFB335.png"></p>
<h5 id="AutoLayout的性能"><a href="#AutoLayout的性能" class="headerlink" title="AutoLayout的性能"></a><code>AutoLayout</code>的性能</h5><p>从<code>AutoLayout</code>的原理，我们可以得出布局系统最后仍然需要通过<code>frame</code>来进行布局，相比原有的布局系统加入了从约束计算 出<code>frame</code> 的过程,那么这个过程对性能是否会影响呢？<br>你可以在 <a target="_blank" rel="noopener" href="https://github.com/leverTsui/summary"><strong>这里</strong></a> 找到这次对 <code>Layout</code> 性能测量使用的代码。<br>代码分别使用<code>Auto Layout</code>、嵌套视图层级中使用 <code>Auto Layout </code>和<code>frame</code>对 <code>N</code> 个视图进行布局，测算其运行时间。</p>
<p>对视图数量在 1~35 之间布局时间进行测量，结果如下：</p>
<p><img src="http://upload-images.jianshu.io/upload_images/117999-045780ced38306d5.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="视图数量范围为 1~35.png"></p>
<p>对视图数量在 10~500 之间布局时间进行测量，结果如下：</p>
<p><img src="http://upload-images.jianshu.io/upload_images/117999-4a5f70dd55e894d8.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="视图数量范围为 10~500.png"><br>从上述的测试数据可以看出，<strong>使用<code>frame</code>、<code>AutoLayout</code>和嵌套视图层级中使用 <code>Auto Layout</code>进行布局、对应的视图数量分别为<code>50</code>个、<code>6</code>个和<code>12</code>个，所需要的时间就会在 <code>16.67 ms </code>左右。</strong>,而想要让 iOS 应用的视图保持 60 FPS 的刷新频率，我们必须在 1&#x2F;60 &#x3D; 16.67 ms 之内完成包括布局、绘制以及渲染等操作。<br>综上所述，虽然说 <code>Auto Layout</code> 为开发者在多尺寸布局上提供了遍历，而且支持跨越视图层级的约束，但是由于其实现原理导致其时间复杂度为<strong>多项式时间</strong>，其性能损耗是仅使用 <code>frame</code> 的十几倍，所以在处理庞大的 <code>UI </code>界面时表现差强人意。 </p>
<h5 id="Masnory的使用"><a href="#Masnory的使用" class="headerlink" title="Masnory的使用"></a><code>Masnory</code>的使用</h5><p>下面，我们通过4个实例，来了解下<code>Masnory</code>的使用。</p>
<ul>
<li>######case 1: 并排显示两个<code>label</code>，宽度由内容决定。父视图宽度不够时，优先显示右边<code>label</code>的内容。</li>
</ul>
<p>在默认情况下，我们没有设置各个布局的优先级，那么他就会优先显示左边的<code>label</code>，左边的完全显示后剩余的空间都是右边的<code>label</code>，如果整个空间宽度都不够左边的<code>label</code>的话，那么右边的<code>label</code>就没有显示的机会了。<br>如果我们现在的需求是优先显示右边的<code>label</code>，左边的<code>label</code>内容超出的省略，这时就需要我们调整约束的优先级了。<br><code>UIView</code>中关于<code>Content Hugging</code> 和<code> Content Compression Resistance</code>的方法有：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">UILayoutPriority</span>)contentHuggingPriorityForAxis:(<span class="built_in">UILayoutConstraintAxis</span>)axis <span class="built_in">NS_AVAILABLE_IOS</span>(<span class="number">6</span>_0);</span><br><span class="line">- (<span class="keyword">void</span>)setContentHuggingPriority:(<span class="built_in">UILayoutPriority</span>)priority forAxis:(<span class="built_in">UILayoutConstraintAxis</span>)axis <span class="built_in">NS_AVAILABLE_IOS</span>(<span class="number">6</span>_0);</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">UILayoutPriority</span>)contentCompressionResistancePriorityForAxis:(<span class="built_in">UILayoutConstraintAxis</span>)axis <span class="built_in">NS_AVAILABLE_IOS</span>(<span class="number">6</span>_0);</span><br><span class="line">- (<span class="keyword">void</span>)setContentCompressionResistancePriority:(<span class="built_in">UILayoutPriority</span>)priority forAxis:(<span class="built_in">UILayoutConstraintAxis</span>)axis <span class="built_in">NS_AVAILABLE_IOS</span>(<span class="number">6</span>_0);</span><br></pre></td></tr></table></figure>
<p>那么这两个东西到底是什么呢？可以这样形象的理解一下：</p>
<ul>
<li><code>contentHugging</code>: 抱住使其在“内容大小”的基础上不能继续变大，这个属性的优先级越高，就要越“抱紧”视图里面的内容。也就是视图的大小不会随着父视图的扩大而扩大。</li>
<li><code>contentCompression</code>: 撑住使其在在其“内容大小”的基础上不能继续变小,这个属性的优先级越高，越不“容易”被压缩。也就是说，当整体的空间装不下所有的视图时，<code>Content Compression Resistance</code>优先级越高的，显示的内容越完整。<br>这两个属性分别可以设置水平方向和垂直方向上的，而且一个默认优先级是250， 一个默认优先级是750. 因为这两个很有可能与其他Constraint冲突，所以优先级较低。</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="built_in">UILayoutPriority</span> <span class="built_in">UILayoutPriorityRequired</span> <span class="built_in">NS_AVAILABLE_IOS</span>(<span class="number">6</span>_0) = <span class="number">1000</span>; <span class="comment">// A required constraint.  Do not exceed this.</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="built_in">UILayoutPriority</span> <span class="built_in">UILayoutPriorityDefaultHigh</span> <span class="built_in">NS_AVAILABLE_IOS</span>(<span class="number">6</span>_0) = <span class="number">750</span>; <span class="comment">// This is the priority level with which a button resists compressing its content.</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="built_in">UILayoutPriority</span> <span class="built_in">UILayoutPriorityDefaultLow</span> <span class="built_in">NS_AVAILABLE_IOS</span>(<span class="number">6</span>_0) = <span class="number">250</span>; <span class="comment">// This is the priority level at which a button hugs its contents horizontally.</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="built_in">UILayoutPriority</span> <span class="built_in">UILayoutPriorityFittingSizeLevel</span> <span class="built_in">NS_AVAILABLE_IOS</span>(<span class="number">6</span>_0) = <span class="number">50</span>; </span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)layoutPageSubViews &#123;</span><br><span class="line">    </span><br><span class="line">    [<span class="keyword">self</span>.leftLabel mas_makeConstraints:^(MASConstraintMaker *make) &#123;</span><br><span class="line">        make.top.equalTo(<span class="keyword">self</span>.contentView1.mas_top).with.offset(<span class="number">5</span>);</span><br><span class="line">        make.left.equalTo(<span class="keyword">self</span>.contentView1.mas_left).with.offset(<span class="number">2</span>);</span><br><span class="line">        make.height.equalTo(@<span class="number">40</span>);</span><br><span class="line">    &#125;];</span><br><span class="line">    </span><br><span class="line">    [<span class="keyword">self</span>.rightLabel mas_makeConstraints:^(MASConstraintMaker *make) &#123;</span><br><span class="line">        make.left.equalTo(<span class="keyword">self</span>.leftLabel.mas_right).with.offset(<span class="number">2</span>);</span><br><span class="line">        make.top.equalTo(<span class="keyword">self</span>.contentView1.mas_top).with.offset(<span class="number">5</span>);</span><br><span class="line">        make.right.lessThanOrEqualTo(<span class="keyword">self</span>.contentView1.mas_right).with.offset(<span class="number">-2</span>);</span><br><span class="line">        make.height.equalTo(@<span class="number">40</span>);</span><br><span class="line"></span><br><span class="line">    &#125;];</span><br><span class="line">    </span><br><span class="line">    [<span class="keyword">self</span>.leftLabel setContentHuggingPriority:<span class="built_in">UILayoutPriorityRequired</span></span><br><span class="line">                               forAxis:<span class="built_in">UILayoutConstraintAxisHorizontal</span>];</span><br><span class="line">    [<span class="keyword">self</span>.leftLabel setContentCompressionResistancePriority:<span class="built_in">UILayoutPriorityDefaultLow</span></span><br><span class="line">                                             forAxis:<span class="built_in">UILayoutConstraintAxisHorizontal</span>];</span><br><span class="line">    </span><br><span class="line">    [<span class="keyword">self</span>.rightLabel setContentHuggingPriority:<span class="built_in">UILayoutPriorityRequired</span></span><br><span class="line">                               forAxis:<span class="built_in">UILayoutConstraintAxisHorizontal</span>];</span><br><span class="line">    [<span class="keyword">self</span>.rightLabel setContentCompressionResistancePriority:<span class="built_in">UILayoutPriorityRequired</span></span><br><span class="line">                                             forAxis:<span class="built_in">UILayoutConstraintAxisHorizontal</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>######case 2: 四个<code>ImageView</code>整体居中，可以任意显示、隐藏。</li>
</ul>
<p><img src="http://upload-images.jianshu.io/upload_images/5835116-1334685bb89094f9.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="blog_autolayout_example_with_masonry_3.png"></p>
<p>下面的四个<code>Switch</code>控件分别控制上面对应位置的图片是否显示。</p>
<blockquote>
<p>分析:首先就是整体居中，为了实现这个，最简单的办法就是将四个图片“装进”一个<strong>容器View</strong>里面，然后让这个容器<code>View</code>在整个页面中居中即可。这样就不用控制每个图片的居中效果了。<br>然后就是显示与隐藏。在这里我直接控制图片<code>ImageView</code>的宽度，宽度为0的时候不就“隐藏”了吗。</p>
</blockquote>
<p>具体代码如下：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)layoutPageSubViews &#123;</span><br><span class="line">    </span><br><span class="line">    [<span class="keyword">self</span>.containerView mas_makeConstraints:^(MASConstraintMaker *make) &#123;</span><br><span class="line">        make.height.mas_equalTo(IMAGE_SIZE);</span><br><span class="line">        make.centerX.equalTo(<span class="keyword">self</span>.view.mas_centerX);</span><br><span class="line">        make.top.equalTo(<span class="keyword">self</span>.view.mas_top).offset(<span class="number">200</span>);</span><br><span class="line">    &#125;];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//分别设置每个imageView的宽高、左边、垂直中心约束，注意约束的对象</span></span><br><span class="line">    <span class="comment">//每个View的左边约束和左边的View的右边相等</span></span><br><span class="line">    __block <span class="built_in">UIView</span> *lastView = <span class="literal">nil</span>;</span><br><span class="line">    __block MASConstraint *widthConstraint = <span class="literal">nil</span>;</span><br><span class="line">    <span class="built_in">NSUInteger</span> arrayCount = <span class="keyword">self</span>.imageViews.count;</span><br><span class="line">    [<span class="keyword">self</span>.imageViews enumerateObjectsUsingBlock:^(<span class="built_in">UIView</span> *view, <span class="built_in">NSUInteger</span> idx, <span class="built_in">BOOL</span> *stop) &#123;</span><br><span class="line">        [view mas_makeConstraints:^(MASConstraintMaker *make) &#123;</span><br><span class="line">            make.left.equalTo(lastView ? lastView.mas_right : view.superview.mas_left);</span><br><span class="line">            make.centerY.equalTo(view.superview.mas_centerY);</span><br><span class="line">            <span class="keyword">if</span> (idx == arrayCount - <span class="number">1</span>) &#123;</span><br><span class="line">                make.right.equalTo(view.superview.mas_right);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            widthConstraint = make.width.mas_equalTo(IMAGE_SIZE);</span><br><span class="line">            make.height.mas_equalTo(IMAGE_SIZE);</span><br><span class="line">            </span><br><span class="line">            [<span class="keyword">self</span>.widthConstraints addObject:widthConstraint];</span><br><span class="line">            lastView = view;</span><br><span class="line">        &#125;];</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> mark - event response</span></span><br><span class="line"><span class="comment">//点击switch按钮，如果打开，对应视图的宽约束设置为32，否则，设置为0</span></span><br><span class="line">- (<span class="keyword">IBAction</span>)showOrHideImage:(<span class="built_in">UISwitch</span> *)sender &#123;</span><br><span class="line">    <span class="built_in">NSUInteger</span> index = (<span class="built_in">NSUInteger</span>) sender.tag;</span><br><span class="line">    MASConstraint *width = <span class="keyword">self</span>.widthConstraints[index];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (sender.on) &#123;</span><br><span class="line">        width.mas_equalTo(IMAGE_SIZE);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        width.mas_equalTo(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>#####case 3: 子视图的宽度始终是父视图的四分之三（或者任意百分比）<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">  <span class="comment">//宽度为父view的宽度的四分之三 </span></span><br><span class="line">[subView mas_makeConstraints:^(MASConstraintMaker *make) &#123;</span><br><span class="line">        <span class="comment">//上下左贴边</span></span><br><span class="line">        make.left.equalTo(_containerView.mas_left);</span><br><span class="line">        make.top.equalTo(_containerView.mas_top);</span><br><span class="line">        make.bottom.equalTo(_containerView.mas_bottom);</span><br><span class="line">        <span class="comment">//宽度为父view的宽度的一半</span></span><br><span class="line">        make.width.equalTo(_containerView.mas_width).multipliedBy(<span class="number">0.75</span>);</span><br><span class="line">    &#125;];</span><br></pre></td></tr></table></figure></li>
<li>#####case 4 给同一个属性添加多重约束，实现复杂关系</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)layoutPageSubviews &#123;</span><br><span class="line">    </span><br><span class="line">    [<span class="keyword">self</span>.greenLabel mas_makeConstraints:^(MASConstraintMaker *make) &#123;</span><br><span class="line">        make.centerY.equalTo(<span class="keyword">self</span>.containerView);</span><br><span class="line">        make.right.lessThanOrEqualTo(<span class="keyword">self</span>.containerView);</span><br><span class="line">        make.left.greaterThanOrEqualTo(<span class="keyword">self</span>.containerView.mas_right).multipliedBy((<span class="built_in">CGFloat</span>)(<span class="number">1.0</span>f / <span class="number">3.0</span>f));</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">UILabel</span> *label <span class="keyword">in</span> <span class="keyword">self</span>.leftLabels) &#123;</span><br><span class="line">            make.left.greaterThanOrEqualTo(label.mas_right).offset(<span class="number">8</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;];</span><br><span class="line">    </span><br><span class="line">    [<span class="keyword">self</span>.greenLabel setContentCompressionResistancePriority:<span class="built_in">UILayoutPriorityRequired</span> forAxis:<span class="built_in">UILayoutConstraintAxisHorizontal</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h5><p>通过上述分析，我们可以发现：</p>
<ul>
<li><code>AutoLayout</code>的原理就是对线性方程组或者不等式的求解，最终使用<code>frame</code>来绘制视图；</li>
<li>使用<code>AutoLayout</code>进行布局时， 由于其实现原理导致其时间复杂度为多项式时间，其性能损耗是仅使用 frame 的十几倍，所以在处理庞大的 UI界面时表现差强人意。</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://levertsui.github.io/2017/11/03/qr-droid/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="leverTsui">
      <meta itemprop="description" content="要有狮子的力量， 菩萨的心肠">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="leverTsui">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/11/03/qr-droid/" class="post-title-link" itemprop="url">iOS二维码识别/二维码生成</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2017-11-03 20:42:00" itemprop="dateCreated datePublished" datetime="2017-11-03T20:42:00+08:00">2017-11-03</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-02-08 09:46:16" itemprop="dateModified" datetime="2022-02-08T09:46:16+08:00">2022-02-08</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/iOS-%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">iOS 开发</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h4><p>之前做过一个关于二维码的组件，已发布，现总结下。<br>开发的<code>APP</code>所需支持的最低版本为<code>8.0</code>，最初的方案为扫描使用苹果自带的<code>API</code>实现扫一扫的功能、使用<code>ZXing</code>识别从相册或别人转发的二维码图片。但发现<code>ZXing</code>识别从相册中来的图片性能很差，很多图片识别不了，且耗时较长，遂使用<code>ZBar</code>来实现识别从相册或别人转发的二维码图片。<br>这个组件重要实现了三个功能，扫一扫识别二维码图片、长按图片识别二维码图片和生成二维码图片。<br>首先来看下扫一扫识别二维码图片的代码实现：</p>
<h4 id="功能实现"><a href="#功能实现" class="headerlink" title="功能实现"></a>功能实现</h4><h5 id="扫一扫识别二维码图片"><a href="#扫一扫识别二维码图片" class="headerlink" title="扫一扫识别二维码图片"></a>扫一扫识别二维码图片</h5><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)initCapture &#123;</span><br><span class="line">    <span class="built_in">AVCaptureDevice</span>* inputDevice =</span><br><span class="line">    [<span class="built_in">AVCaptureDevice</span> defaultDeviceWithMediaType:<span class="built_in">AVMediaTypeVideo</span>]; </span><br><span class="line">    [inputDevice lockForConfiguration:<span class="literal">nil</span>];</span><br><span class="line">    <span class="keyword">if</span> ([inputDevice hasTorch])&#123;</span><br><span class="line">        inputDevice.torchMode = <span class="built_in">AVCaptureTorchModeAuto</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">AVCaptureFocusMode</span> foucusMode = <span class="built_in">AVCaptureFocusModeContinuousAutoFocus</span>;</span><br><span class="line">    <span class="keyword">if</span> ([inputDevice isFocusModeSupported:foucusMode]) &#123;</span><br><span class="line">        inputDevice.focusMode = foucusMode;</span><br><span class="line">    &#125;</span><br><span class="line">    [inputDevice unlockForConfiguration];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">AVCaptureDeviceInput</span> *captureInput =</span><br><span class="line">    [<span class="built_in">AVCaptureDeviceInput</span> deviceInputWithDevice:inputDevice error:<span class="literal">nil</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!captureInput) &#123;</span><br><span class="line">        <span class="comment">//支持的最低版本为iOS8</span></span><br><span class="line">        <span class="built_in">UIAlertController</span> *alterVC = [<span class="built_in">UIAlertController</span> alertControllerWithTitle:MUIQRCodeLocalizedString(<span class="string">@&quot;ScanViewController_system_tip&quot;</span>) message:MUIQRCodeLocalizedString(<span class="string">@&quot;ScanViewController_camera_permission&quot;</span>) preferredStyle:<span class="built_in">UIAlertControllerStyleAlert</span>];</span><br><span class="line">        <span class="built_in">UIAlertAction</span> *confirmAction = [<span class="built_in">UIAlertAction</span> actionWithTitle:MUIQRCodeLocalizedString(<span class="string">@&quot;ScanViewController_yes&quot;</span>) style:<span class="built_in">UIAlertActionStyleDefault</span> handler:<span class="literal">nil</span>];</span><br><span class="line">        [alterVC addAction:confirmAction];</span><br><span class="line">        [<span class="keyword">self</span> presentViewController:alterVC animated:<span class="literal">YES</span> completion:<span class="literal">nil</span>];</span><br><span class="line">        [<span class="keyword">self</span>.activityView stopAnimating];</span><br><span class="line">        [<span class="keyword">self</span> onVideoStart:<span class="literal">nil</span>];</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">AVCaptureMetadataOutput</span> *captureOutput = [[<span class="built_in">AVCaptureMetadataOutput</span> alloc] init];</span><br><span class="line">    [captureOutput setMetadataObjectsDelegate:<span class="keyword">self</span> queue:_queue];</span><br><span class="line">    <span class="keyword">self</span>.captureOutput = captureOutput;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">self</span>.captureSession = [[<span class="built_in">AVCaptureSession</span> alloc] init];</span><br><span class="line">    [<span class="keyword">self</span>.captureSession addInput:captureInput];</span><br><span class="line">    [<span class="keyword">self</span>.captureSession addOutput:captureOutput];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">CGFloat</span> w = <span class="number">1920.</span>f;</span><br><span class="line">    <span class="built_in">CGFloat</span> h = <span class="number">1080.</span>f;</span><br><span class="line">    <span class="keyword">if</span> ([<span class="keyword">self</span>.captureSession canSetSessionPreset:<span class="built_in">AVCaptureSessionPreset1920x1080</span>]) &#123;</span><br><span class="line">        <span class="keyword">self</span>.captureSession.sessionPreset = <span class="built_in">AVCaptureSessionPreset1920x1080</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([<span class="keyword">self</span>.captureSession canSetSessionPreset:<span class="built_in">AVCaptureSessionPreset1280x720</span>]) &#123;</span><br><span class="line">        <span class="keyword">self</span>.captureSession.sessionPreset = <span class="built_in">AVCaptureSessionPreset1280x720</span>;</span><br><span class="line">        w = <span class="number">1280.</span>f;</span><br><span class="line">        h = <span class="number">720.</span>f;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([<span class="keyword">self</span>.captureSession canSetSessionPreset:<span class="built_in">AVCaptureSessionPreset640x480</span>]) &#123;</span><br><span class="line">        <span class="keyword">self</span>.captureSession.sessionPreset = <span class="built_in">AVCaptureSessionPreset640x480</span>;</span><br><span class="line">        w = <span class="number">960.</span>f;</span><br><span class="line">        h = <span class="number">540.</span>f;</span><br><span class="line">    &#125;</span><br><span class="line">    captureOutput.metadataObjectTypes = [captureOutput availableMetadataObjectTypes];</span><br><span class="line">    <span class="built_in">CGRect</span> bounds = [[<span class="built_in">UIScreen</span> mainScreen] bounds];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">self</span>.prevLayer) &#123;</span><br><span class="line">        <span class="keyword">self</span>.prevLayer = [<span class="built_in">AVCaptureVideoPreviewLayer</span> layerWithSession:<span class="keyword">self</span>.captureSession];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">self</span>.prevLayer.frame = bounds;</span><br><span class="line">    <span class="keyword">self</span>.prevLayer.videoGravity = <span class="built_in">AVLayerVideoGravityResizeAspectFill</span>;</span><br><span class="line">    [<span class="keyword">self</span>.view.layer insertSublayer:<span class="keyword">self</span>.prevLayer atIndex:<span class="number">0</span>];</span><br><span class="line">    <span class="comment">//下面代码主要用来设置扫描的聚焦范围，计算rectOfInterest</span></span><br><span class="line">    <span class="built_in">CGFloat</span> p1 = bounds.size.height/bounds.size.width;</span><br><span class="line">    <span class="built_in">CGFloat</span> p2 = w/h;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">CGRect</span> cropRect = <span class="built_in">CGRectMake</span>(<span class="built_in">CGRectGetMinX</span>(_cropRect) - kSNReaderScanExpandWidth, <span class="built_in">CGRectGetMinY</span>(_cropRect) - kSNReaderScanExpandHeight, <span class="built_in">CGRectGetWidth</span>(_cropRect) + <span class="number">2</span>*kSNReaderScanExpandWidth, <span class="built_in">CGRectGetHeight</span>(_cropRect) + <span class="number">2</span>*kSNReaderScanExpandHeight);</span><br><span class="line">    </span><br><span class="line"><span class="comment">//    CGRect cropRect = _cropRect;</span></span><br><span class="line">    <span class="keyword">if</span> (fabs(p1 - p2) &lt; <span class="number">0.00001</span>) &#123;</span><br><span class="line">        captureOutput.rectOfInterest = <span class="built_in">CGRectMake</span>(cropRect.origin.y /bounds.size.height,                         cropRect.origin.x/bounds.size.width,</span><br><span class="line">                                                  cropRect.size.height/bounds.size.height,</span><br><span class="line">                                                  cropRect.size.width/bounds.size.width);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (p1 &lt; p2) &#123;</span><br><span class="line">        <span class="comment">//实际图像被截取一段高</span></span><br><span class="line">        <span class="built_in">CGFloat</span> fixHeight = bounds.size.width * w / h;</span><br><span class="line">        <span class="built_in">CGFloat</span> fixPadding = (fixHeight - bounds.size.height)/<span class="number">2</span>;</span><br><span class="line">        captureOutput.rectOfInterest = <span class="built_in">CGRectMake</span>((cropRect.origin.y + fixPadding)/fixHeight,</span><br><span class="line">                                                  cropRect.origin.x/bounds.size.width,</span><br><span class="line">                                                  cropRect.size.height/fixHeight,</span><br><span class="line">                                                  cropRect.size.width/bounds.size.width);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">CGFloat</span> fixWidth = bounds.size.height * h / w;</span><br><span class="line">        <span class="built_in">CGFloat</span> fixPadding = (fixWidth - bounds.size.width)/<span class="number">2</span>;</span><br><span class="line">        captureOutput.rectOfInterest = <span class="built_in">CGRectMake</span>(cropRect.origin.y/bounds.size.height,</span><br><span class="line">                                                  (cropRect.origin.x + fixPadding)/fixWidth,</span><br><span class="line">                                                  cropRect.size.height/bounds.size.height,</span><br><span class="line">                                                  cropRect.size.width/fixWidth);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="识别二维码图片"><a href="#识别二维码图片" class="headerlink" title="识别二维码图片"></a>识别二维码图片</h5><p>识别二维码图片的功能，最初的方案是使用三方库<code>ZXing</code>来实现，因为<code>ZXing</code>有人在维护，但<code>ZXing</code>识别相册中的二维码图片或本地的图片时，有些图片根本就识别不出来，且耗时较长，所以改为使用<code>ZBar</code>。在网上找到一篇文章<a target="_blank" rel="noopener" href="http://adad184.com/2015/09/30/goodbye-zxing/">再见ZXing 使用系统原生代码处理QRCode</a>,实测发现使用系统原生代码来识别二维码图片时，在，iphone4s，系统为iOS9的手机发现传回来的数组为空。代码如下：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">NSString</span> *)decodeQRImageWith:(<span class="built_in">UIImage</span>*)aImage &#123;</span><br><span class="line">    <span class="built_in">NSString</span> *qrResult = <span class="literal">nil</span>; </span><br><span class="line">    <span class="comment">//iOS8及以上可以使用系统自带的识别二维码图片接口，但此api有问题，在一些机型上detector为nil。 </span></span><br><span class="line">    <span class="keyword">if</span> (iOS8_OR_LATER) &#123; </span><br><span class="line">          <span class="built_in">CIContext</span> *context = [<span class="built_in">CIContext</span> contextWithOptions:<span class="literal">nil</span>];</span><br><span class="line">          <span class="built_in">CIDetector</span> *detector = [<span class="built_in">CIDetector</span> detectorOfType:<span class="built_in">CIDetectorTypeQRCode</span> context:context options:@&#123;<span class="built_in">CIDetectorAccuracy</span>:<span class="built_in">CIDetectorAccuracyHigh</span>&#125;];</span><br><span class="line">          <span class="built_in">CIImage</span> *image = [<span class="built_in">CIImage</span> imageWithCGImage:aImage.CGImage];</span><br><span class="line">          <span class="built_in">NSArray</span> *features = [detector featuresInImage:image];</span><br><span class="line">          <span class="built_in">CIQRCodeFeature</span> *feature = [features firstObject]; </span><br><span class="line">          qrResult = feature.messageString;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          ZBarReaderController* read = [ZBarReaderController new];</span><br><span class="line">          <span class="built_in">CGImageRef</span> cgImageRef = aImage.CGImage;</span><br><span class="line">          ZBarSymbol* symbol = <span class="literal">nil</span>;</span><br><span class="line">          <span class="keyword">for</span>(symbol <span class="keyword">in</span> [read scanImage:cgImageRef]) <span class="keyword">break</span>;</span><br><span class="line">             qrResult = symbol.data ;</span><br><span class="line">            <span class="keyword">return</span> qrResult;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>无图无真相：</p>
<p><img src="http://upload-images.jianshu.io/upload_images/117999-5dae9fc15755140c.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="14567CBE-E1D2-4FA7-AFA3-8B2037171F38.jpg"> </p>
<p>detector的值为nil，也就是说 </p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">CIDetector</span> *detector = [<span class="built_in">CIDetector</span> detectorOfType:<span class="built_in">CIDetectorTypeQRCode</span> context:context options:@&#123;<span class="built_in">CIDetectorAccuracy</span>:<span class="built_in">CIDetectorAccuracyHigh</span>&#125;];</span><br></pre></td></tr></table></figure>
<p>CIDetector的初始化方法无效。推测是苹果API的问题。 </p>
<h5 id="生成二维码图片"><a href="#生成二维码图片" class="headerlink" title="生成二维码图片"></a>生成二维码图片</h5><p>在<code>iOS8</code>及以上版本使用苹果的<code>API</code>生成二维码图片，代码如下：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">UIImage</span> *)encodeQRImageWithContent:(<span class="built_in">NSString</span> *)content size:(<span class="built_in">CGSize</span>)size &#123;</span><br><span class="line">    <span class="built_in">UIImage</span> *codeImage = <span class="literal">nil</span>;</span><br><span class="line">    <span class="keyword">if</span> (iOS8_OR_LATER) &#123;</span><br><span class="line">        <span class="built_in">NSData</span> *stringData = [content dataUsingEncoding: <span class="built_in">NSUTF8StringEncoding</span>]; </span><br><span class="line">        <span class="comment">//生成</span></span><br><span class="line">      <span class="built_in">CIFilter</span> *qrFilter = [<span class="built_in">CIFilter</span> filterWithName:<span class="string">@&quot;CIQRCodeGenerator&quot;</span>];</span><br><span class="line">      [qrFilter setValue:stringData forKey:<span class="string">@&quot;inputMessage&quot;</span>];</span><br><span class="line">      [qrFilter setValue:<span class="string">@&quot;M&quot;</span> forKey:<span class="string">@&quot;inputCorrectionLevel&quot;</span>];</span><br><span class="line">      <span class="built_in">UIColor</span> *onColor = [<span class="built_in">UIColor</span> blackColor];</span><br><span class="line">      <span class="built_in">UIColor</span> *offColor = [<span class="built_in">UIColor</span> whiteColor];</span><br><span class="line">      <span class="comment">//上色</span></span><br><span class="line">      <span class="built_in">CIFilter</span> *colorFilter = [<span class="built_in">CIFilter</span> filterWithName:<span class="string">@&quot;CIFalseColor&quot;</span></span><br><span class="line">                                         keysAndValues:</span><br><span class="line">                               <span class="string">@&quot;inputImage&quot;</span>,qrFilter.outputImage,</span><br><span class="line">                               <span class="string">@&quot;inputColor0&quot;</span>,[<span class="built_in">CIColor</span> colorWithCGColor:onColor.CGColor],</span><br><span class="line">                               <span class="string">@&quot;inputColor1&quot;</span>,[<span class="built_in">CIColor</span> colorWithCGColor:offColor.CGColor],</span><br><span class="line">                               <span class="literal">nil</span>];</span><br><span class="line"></span><br><span class="line">      <span class="built_in">CIImage</span> *qrImage = colorFilter.outputImage;</span><br><span class="line">      <span class="built_in">CGImageRef</span> cgImage = [[<span class="built_in">CIContext</span> contextWithOptions:<span class="literal">nil</span>] createCGImage:qrImage fromRect:qrImage.extent];</span><br><span class="line">      <span class="built_in">UIGraphicsBeginImageContext</span>(size);</span><br><span class="line">      <span class="built_in">CGContextRef</span> context = <span class="built_in">UIGraphicsGetCurrentContext</span>();</span><br><span class="line">      <span class="built_in">CGContextSetInterpolationQuality</span>(context, kCGInterpolationNone);</span><br><span class="line">      <span class="built_in">CGContextScaleCTM</span>(context, <span class="number">1.0</span>, <span class="number">-1.0</span>);</span><br><span class="line">      <span class="built_in">CGContextDrawImage</span>(context, <span class="built_in">CGContextGetClipBoundingBox</span>(context), cgImage);</span><br><span class="line">      codeImage = <span class="built_in">UIGraphicsGetImageFromCurrentImageContext</span>();</span><br><span class="line">      <span class="built_in">UIGraphicsEndImageContext</span>(); </span><br><span class="line">      <span class="built_in">CGImageRelease</span>(cgImage);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          codeImage = [QRCodeGenerator qrImageForString:content imageSize:size.width];</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> codeImage;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p><code>iOS8</code>以下使用<code>libqrencode</code>库来生成二维码图片。</p>
<h4 id="代码完善"><a href="#代码完善" class="headerlink" title="代码完善"></a>代码完善</h4><p><code>2015年12月11日</code> </p>
<p><code>QA</code>测试发现，服务端生成的二维码，使用<code>ZBar</code>识别不出来，但将这张图片保存到相册，然后发送就可以识别出来。最初的想法是要服务端修改生成的二维码，但安卓能够识别出来，此路不通，那只有看ZBar的源码了。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">id</span> &lt;<span class="built_in">NSFastEnumeration</span>&gt;) scanImage: (<span class="built_in">CGImageRef</span>) image &#123;</span><br><span class="line">        timer_start;</span><br><span class="line">        <span class="keyword">int</span> nsyms = [<span class="keyword">self</span> scanImage: image</span><br><span class="line">                          withScaling: <span class="number">0</span>];</span><br><span class="line">      <span class="comment">//没有识别出来，判断CGImageRef对象的宽和高是否大于640，大于或等于的话进行缩放再进行扫描</span></span><br><span class="line">        <span class="keyword">if</span>(!nsyms &amp;&amp;</span><br><span class="line">           <span class="built_in">CGImageGetWidth</span>(image) &gt;= <span class="number">640</span> &amp;&amp;</span><br><span class="line">           <span class="built_in">CGImageGetHeight</span>(image) &gt;= <span class="number">640</span>)</span><br><span class="line">            <span class="comment">// make one more attempt for close up, grainy images</span></span><br><span class="line">            nsyms = [<span class="keyword">self</span> scanImage: image</span><br><span class="line">                          withScaling: <span class="number">.5</span>];</span><br><span class="line"></span><br><span class="line">        <span class="built_in">NSMutableArray</span> *syms = <span class="literal">nil</span>;</span><br><span class="line">        <span class="keyword">if</span>(nsyms) &#123;</span><br><span class="line">            <span class="comment">// quality/type filtering</span></span><br><span class="line">            <span class="keyword">int</span> max_quality = MIN_QUALITY;</span><br><span class="line">            <span class="keyword">for</span>(ZBarSymbol *sym <span class="keyword">in</span> scanner.results) &#123;</span><br><span class="line">                zbar_symbol_type_t type = sym.type;</span><br><span class="line">                <span class="keyword">int</span> quality;</span><br><span class="line">                <span class="keyword">if</span>(type == ZBAR_QRCODE)</span><br><span class="line">                    quality = INT_MAX;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    quality = sym.quality;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span>(quality &lt; max_quality) &#123;</span><br><span class="line">                    zlog(<span class="string">@&quot;    type=%d quality=%d &lt; %d\n&quot;</span>,</span><br><span class="line">                         type, quality, max_quality);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span>(max_quality &lt; quality) &#123;</span><br><span class="line">                    max_quality = quality;</span><br><span class="line">                    <span class="keyword">if</span>(syms)</span><br><span class="line">                        [syms removeAllObjects];</span><br><span class="line">                &#125;</span><br><span class="line">                zlog(<span class="string">@&quot;    type=%d quality=%d\n&quot;</span>, type, quality);</span><br><span class="line">                <span class="keyword">if</span>(!syms)</span><br><span class="line">                    syms = [<span class="built_in">NSMutableArray</span> arrayWithCapacity: <span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">                [syms addObject: sym];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        zlog(<span class="string">@&quot;read %d filtered symbols in %gs total\n&quot;</span>,</span><br><span class="line">              (!syms) ? <span class="number">0</span> : [syms count], timer_elapsed(t_start, timer_now()));</span><br><span class="line">        <span class="keyword">return</span>(syms);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span>(max_quality &lt; quality) &#123;</span><br><span class="line">          max_quality = quality;</span><br><span class="line">          <span class="keyword">if</span>(syms)</span><br><span class="line">              [syms removeAllObjects];</span><br><span class="line">      &#125;</span><br><span class="line">      zlog(<span class="string">@&quot;    type=%d quality=%d\n&quot;</span>, type, quality);</span><br><span class="line">      <span class="keyword">if</span>(!syms)</span><br><span class="line">          syms = [<span class="built_in">NSMutableArray</span> arrayWithCapacity: <span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">      [syms addObject: sym];</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  zlog(<span class="string">@&quot;read %d filtered symbols in %gs total\n&quot;</span>,</span><br><span class="line">        (!syms) ? <span class="number">0</span> : [syms count], timer_elapsed(t_start, timer_now()));</span><br><span class="line">  <span class="keyword">return</span>(syms);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在这里就产生了一个解决有些二维码图片识别不出来的解决思路：将传过来的<code>UIImage</code>的宽和高设置为640，识别不出来再进行缩放识别。修改<code>UIImage</code>的代码如下：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">-(<span class="built_in">UIImage</span> *)TransformtoSize:(<span class="built_in">CGSize</span>)Newsize &#123;</span><br><span class="line">    <span class="comment">// 创建一个bitmap的context</span></span><br><span class="line">    <span class="built_in">UIGraphicsBeginImageContext</span>(Newsize);</span><br><span class="line">    <span class="comment">// 绘制改变大小的图片</span></span><br><span class="line">    [<span class="keyword">self</span> drawInRect:<span class="built_in">CGRectMake</span>(<span class="number">0</span>, <span class="number">0</span>, Newsize.width, Newsize.height)];</span><br><span class="line">    <span class="comment">// 从当前context中创建一个改变大小后的图片</span></span><br><span class="line">    <span class="built_in">UIImage</span> *TransformedImg=<span class="built_in">UIGraphicsGetImageFromCurrentImageContext</span>();</span><br><span class="line">    <span class="comment">// 使当前的context出堆栈</span></span><br><span class="line">    <span class="built_in">UIGraphicsEndImageContext</span>();</span><br><span class="line">    <span class="comment">// 返回新的改变大小后的图片</span></span><br><span class="line">    <span class="keyword">return</span> TransformedImg;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样类似于将<code>ZXing</code>中的<code>tryHard</code>设置为<code>YES</code>。识别不出来的二维码图片就可以识别了。</p>
<p><code>2016年5月20日</code><br><code>遗留的bug</code>: 点击进入扫一扫界面，退出，再进入，这样重复5次左右，扫一扫之前的界面的会出现卡顿。<br>原因：多次进入扫一扫界面，再退出，因此界面未被系统回收，captureSession对象一直在运行，会造成内存泄露，引起上一个界面卡顿。<br>解决方案：在视图将要消失的时候，确保captureSession对象停止运行。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)viewWillDisappear:(<span class="built_in">BOOL</span>)animated &#123;</span><br><span class="line">  [<span class="keyword">super</span> viewWillDisappear:animated];</span><br><span class="line">  <span class="keyword">if</span> ([<span class="keyword">self</span>.captureSession isRunning]) &#123;</span><br><span class="line">      [<span class="keyword">self</span>.captureSession stopRunning];</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>2018年4月28日</code><br>识别二维码图片优化</p>
<p>近期通过<code>bugly</code>收集卡顿问题发现，二维码组件在识别二维码图片时，会出现卡顿问题。为优化识别速度，采用了三种方案，并分别进行测试，并对测试数据进行分析，最终挑选出最优的方案。</p>
<blockquote>
<p>任务A：使用系统提供的CoreImage的CIDetector接口去识别二维码图片，返回对应的字符串；<br>任务B：使用zbar中的方法去识别二维码图片，返回对应的字符串。</p>
</blockquote>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//任务A</span></span><br><span class="line">+ (<span class="built_in">NSString</span> *)useSystemMethodDecodeImage:(<span class="built_in">UIImage</span> *)image &#123;</span><br><span class="line">    <span class="built_in">NSString</span> *resultString = <span class="literal">nil</span>;</span><br><span class="line">    <span class="built_in">CIDetector</span> *detector = [<span class="built_in">CIDetector</span> detectorOfType:<span class="built_in">CIDetectorTypeQRCode</span></span><br><span class="line">                                              context:<span class="literal">nil</span></span><br><span class="line">                                              options:@&#123;<span class="built_in">CIDetectorAccuracy</span>:<span class="built_in">CIDetectorAccuracyHigh</span>&#125;];</span><br><span class="line">    <span class="keyword">if</span> (detector) &#123;</span><br><span class="line">        <span class="built_in">CIImage</span> *ciImage = [<span class="built_in">CIImage</span> imageWithCGImage:image.CGImage];</span><br><span class="line">        <span class="built_in">NSArray</span> *features = [detector featuresInImage:ciImage];</span><br><span class="line">        <span class="built_in">CIQRCodeFeature</span> *feature = [features firstObject];</span><br><span class="line">        resultString = feature.messageString;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> resultString;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//任务B</span></span><br><span class="line">+ (<span class="built_in">NSString</span> *)useZbarMethodDecodeImage:(<span class="built_in">UIImage</span> *)image &#123;</span><br><span class="line">    <span class="built_in">UIImage</span> *decodeImage = image;</span><br><span class="line">    <span class="keyword">if</span> (decodeImage.size.width &lt; <span class="number">641</span>) &#123;</span><br><span class="line">        decodeImage = [decodeImage TransformtoSize:<span class="built_in">CGSizeMake</span>(<span class="number">640</span>, <span class="number">640</span>)];</span><br><span class="line">    &#125;</span><br><span class="line">    QRCodeZBarReaderController* read = [QRCodeZBarReaderController new];</span><br><span class="line">    <span class="built_in">CGImageRef</span> cgImageRef = decodeImage.CGImage;</span><br><span class="line">    QRCodeZBarSymbol *symbol = <span class="literal">nil</span>;</span><br><span class="line">    <span class="keyword">for</span>(symbol <span class="keyword">in</span> [read scanImage:cgImageRef]) <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">return</span> symbol.data;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>方案A：先执行任务A，如果获取到的字符串为空，再执行任务B。</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="built_in">NSString</span> *)planOneDecodeWithImage:(<span class="built_in">UIImage</span> *)image index:(<span class="built_in">NSInteger</span>)index&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="built_in">NSMutableString</span> *costTimeInfo = [<span class="built_in">NSMutableString</span> stringWithFormat:<span class="string">@&quot;%ld\r\n&quot;</span>,index];</span><br><span class="line">    <span class="built_in">CFAbsoluteTime</span> startTime = <span class="built_in">CFAbsoluteTimeGetCurrent</span>();</span><br><span class="line">    <span class="built_in">NSString</span> *detectorString = [MUIQRCodeDecoder useSystemMethodDecodeImage:image];</span><br><span class="line">    <span class="built_in">CFAbsoluteTime</span> detectorCostTime = (<span class="built_in">CFAbsoluteTimeGetCurrent</span>() - startTime);</span><br><span class="line">    </span><br><span class="line">    [costTimeInfo appendString:[<span class="built_in">NSString</span> stringWithFormat:<span class="string">@&quot;detector : %f ms\r\n&quot;</span>,detectorCostTime *<span class="number">1000.0</span>]];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSAssert</span>(detectorString.length &gt; <span class="number">0</span>, <span class="string">@&quot;detector fail!&quot;</span>);</span><br><span class="line">    <span class="built_in">CFAbsoluteTime</span> zbarStartTime = <span class="built_in">CFAbsoluteTimeGetCurrent</span>();</span><br><span class="line">    <span class="built_in">NSString</span> *zbarSymbolString = [MUIQRCodeDecoder useZbarMethodDecodeImage:image];</span><br><span class="line">    <span class="built_in">NSAssert</span>(zbarSymbolString.length &gt; <span class="number">0</span>, <span class="string">@&quot;zbar fail!&quot;</span>);</span><br><span class="line">    <span class="built_in">CFAbsoluteTime</span> zbarCostTime = (<span class="built_in">CFAbsoluteTimeGetCurrent</span>() - zbarStartTime);</span><br><span class="line">    </span><br><span class="line">    [costTimeInfo appendString:[<span class="built_in">NSString</span> stringWithFormat:<span class="string">@&quot;zbar : %f ms\r\n&quot;</span>,zbarCostTime *<span class="number">1000.0</span>]];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">CFAbsoluteTime</span> totalCostTime = (<span class="built_in">CFAbsoluteTimeGetCurrent</span>() - startTime);</span><br><span class="line">    </span><br><span class="line">    [costTimeInfo appendString:[<span class="built_in">NSString</span> stringWithFormat:<span class="string">@&quot;total cost : %f ms\r\n&quot;</span>,totalCostTime *<span class="number">1000.0</span>]];</span><br><span class="line">    [costTimeInfo appendString:[<span class="built_in">NSString</span> stringWithFormat:<span class="string">@&quot;detectorString : %@ ms\r\n&quot;</span>,detectorString]];</span><br><span class="line">    [costTimeInfo appendString:[<span class="built_in">NSString</span> stringWithFormat:<span class="string">@&quot;zbarSymbolString : %@ ms\r\n&quot;</span>,zbarSymbolString]];</span><br><span class="line">    <span class="keyword">return</span> [costTimeInfo <span class="keyword">copy</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>方案B：同时执行任务A和任务B，两者均执行完后，返回识别的结果；</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="built_in">NSString</span> *)planTwoDecodeWithImage:(<span class="built_in">UIImage</span> *)image index:(<span class="built_in">NSInteger</span>)index &#123; </span><br><span class="line">    __block <span class="built_in">NSMutableString</span> *costTimeInfo = [<span class="built_in">NSMutableString</span> stringWithFormat:<span class="string">@&quot;%ld\r\n&quot;</span>,index];</span><br><span class="line">    __block <span class="built_in">NSString</span> *detectorString = <span class="literal">nil</span>;</span><br><span class="line">    __block <span class="built_in">NSString</span> *zbarSymbolString = <span class="literal">nil</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">CFAbsoluteTime</span> startTime = <span class="built_in">CFAbsoluteTimeGetCurrent</span>();</span><br><span class="line">    </span><br><span class="line">    dispatch_semaphore_t semaphore = dispatch_semaphore_create(<span class="number">0</span>);</span><br><span class="line">    dispatch_group_t group = dispatch_group_create();</span><br><span class="line">    </span><br><span class="line">    dispatch_group_async(group, dispatch_get_global_queue(<span class="number">0</span>,<span class="number">0</span>), ^&#123;</span><br><span class="line">        detectorString = [MUIQRCodeDecoder useSystemMethodDecodeImage:image];</span><br><span class="line">        <span class="built_in">NSAssert</span>(detectorString.length &gt; <span class="number">0</span>, <span class="string">@&quot;detector fail!&quot;</span>);</span><br><span class="line">        <span class="built_in">CFAbsoluteTime</span> costTime = (<span class="built_in">CFAbsoluteTimeGetCurrent</span>() - startTime);</span><br><span class="line">        [costTimeInfo appendString:[<span class="built_in">NSString</span> stringWithFormat:<span class="string">@&quot;detector : %f ms\r\n&quot;</span>,costTime *<span class="number">1000.0</span>]];</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    dispatch_group_async(group, dispatch_get_global_queue(<span class="number">0</span>,<span class="number">0</span>), ^&#123;</span><br><span class="line">        zbarSymbolString = [MUIQRCodeDecoder useZbarMethodDecodeImage:image];</span><br><span class="line">        <span class="built_in">NSAssert</span>(zbarSymbolString.length &gt; <span class="number">0</span>, <span class="string">@&quot;zbar fail!&quot;</span>);</span><br><span class="line">        <span class="built_in">CFAbsoluteTime</span> costTime = (<span class="built_in">CFAbsoluteTimeGetCurrent</span>() - startTime);</span><br><span class="line">        [costTimeInfo appendString:[<span class="built_in">NSString</span> stringWithFormat:<span class="string">@&quot;zbar : %f ms\r\n&quot;</span>,costTime *<span class="number">1000.0</span>]];</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    dispatch_group_notify(group, dispatch_get_global_queue(<span class="number">0</span>,<span class="number">0</span>), ^&#123;</span><br><span class="line">        dispatch_semaphore_signal(semaphore);</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    dispatch_semaphore_wait(semaphore, DISPATCH_TIME_FOREVER);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">CFAbsoluteTime</span> totalCostTime = (<span class="built_in">CFAbsoluteTimeGetCurrent</span>() - startTime);</span><br><span class="line">    [costTimeInfo appendString:[<span class="built_in">NSString</span> stringWithFormat:<span class="string">@&quot;total cost : %f ms\r\n&quot;</span>,totalCostTime *<span class="number">1000.0</span>]];</span><br><span class="line">    [costTimeInfo appendString:[<span class="built_in">NSString</span> stringWithFormat:<span class="string">@&quot;detectorString : %@ ms\r\n&quot;</span>,detectorString]];</span><br><span class="line">    [costTimeInfo appendString:[<span class="built_in">NSString</span> stringWithFormat:<span class="string">@&quot;zbarSymbolString : %@ ms\r\n&quot;</span>,zbarSymbolString]];</span><br><span class="line">    <span class="keyword">return</span> [costTimeInfo <span class="keyword">copy</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>方案C：同时执行任务A和任务B<br>1、任务A先执行完且识别成功，返回识别结果；<br>2、任务B先执行完且识别成功，返回识别结果；<br>3、任务A和任务B均识别失败，两者均执行完后，返回识别的结果。</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="built_in">NSString</span> *)planThreeDecodeWithImage:(<span class="built_in">UIImage</span> *)image index:(<span class="built_in">NSInteger</span>)index &#123;</span><br><span class="line">    __block <span class="built_in">NSMutableString</span> *costTimeInfo = [<span class="built_in">NSMutableString</span> stringWithFormat:<span class="string">@&quot;%ld\r\n&quot;</span>,index];</span><br><span class="line">    __block <span class="built_in">NSString</span> *detectorString = <span class="literal">nil</span>;</span><br><span class="line">    __block <span class="built_in">NSString</span> *zbarSymbolString = <span class="literal">nil</span>;</span><br><span class="line">    __block <span class="built_in">BOOL</span> isNeedSendSignal = <span class="literal">YES</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">CFAbsoluteTime</span> startTime = <span class="built_in">CFAbsoluteTimeGetCurrent</span>();</span><br><span class="line">    </span><br><span class="line">    dispatch_semaphore_t semaphore = dispatch_semaphore_create(<span class="number">0</span>);</span><br><span class="line">    dispatch_group_t group = dispatch_group_create();</span><br><span class="line">    </span><br><span class="line">    dispatch_group_async(group, dispatch_get_global_queue(<span class="number">0</span>,<span class="number">0</span>), ^&#123;</span><br><span class="line">        detectorString = [MUIQRCodeDecoder useSystemMethodDecodeImage:image];</span><br><span class="line">        <span class="comment">//NSAssert(detectorString.length &gt; 0, @&quot;detector fail!&quot;);</span></span><br><span class="line">        <span class="built_in">CFAbsoluteTime</span> costTime = (<span class="built_in">CFAbsoluteTimeGetCurrent</span>() - startTime);</span><br><span class="line">        [costTimeInfo appendString:[<span class="built_in">NSString</span> stringWithFormat:<span class="string">@&quot;detector : %f ms\r\n&quot;</span>,costTime *<span class="number">1000.0</span>]];</span><br><span class="line">        <span class="keyword">if</span> (detectorString.length &gt; <span class="number">0</span> &amp;&amp; isNeedSendSignal) &#123;</span><br><span class="line">            isNeedSendSignal = <span class="literal">NO</span>;</span><br><span class="line">            dispatch_semaphore_signal(semaphore);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    dispatch_group_async(group, dispatch_get_global_queue(<span class="number">0</span>,<span class="number">0</span>), ^&#123;</span><br><span class="line">        zbarSymbolString = [MUIQRCodeDecoder useZbarMethodDecodeImage:image];</span><br><span class="line">        <span class="comment">//NSAssert(zbarSymbolString.length &gt; 0, @&quot;zbar fail!&quot;);</span></span><br><span class="line">        <span class="built_in">CFAbsoluteTime</span> costTime = (<span class="built_in">CFAbsoluteTimeGetCurrent</span>() - startTime);</span><br><span class="line">        [costTimeInfo appendString:[<span class="built_in">NSString</span> stringWithFormat:<span class="string">@&quot;zbar : %f ms\r\n&quot;</span>,costTime *<span class="number">1000.0</span>]];</span><br><span class="line">        <span class="keyword">if</span> (zbarSymbolString.length &gt; <span class="number">0</span> &amp;&amp; isNeedSendSignal) &#123;</span><br><span class="line">            isNeedSendSignal = <span class="literal">NO</span>;</span><br><span class="line">            dispatch_semaphore_signal(semaphore);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    dispatch_group_notify(group, dispatch_get_global_queue(<span class="number">0</span>,<span class="number">0</span>), ^&#123;</span><br><span class="line">        <span class="keyword">if</span> (isNeedSendSignal) &#123;</span><br><span class="line">            dispatch_semaphore_signal(semaphore);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    dispatch_semaphore_wait(semaphore, DISPATCH_TIME_FOREVER);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">CFAbsoluteTime</span> totalCostTime = (<span class="built_in">CFAbsoluteTimeGetCurrent</span>() - startTime);</span><br><span class="line">    [costTimeInfo appendString:[<span class="built_in">NSString</span> stringWithFormat:<span class="string">@&quot;total cost : %f ms\r\n&quot;</span>,totalCostTime *<span class="number">1000.0</span>]];</span><br><span class="line">    [costTimeInfo appendString:[<span class="built_in">NSString</span> stringWithFormat:<span class="string">@&quot;detectorString : %@ ms\r\n&quot;</span>,detectorString]];</span><br><span class="line">    [costTimeInfo appendString:[<span class="built_in">NSString</span> stringWithFormat:<span class="string">@&quot;zbarSymbolString : %@ ms\r\n&quot;</span>,zbarSymbolString]]; </span><br><span class="line">    <span class="keyword">return</span> [costTimeInfo <span class="keyword">copy</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试数据如下所示:(取了前10张图片）</p>
<p><img src="https://upload-images.jianshu.io/upload_images/117999-04bca1bbc1f28805.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="识别二维码图片耗时.png"></p>
<p>分析测试数据发现：<br>1、在测试第一张二维码图片时，总耗时均较大，如果第一次识别使用的是系统方法，耗时超过500ms，这也是为什么会出现卡顿的原因；<br>2、使用系统方法去识别二维码图片时，如果不是第一次去识别，耗时较小，在65ms以内；<br>3、使用zbar的方法去识别二维码图片，耗时均值在200ms以内；<br>4、在方案C中，如果第一次使用系统方法，耗时为226ms。</p>
<p>总结得出，从优化卡顿问题的角度出发，使用方案C最优，同时发现，如果使用系统方法能识别出二维码图片，在初始化之后（也就是第二次使用），耗时最短。同时因为在实际的使用场景中，图片是一张一张识别的，识别过程有一个间隔时间，如果已经使用系统方法识别过二维码图片，那下次识别就能达到最优。所以使用方案C的话，最差情况均值在200ms左右，最好的情况和方案A中第二次使用系统方法耗时基本一致。综合考虑，使用方案C。</p>
<h4 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h4><p>在实际的项目开发过程中，设想的情况和实际情况会存在偏差，需要自己时刻使用性能调优工具，根据数据去进行优化，而不能想当然的认为某种方式是最优的。<br>源码和demo请点<a target="_blank" rel="noopener" href="https://github.com/leverTsui/QRCodeDemo.git">这里</a><br>参考的文章链接如下<br><a target="_blank" rel="noopener" href="http://adad184.com/2015/09/30/goodbye-zxing/">再见ZXing 使用系统原生代码处理QRCode</a><br><a target="_blank" rel="noopener" href="http://blog.cnbluebox.com/blog/2014/08/26/ioser-wei-ma-sao-miao/">IOS二维码扫描,你需要注意的两件事</a><br><a target="_blank" rel="noopener" href="http://blog.csdn.net/u013738531/article/details/54574262"><a target="_blank" rel="noopener" href="http://blog.csdn.net/u013738531/article/details/54574262">Zbar算法流程介绍</a></a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="leverTsui"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">leverTsui</p>
  <div class="site-description" itemprop="description">要有狮子的力量， 菩萨的心肠</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">8</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">leverTsui</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
